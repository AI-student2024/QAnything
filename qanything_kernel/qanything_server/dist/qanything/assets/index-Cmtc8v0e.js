import{d as Me,Z as dt,a as K,r as D,o as Re,y as r,J as d,B as i,c,D as s,S as k,L as O,R as B,C as m,G as w,H as Ne,x as M,b as Be,z as se,F as A,K as oe,A as T,E as pt,a0 as ne,N as R,O as N,T as J,a2 as ft,M as ge,X as vt,Y as ht}from"./index-CIHYuKsG.js";import{u as _t,a as mt,b as qe,D as gt,f as yt,h as kt,T as wt,_ as Ct,c as bt}from"./html2canvas.esm-Br5tYLsV.js";import{L as St,a as xt,_ as Tt,F as Dt,O as Ft}from"./OptionList-Dg_M-4dI.js";import{u as Oe,_ as Ie}from"./useChatSource-BP0jpd_h.js";import{g as Lt,u as Bt}from"./index-59iUwvJT.js";import{f as qt,p as It,r as P,u as H,a as $t,b as Ut,C as jt}from"./utils-C6G484sf.js";import{u as $e}from"./useQuickStart-DvRd4iNd.js";import{C as Mt,a as Rt}from"./ChatInfoPanel-BCCjPAx7.js";import{u as Nt,a as Ot,c as Ue,p as Kt}from"./useUploadFiles-bTvTmjKU.js";import{u as Et}from"./useChatSetting-CyRfVkMx.js";import{B as zt}from"./RightOutlined-DwINhmSg.js";import{_ as At}from"./ActionButton-fd0JwO-l.js";import{_ as Pt}from"./index-B1K_I5u9.js";import"./initDefaultProps-BJSFpWZz.js";import"./index-BXVkOQiS.js";import"./index-P_tofVSx.js";import"./slide-B8wvIwC8.js";import"./index-2GXc6WGi.js";import"./index-Bgj8_p-p.js";import"./class-DeKWk5pD.js";import"./index-DPkcQrQ3.js";import"./responsiveObserve-Biv3ur13.js";import"./index-d2m_OQvf.js";import"./collapseMotion--BIRIfJG.js";import"./injectionKey-DGYNie3Z.js";const Ht={class:"contain"},Vt={key:0,class:"loading"},Qt={key:1,class:"progress"},Jt={class:"file-name"},Wt={key:0,class:"file-extension"},Gt={key:1,class:"file-extension"},Xt=Me({__name:"FileBlock",props:{fileData:{},kbId:{},status:{}},emits:["deleteFile"],setup(E,{emit:y}){const{setChatSourceVisible:W,setSourceType:le,setSourceUrl:l,setTextContent:g}=Oe(),C=y,V=E,{fileData:u,kbId:G}=dt(V),X=K(()=>S.value==="gray"),q=K(()=>It(u.value.file_name)),ie=K(()=>S.value==="red"?"file-error":S.value==="green"?"file-"+ce.get(q.value.fileExtension):"file-unknown"),S=K(()=>u.value.status),ce=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]),re=new Map([["gray","上传中"],["yellow","解析中"],["green","解析成功"],["red","解析失败"]]),Q=D(0),ue=()=>{let _=D(null);_.value=setInterval(async()=>{var h,v,b;if(u.value.file_id===""&&u.value.status!=="loading"&&(u.value.status="red"),u.value.status==="green"||u.value.status==="red")clearInterval(_.value),_.value=null;else{const U=await P(await H.fileList({kb_id:G.value,file_id:u.value.file_id}));u.value.status=((h=U.details[0])==null?void 0:h.status)||"red",((v=U.details[0])==null?void 0:v.status)==="yellow"&&(Q.value=parseInt((b=U.details[0])==null?void 0:b.msg.match(/\d+/)[0],10))}},1e3)},Y=async()=>{C("deleteFile",u.value.file_id,G.value)};Re(()=>{ue()});const Z=()=>{S.value==="yellow"||S.value==="green"?pe(u.value):w.warn("解析中、解析完成才可以预览")};let p=["pdf","docx","xlsx","txt","md","jpg","png","jpeg"];const de=_=>{if(!_)return!1;const h=_.split(".");if(h.length){const v=h.pop();return p.includes(v)}else return!1},pe=_=>{de(_.file_name)&&fe(_)};async function fe(_){try{l(null);const h=await P(await H.getFile({file_id:_.file_id})),v=_.file_name.split(".").pop(),b=ee(v);if(le(v),l(`data:${b};base64,${h.file_base64}`),v==="txt"||v==="md"){const U=atob(h.file_base64),L=decodeURIComponent(escape(U));g(L),W(!0)}else W(!0)}catch(h){w.error(h.msg||"获取文件失败")}}let F=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/markdown","image/jpeg","image/png","image/jpeg"];function ee(_){const h=p.indexOf(_);return F[h]}return(_,h)=>{const v=xt;return r(),d("div",Ht,[i("div",{class:"file-icon",onClick:Z},[c(k,{name:s(ie)},null,8,["name"]),i("div",{class:O(s(X)||s(S)==="yellow"?"mask":"")},null,2),s(X)?(r(),d("div",Vt,[c(St)])):B("",!0),s(S)==="yellow"?(r(),d("div",Qt,[c(v,{type:"circle",percent:s(Q),size:25},null,8,["percent"])])):B("",!0)]),i("div",{class:"file-info",onClick:Z},[i("span",Jt,m(s(q).fileName),1),s(S)==="green"?(r(),d("span",Wt,m(s(q).fileExtension.toUpperCase())+", "+m(s(qt)(s(u).bytes)||0),1)):(r(),d("span",Gt,m(s(re).get(s(S))),1))]),_.status==="toBeSend"?(r(),d("div",{key:0,class:"file-close",onClick:Y},[c(k,{name:"close"})])):B("",!0)])}}}),je=Ne(Xt,[["__scopeId","data-v-9a48aea2"]]),Ke=E=>(vt("data-v-5e3cc537"),E=E(),ht(),E),Yt={class:"container"},Zt={key:1,class:"my-page"},ea={key:0,class:"user"},ta=Ke(()=>i("img",{class:"avatar",src:Ct,alt:"头像"},null,-1)),aa={class:"question-inner"},sa={class:"question-text"},oa={key:0,class:"file-list-box"},na={key:1,class:"ai"},la=Ke(()=>i("img",{class:"avatar",src:bt,alt:"头像"},null,-1)),ia={class:"ai-content"},ca={class:"ai-right"},ra={key:0},ua={key:1},da={class:"source-list"},pa={class:"control"},fa={class:"tips"},va=["href"],ha=["onClick"],_a={class:"source-content"},ma={class:"score"},ga={class:"tips"},ya={key:1,class:"feed-back"},ka=["onClick"],wa={class:"reload-text"},Ca={class:"tools"},ba={key:0,class:"stop-btn"},Sa={class:"question-box"},xa={class:"question"},Ta={key:0,class:"file-list-box"},Da={class:"send-box"},Fa={class:"send-action"},La=Me({__name:"index",setup(E){const{common:y,home:W}=Lt(),{copy:le}=_t(),{QA_List:l,chatId:g,kbId:C,kbIdCopy:V,showLoading:u}=M($e()),{addHistoryList:G,updateHistoryList:X,addChatList:q,clearChatList:ie,getHistoryById:S,renameHistory:ce,addFileToBeSendList:re}=$e(),{setChatSourceVisible:Q,setSourceType:ue,setSourceUrl:Y,setTextContent:Z}=Oe(),{chatSettingFormActive:p}=M(Et()),{showDefault:de}=M(Nt()),{setModalVisible:pe,setModalTitle:fe}=Ot(),{uploadFileListQuick:F}=M(Ue()),{initUploadFileListQuick:ee}=Ue(),{language:_}=M(Bt()),h=K(()=>S(g.value)),v=new wt(e=>{e&&(l.value[l.value.length-1].answer+=e||"")}),b=D(""),U=K(()=>{const e=p.value.context;if(e===0)return[];const o=l.value.filter(a=>a.type==="ai");return(e===1?o:o.slice(-e)).map(a=>[a.question,a.answer])}),L=D([]);let I;const Ee=D(null),ye=D(null),j=()=>{ne(()=>{var e;(e=ye.value)==null||e.scrollIntoView({behavior:"smooth",block:"end"})})},ve=K(()=>{var o;return(((o=h.value)==null?void 0:o.fileToBeSendList.concat(F==null?void 0:F.value))||[]).filter(t=>t.file_id.length!==0)});Re(()=>{V.value&&(C.value=V.value),j()}),Be(()=>{ke()});const ke=()=>{F.value.length&&(re(g.value,[...F.value]),ee())};window.addEventListener("beforeunload",ke);const ze=e=>{e.keyCode===13&&(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey?b.value+=`
`:he(),e.preventDefault())},Ae=mt((e,o)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){o.target.parentNode.style.animation="shake ease-in .5s";const t=setTimeout(()=>{clearTimeout(t),o.target.parentNode.style.animation=""},600)}},800),Pe=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},He=e=>{le(e.answer).then(()=>{e.copied=!e.copied,w.success(y.copySuccess,1);const o=setTimeout(()=>{clearTimeout(o),e.copied=!e.copied},1e3)}).catch(()=>{w.error(y.copyFailed,1)})},Ve=async(e,o)=>{console.log(e);try{await P(await H.deleteFile({file_ids:[e],kb_id:o})),w.success("删除成功");const t=F.value.findIndex(a=>a.file_id===e);t!==-1?F.value.splice(t,1):h.value.fileToBeSendList=h.value.fileToBeSendList.filter(a=>a.file_id!==e)}catch(t){w.error(t.msg||"删除失败")}},Qe=e=>{l.value.push({question:e,type:"user",fileDataList:[...ve.value.filter(o=>o.status!=="red")]}),j()},we=e=>{l.value.push({answer:"",question:e,onlySearch:p.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},z=new jt,Je=()=>{I&&I.abort(),v.done(),u.value=!1,l.value[l.value.length-1].showTools=!0},We=async e=>{try{if(g.value!==null){S(g.value).title==="未命名对话"&&ce(g.value,e);return}e.length>100&&(e=e.substring(0,100));const o=await P(await H.createKb({kb_name:e}));C.value=o.kb_id,g.value=G(e),X(e,g.value,C.value)}catch(o){w.error(o.msg||"创建对话失败")}},he=async()=>{if(!b.value.trim().length)return;if(u.value){w.warn("正在聊天中...请等待结束");return}if(!await lt()){w.error("模型设置错误，请先检查模型配置");return}const e=b.value;await We(e),b.value="",Qe(e),q(g.value,l.value),ee(),h.value.fileToBeSendList=[],u.value=!0,I=new AbortController;const o={kb_ids:[C.value],history:U.value,question:e,streaming:p.value.capabilities.onlySearch===!1,networking:p.value.capabilities.networkSearch,product_source:"saas",rerank:p.value.capabilities.rerank,only_need_search_results:p.value.capabilities.onlySearch,hybrid_search:p.value.capabilities.mixedSearch,max_token:p.value.maxToken,api_base:p.value.apiBase,api_key:p.value.apiKey,model:p.value.apiModelName,api_context_length:p.value.apiContextLength,chunk_size:p.value.chunkSize,top_p:p.value.top_P,top_k:p.value.top_K,temperature:p.value.temperature};if(p.value.capabilities.onlySearch){z.addChatSetting(p.value),we(e);try{const t=await P(await H.sendQuestion(o));t.code===200&&(l.value[l.value.length-1].answer=t!=null&&t.source_documents.length?y.searchCompleted:y.searchNotFound,l.value[l.value.length-1].source=t==null?void 0:t.source_documents)}catch(t){w.error(t.msg||"出错了"),l.value[l.value.length-1].answer=t||"error"}u.value=!1,l.value[l.value.length-1].showTools=!0,q(g.value,l.value),await ne(()=>{j()})}else yt(Ut+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:$t,...o}),signal:I.signal,onopen(t){console.log("open",t),we(e),t.ok&&t.headers.get("content-type")==="text/event-stream"?(z.addChatSetting(p.value),v.start()):t.headers.get("content-type")==="application/json"&&v.add("Error 请检查模型是否配置正确")},onmessage(t){var $,n;console.log("message",t);const a=JSON.parse(t.data);if((a==null?void 0:a.code)==200&&(a!=null&&a.response)&&a.msg==="success")v.add(a==null?void 0:a.response),j();else{const x=a.time_record.time_usage;delete x.retriever_search_by_milvus,z.addTime(a.time_record.time_usage),z.addToken(a.time_record.token_usage),z.addDate(Date.now())}($=a==null?void 0:a.source_documents)!=null&&$.length&&(l.value[l.value.length-1].source=a==null?void 0:a.source_documents),(n=a==null?void 0:a.show_images)!=null&&n.length&&(a==null||a.show_images.map(x=>{v.add(x),console.log(l.value.at(-1).answer)}))},onclose(t){console.log("close",t),v.done(),I.abort(),u.value=!1,l.value[l.value.length-1].showTools=!0,l.value.at(-1).itemInfo=z.getChatInfo(),q(g.value,l.value),ne(()=>{j()}),console.log(l.value)},onerror(t){throw console.log("error",t),v==null||v.done(),I==null||I.abort(),u.value=!1,l.value[l.value.length-1].showTools=!0,w.error(t.msg||"出错了"),q(g.value,l.value),ne(()=>{j()}),t}})},Ge=e=>{b.value=e.question,he()},Xe=(e,o)=>{e.source[o].showDetailDataSource=!e.source[o].showDetailDataSource},Ye=(e,o)=>{e.source[o].showDetailDataSource=!1},Ze=e=>{L.value.push(e)},et=e=>{L.value=L.value.filter(o=>o!==e)},{showModal:Ce}=M(qe()),_e=D(!1),me=D(""),te=D(""),tt=()=>{u.value||C.value&&(pe(!0),fe(W.upload))},at=()=>{u.value||(te.value="download",Ce.value=!0,me.value=y.saveTip)},st=async()=>{if(_e.value=!0,te.value==="download")try{const e=document.getElementById("chat-ul"),t=(await kt(e,{useCORS:!0})).toDataURL("image/png"),a=document.createElement("a");a.style.display="none",a.href=t,a.setAttribute("download","chat-shot.png"),typeof a.download>"u"&&a.setAttribute("target","_blank"),document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(t),w.success("下载成功"),await Promise.resolve()}catch(e){w.error(e.message||e.msg||"出错了")}else te.value==="delete"&&(ie(g.value),g.value=null,l.value=[]);te.value="",me.value="",_e.value=!1,Ce.value=!1},{showSettingModal:ot}=M(qe()),nt=e=>{ot.value=e},be=D(),lt=()=>be.value.handleOk();let Se=["pdf","docx","xlsx","txt","md","jpg","png","jpeg","csv","eml"];const xe=e=>{if(!e)return!1;const o=e.split(".");if(o.length){const t=o.pop();return Se.includes(t)}else return!1},it=e=>{xe(e.file_name)&&ct(e)};async function ct(e){try{Y(null);const o=await P(await H.getFile({file_id:e.file_id})),t=e.file_name.split(".").pop(),a=ut(t);if(ue(t),Y(`data:${a};base64,${o.file_base64}`),t==="txt"||t==="md"||t==="csv"||t==="eml"){const $=atob(o.file_base64),n=decodeURIComponent(escape($));Z(n),Q(!0)}else Q(!0)}catch(o){w.error(o.msg||"获取文件失败")}}let rt=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/markdown","image/jpeg","image/png","image/jpeg","text/csv","message/rfc822","application/vnd.openxmlformats-officedocument.presentationml.presentation"];function ut(e){const o=Se.indexOf(e);return rt[o]}Be(()=>{Te()});const Te=()=>{V.value=C.value,C.value=""};return window.addEventListener("onbeforeunload",Te),(e,o)=>{const t=zt,a=At,$=Pt;return r(),d(A,null,[i("div",Yt,[s(de)===s(Kt).optionlist?(r(),se(Ft,{key:0})):(r(),d("div",Zt,[i("div",{id:"chat",ref_key:"chatContainer",ref:Ee,class:"chat"},[i("ul",{id:"chat-ul",ref_key:"scrollDom",ref:ye},[(r(!0),d(A,null,oe(s(l),(n,x)=>{var De,Fe;return r(),d("li",{key:x},[n.type==="user"?(r(),d("div",ea,[ta,i("div",aa,[i("p",sa,m(n.question),1),n.fileDataList.length?(r(),d("div",oa,[(r(!0),d(A,null,oe(n.fileDataList,f=>(r(),se(je,{key:f.file.lastModified,"file-data":f,"kb-id":s(C),"chat-id":s(g),status:"send"},null,8,["file-data","kb-id","chat-id"]))),128))])):B("",!0)])])):(r(),d("div",na,[la,i("div",ia,[i("div",ca,[i("p",{class:O(["question-text",[!n.source.length&&!((De=n==null?void 0:n.picList)!=null&&De.length)?"change-radius":"",n.showTools?"":"flashing"]])},[c(Ie,{content:n.answer},null,8,["content"]),Object.keys(((Fe=n==null?void 0:n.itemInfo)==null?void 0:Fe.tokenInfo)||{}).length?(r(),se(Mt,{key:0,"chat-item-info":n.itemInfo},null,8,["chat-item-info"])):B("",!0)],2),n.source.length?(r(),d(A,{key:0},[i("div",{class:O(["source-total",s(L).includes(x)?"":"source-total-last"])},[s(_)==="zh"?(r(),d("span",ra," 找到了"+m(n.source.length)+"个信息来源： ",1)):(r(),d("span",ua," Found "+m(n.source.length)+" source of information ",1)),R(c(k,{name:"down",onClick:f=>Ze(x)},null,8,["onClick"]),[[N,!s(L).includes(x)]]),R(c(k,{name:"up",onClick:f=>et(x)},null,8,["onClick"]),[[N,s(L).includes(x)]])],2),R(i("div",da,[(r(!0),d(A,null,oe(n.source,(f,ae)=>(r(),d("div",{key:ae,class:"data-source"},[R(i("p",pa,[i("span",fa,m(s(y).dataSource)+m(ae+1)+":",1),f.file_url.startsWith("http")?(r(),d("a",{key:0,href:f.file_url,target:"_blank"},m(f.file_name),9,va)):(r(),d("span",{key:1,class:O(["file",xe(f.file_name)?"filename-active":""]),onClick:Le=>it(f)},m(f.file_name),11,ha)),R(c(k,{name:"iconup",onClick:Le=>Ye(n,ae)},null,8,["onClick"]),[[N,f.showDetailDataSource]]),R(c(k,{name:"icondown",onClick:Le=>Xe(n,ae)},null,8,["onClick"]),[[N,!f.showDetailDataSource]])],512),[[N,f.file_name]]),c(ft,{name:"sourceItem"},{default:T(()=>[R(i("div",_a,[c(Ie,{content:f.content},null,8,["content"]),i("p",ma,[i("span",ga,m(s(y).correlation),1),J(" "+m(f.score),1)])],512),[[N,f.showDetailDataSource]])]),_:2},1024)]))),128))],512),[[N,s(L).includes(x)]])],64)):B("",!0),n.showTools?(r(),d("div",ya,[i("div",{class:"reload-box",onClick:f=>Ge(n)},[c(k,{name:"reload"}),i("span",wa,m(s(y).regenerate),1)],8,ka),i("div",Ca,[c(k,{style:ge({color:n.copied?"#4D71FF":""}),name:"copy",onClick:f=>He(n)},null,8,["style","onClick"]),c(k,{style:ge({color:n.like?"#4D71FF":""}),name:"like",onClick:f=>s(Ae)(n,f)},null,8,["style","onClick"]),c(k,{style:ge({color:n.unlike?"#4D71FF":""}),name:"unlike",onClick:f=>Pe(n)},null,8,["style","onClick"])])])):B("",!0)])])]))])}),128))],512)],512),s(u)?(r(),d("div",ba,[c(t,{onClick:Je},{icon:T(()=>[c(k,{name:"stop",class:O(s(u)?"loading":"")},null,8,["class"])]),default:T(()=>[J(" "+m(s(y).stop),1)]),_:1})])):B("",!0),i("div",Sa,[i("div",xa,[s(ve).length?(r(),d("div",Ta,[(r(!0),d(A,null,oe(s(ve),n=>(r(),se(je,{key:n.file_id,"file-data":n,"kb-id":s(C),"chat-id":s(g),status:"toBeSend",onDeleteFile:Ve},null,8,["file-data","kb-id","chat-id"]))),128))])):B("",!0),i("div",Da,[c(a,{value:s(b),"onUpdate:value":o[0]||(o[0]=n=>pt(b)?b.value=n:null),class:"send-textarea","max-length":"200",bordered:!1,placeholder:s(y).problemPlaceholder,"auto-size":{minRows:1,maxRows:8},onKeydown:ze},null,8,["value","placeholder"]),i("div",Fa,[c($,null,{content:T(()=>[J(m(s(C)?s(y).chatUpload:s(y).chatUploadNoKbId),1)]),default:T(()=>[i("span",{class:O(["question-icon",s(u)||!s(C)?"isPreventClick":""]),onClick:tt},[c(k,{name:"chat-upload"})],2)]),_:1}),c($,null,{content:T(()=>[J(m(s(y).chatToPic),1)]),default:T(()=>[i("span",{class:O(["question-icon",s(u)?"isPreventClick":""]),onClick:at},[c(k,{name:"chat-download"})],2)]),_:1}),c($,null,{content:T(()=>[J(m(s(y).modelSettingTitle),1)]),default:T(()=>[i("span",{class:"question-icon",onClick:o[1]||(o[1]=n=>nt(!0))},[c(k,{name:"chat-setting"})])]),_:1}),c(t,{type:"primary",disabled:s(u),shape:"circle",onClick:he},{default:T(()=>[c(k,{name:"sendplane"})]),_:1},8,["disabled"])])])])]),c(Dt,{"dialog-type":1})])),i("div",{class:"scroll-btn-div"},[i("img",{class:"avatar",src:Tt,alt:"滑到底部",onClick:j})])]),c(Rt,{ref_key:"chatSettingForDialogRef",ref:be},null,512),c(gt,{content:s(me),"confirm-loading":s(_e),onOk:st},null,8,["content","confirm-loading"])],64)}}}),ts=Ne(La,[["__scopeId","data-v-5e3cc537"]]);export{ts as default};
