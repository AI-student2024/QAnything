import{d as Me,a0 as dt,a as K,r as T,o as Re,A as r,B as d,C as l,c,G as a,V as k,E as O,W as L,H as m,Q as w,M as Ne,z as M,b as Be,N as se,F as A,D as oe,J as x,O as pt,a2 as ne,S as R,T as N,X as J,a4 as ft,R as ge,K as vt,L as ht}from"./index-DQhd_TIw.js";import{u as Oe,b as _t,_ as mt,c as qe,a as gt}from"./useChatSource-CfFYoHXU.js";import{u as yt,a as kt,b as Ie,D as wt,f as bt,h as Ct,T as St,_ as xt}from"./html2canvas.esm-DioTSK5g.js";import{L as Tt,a as Dt,_ as Ft,C as Lt,F as Bt,O as qt}from"./OptionList-CwWHxPu4.js";import{g as It,u as $t}from"./index-31PKrJ_u.js";import{f as Ut,p as jt,r as P,u as V,a as Mt,b as Rt,C as Nt}from"./utils-MGXOhPxW.js";import{u as $e}from"./useQuickStart-fPd7sPSi.js";import{u as Ot,a as Kt,c as Ue,p as zt}from"./useUploadFiles-m3JcBPe0.js";import{u as Et}from"./useChatSetting-CKwg7HyE.js";import{C as At}from"./ChatInfoPanel--WJK3Bce.js";import{B as Pt}from"./RightOutlined-Bfs4yZoH.js";import"./index-DopHx9_9.js";import"./collapseMotion-C4mIIGhj.js";import"./index-CQPBMv6t.js";import"./index-BDfljTVS.js";import"./injectionKey-DGYNie3Z.js";import"./slide-DSnuqgtt.js";const Vt={class:"contain"},Ht={key:0,class:"loading"},Qt={key:1,class:"progress"},Jt={class:"file-name"},Wt={key:0,class:"file-extension"},Gt={key:1,class:"file-extension"},Xt=Me({__name:"FileBlock",props:{fileData:{},kbId:{},status:{}},emits:["deleteFile"],setup(z,{emit:y}){const{setChatSourceVisible:W,setSourceType:le,setSourceUrl:i,setTextContent:g}=Oe(),b=y,H=z,{fileData:u,kbId:G}=dt(H),X=K(()=>S.value==="gray"),B=K(()=>jt(u.value.file_name)),ie=K(()=>S.value==="red"?"file-error":S.value==="green"?"file-"+ce.get(B.value.fileExtension):"file-unknown"),S=K(()=>u.value.status),ce=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]),re=new Map([["gray","上传中"],["yellow","解析中"],["green","解析成功"],["red","解析失败"]]),Q=T(0),ue=()=>{let _=T(null);_.value=setInterval(async()=>{var v,h,C;if(u.value.file_id===""&&u.value.status!=="loading"&&(u.value.status="red"),u.value.status==="green"||u.value.status==="red")clearInterval(_.value),_.value=null;else{const $=await P(await V.fileList({kb_id:G.value,file_id:u.value.file_id}));u.value.status=((v=$.details[0])==null?void 0:v.status)||"red",((h=$.details[0])==null?void 0:h.status)==="yellow"&&(Q.value=parseInt((C=$.details[0])==null?void 0:C.msg.match(/\d+/)[0],10))}},1e3)},Y=async()=>{b("deleteFile",u.value.file_id,G.value)};Re(()=>{ue()});const Z=()=>{S.value==="yellow"||S.value==="green"?pe(u.value):w.warn("解析中、解析完成才可以预览")};let f=["pdf","docx","xlsx","txt","md","jpg","png","jpeg"];const de=_=>{if(!_)return!1;const v=_.split(".");if(v.length){const h=v.pop();return f.includes(h)}else return!1},pe=_=>{de(_.file_name)&&fe(_)};async function fe(_){try{i(null);const v=await P(await V.getFile({file_id:_.file_id})),h=_.file_name.split(".").pop(),C=ee(h);if(le(h),i(`data:${C};base64,${v.file_base64}`),h==="txt"||h==="md"){const $=atob(v.file_base64),F=decodeURIComponent(escape($));g(F),W(!0)}else W(!0)}catch(v){w.error(v.msg||"获取文件失败")}}let D=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/markdown","image/jpeg","image/png","image/jpeg"];function ee(_){const v=f.indexOf(_);return D[v]}return(_,v)=>{const h=Dt;return r(),d("div",Vt,[l("div",{class:"file-icon",onClick:Z},[c(k,{name:a(ie)},null,8,["name"]),l("div",{class:O(a(X)||a(S)==="yellow"?"mask":"")},null,2),a(X)?(r(),d("div",Ht,[c(Tt)])):L("",!0),a(S)==="yellow"?(r(),d("div",Qt,[c(h,{type:"circle",percent:a(Q),size:25},null,8,["percent"])])):L("",!0)]),l("div",{class:"file-info",onClick:Z},[l("span",Jt,m(a(B).fileName),1),a(S)==="green"?(r(),d("span",Wt,m(a(B).fileExtension.toUpperCase())+", "+m(a(Ut)(a(u).bytes)||0),1)):(r(),d("span",Gt,m(a(re).get(a(S))),1))]),_.status==="toBeSend"?(r(),d("div",{key:0,class:"file-close",onClick:Y},[c(k,{name:"close"})])):L("",!0)])}}}),je=Ne(Xt,[["__scopeId","data-v-1f8682ed"]]),Ke=z=>(vt("data-v-0a066be1"),z=z(),ht(),z),Yt={class:"container"},Zt={key:1,class:"my-page"},ea={key:0,class:"user"},ta=Ke(()=>l("img",{class:"avatar",src:gt,alt:"头像"},null,-1)),aa={class:"question-inner"},sa={class:"question-text"},oa={key:0,class:"file-list-box"},na={key:1,class:"ai"},la=Ke(()=>l("img",{class:"avatar",src:xt,alt:"头像"},null,-1)),ia={class:"ai-content"},ca={class:"ai-right"},ra={key:0},ua={key:1},da={class:"source-list"},pa={class:"control"},fa={class:"tips"},va=["href"],ha=["onClick"],_a={class:"source-content"},ma={class:"score"},ga={class:"tips"},ya={key:1,class:"feed-back"},ka=["onClick"],wa={class:"reload-text"},ba={class:"tools"},Ca={key:0,class:"stop-btn"},Sa={class:"question-box"},xa={class:"question"},Ta={key:0,class:"file-list-box"},Da={class:"send-box"},Fa={class:"send-action"},La=Me({__name:"index",setup(z){const{common:y,home:W}=It(),{copy:le}=yt(),{QA_List:i,chatId:g,kbId:b,kbIdCopy:H,showLoading:u}=M($e()),{addHistoryList:G,updateHistoryList:X,addChatList:B,clearChatList:ie,getHistoryById:S,renameHistory:ce,addFileToBeSendList:re}=$e(),{setChatSourceVisible:Q,setSourceType:ue,setSourceUrl:Y,setTextContent:Z}=Oe(),{chatSettingFormActive:f}=M(Et()),{showDefault:de}=M(Ot()),{setModalVisible:pe,setModalTitle:fe}=Kt(),{uploadFileListQuick:D}=M(Ue()),{initUploadFileListQuick:ee}=Ue(),{language:_}=M($t()),v=K(()=>S(g.value)),h=new St(e=>{e&&(i.value[i.value.length-1].answer+=e||"")}),C=T(""),$=K(()=>{const e=f.value.context;if(e===0)return[];const s=i.value.filter(o=>o.type==="ai");return(e===1?s:s.slice(-e)).map(o=>[o.question,o.answer])}),F=T([]);let q;const ze=T(null),ye=T(null),U=()=>{ne(()=>{var e;(e=ye.value)==null||e.scrollIntoView({behavior:"smooth",block:"end"})})},ve=K(()=>{var s;return(((s=v.value)==null?void 0:s.fileToBeSendList.concat(D==null?void 0:D.value))||[]).filter(t=>t.file_id.length!==0)});Re(()=>{H.value&&(b.value=H.value),U()}),Be(()=>{ke()});const ke=()=>{D.value.length&&(re(g.value,[...D.value]),ee())};window.addEventListener("beforeunload",ke);const Ee=e=>{e.keyCode===13&&(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey?C.value+=`
`:he(),e.preventDefault())},Ae=kt((e,s)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){s.target.parentNode.style.animation="shake ease-in .5s";const t=setTimeout(()=>{clearTimeout(t),s.target.parentNode.style.animation=""},600)}},800),Pe=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},Ve=e=>{le(e.answer).then(()=>{e.copied=!e.copied,w.success(y.copySuccess,1);const s=setTimeout(()=>{clearTimeout(s),e.copied=!e.copied},1e3)}).catch(()=>{w.error(y.copyFailed,1)})},He=async(e,s)=>{console.log(e);try{await P(await V.deleteFile({file_ids:[e],kb_id:s})),w.success("删除成功");const t=D.value.findIndex(o=>o.file_id===e);t!==-1?D.value.splice(t,1):v.value.fileToBeSendList=v.value.fileToBeSendList.filter(o=>o.file_id!==e)}catch(t){w.error(t.msg||"删除失败")}},Qe=e=>{i.value.push({question:e,type:"user",fileDataList:[...ve.value.filter(s=>s.status!=="red")]}),U()},we=e=>{i.value.push({answer:"",question:e,onlySearch:f.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},E=new Nt,Je=()=>{q&&q.abort(),h.done(),u.value=!1,i.value[i.value.length-1].showTools=!0},We=async e=>{try{if(g.value!==null){S(g.value).title==="未命名对话"&&ce(g.value,e);return}e.length>100&&(e=e.substring(0,100));const s=await P(await V.createKb({kb_name:e}));b.value=s.kb_id,g.value=G(e),X(e,g.value,b.value)}catch(s){w.error(s.msg||"创建对话失败")}},he=async()=>{if(!C.value.trim().length)return;if(u.value){w.warn("正在聊天中...请等待结束");return}if(!await lt()){w.error("模型设置错误，请先检查模型配置");return}const e=C.value;await We(e),C.value="",Qe(e),B(g.value,i.value),ee(),v.value.fileToBeSendList=[],u.value=!0,q=new AbortController;const s={kb_ids:[b.value],history:$.value,question:e,streaming:f.value.capabilities.onlySearch===!1,networking:f.value.capabilities.networkSearch,product_source:"saas",rerank:f.value.capabilities.rerank,only_need_search_results:f.value.capabilities.onlySearch,hybrid_search:f.value.capabilities.mixedSearch,max_token:f.value.maxToken,api_base:f.value.apiBase,api_key:f.value.apiKey,model:f.value.apiModelName,api_context_length:f.value.apiContextLength,chunk_size:f.value.chunkSize,top_p:f.value.top_P,temperature:f.value.temperature};if(f.value.capabilities.onlySearch){E.addChatSetting(f.value),we(e);try{const t=await P(await V.sendQuestion(s));t.code===200&&(i.value[i.value.length-1].answer=t!=null&&t.source_documents.length?y.searchCompleted:y.searchNotFound,i.value[i.value.length-1].source=t==null?void 0:t.source_documents)}catch(t){w.error(t.msg||"出错了"),i.value[i.value.length-1].answer=t||"error"}u.value=!1,i.value[i.value.length-1].showTools=!0,B(g.value,i.value),await ne(()=>{U()})}else bt(Rt+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:Mt,...s}),signal:q.signal,onopen(t){console.log("open",t),E.addChatSetting(f.value),we(e),t.ok&&t.headers.get("content-type")==="text/event-stream"&&h.start()},onmessage(t){var I;console.log("message",t);const o=JSON.parse(t.data);if((o==null?void 0:o.code)==200&&(o!=null&&o.response)&&o.msg==="success")h.add(o==null?void 0:o.response),U();else{const n=o.time_record.time_usage;delete n.retriever_search_by_milvus,E.addTime(o.time_record.time_usage),E.addToken(o.time_record.token_usage),E.addDate(Date.now())}(I=o==null?void 0:o.source_documents)!=null&&I.length&&(i.value[i.value.length-1].source=o==null?void 0:o.source_documents)},onclose(t){console.log("close",t),h.done(),q.abort(),u.value=!1,i.value[i.value.length-1].showTools=!0,i.value.at(-1).itemInfo=E.getChatInfo(),B(g.value,i.value),ne(()=>{U()}),console.log(i.value)},onerror(t){throw console.log("error",t),h==null||h.done(),q==null||q.abort(),u.value=!1,i.value[i.value.length-1].showTools=!0,w.error(t.msg||"出错了"),B(g.value,i.value),ne(()=>{U()}),t}})},Ge=e=>{C.value=e.question,he()},Xe=(e,s)=>{e.source[s].showDetailDataSource=!e.source[s].showDetailDataSource},Ye=(e,s)=>{e.source[s].showDetailDataSource=!1},Ze=e=>{F.value.push(e)},et=e=>{F.value=F.value.filter(s=>s!==e)},{showModal:be}=M(Ie()),_e=T(!1),me=T(""),te=T(""),tt=()=>{b.value&&(pe(!0),fe(W.upload))},at=()=>{u.value||(te.value="download",be.value=!0,me.value=y.saveTip)},st=async()=>{if(_e.value=!0,te.value==="download")try{const e=document.getElementById("chat-ul"),t=(await Ct(e,{useCORS:!0})).toDataURL("image/png"),o=document.createElement("a");o.style.display="none",o.href=t,o.setAttribute("download","chat-shot.png"),typeof o.download>"u"&&o.setAttribute("target","_blank"),document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(t),w.success("下载成功"),await Promise.resolve()}catch(e){w.error(e.message||e.msg||"出错了")}else te.value==="delete"&&(ie(g.value),g.value=null,i.value=[]);te.value="",me.value="",_e.value=!1,be.value=!1},{showSettingModal:ot}=M(Ie()),nt=e=>{ot.value=e},Ce=T(),lt=()=>Ce.value.handleOk();let Se=["pdf","docx","xlsx","txt","md","jpg","png","jpeg","csv","eml"];const xe=e=>{if(!e)return!1;const s=e.split(".");if(s.length){const t=s.pop();return Se.includes(t)}else return!1},it=e=>{xe(e.file_name)&&ct(e)};async function ct(e){try{Y(null);const s=await P(await V.getFile({file_id:e.file_id})),t=e.file_name.split(".").pop(),o=ut(t);if(ue(t),Y(`data:${o};base64,${s.file_base64}`),t==="txt"||t==="md"||t==="csv"||t==="eml"){const I=atob(s.file_base64),n=decodeURIComponent(escape(I));Z(n),Q(!0)}else Q(!0)}catch(s){w.error(s.msg||"获取文件失败")}}let rt=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/markdown","image/jpeg","image/png","image/jpeg","text/csv","message/rfc822","application/vnd.openxmlformats-officedocument.presentationml.presentation"];function ut(e){const s=Se.indexOf(e);return rt[s]}Be(()=>{Te()});const Te=()=>{H.value=b.value,b.value=""};return window.addEventListener("onbeforeunload",Te),(e,s)=>{const t=Pt,o=_t,I=mt;return r(),d(A,null,[l("div",Yt,[a(de)===a(zt).optionlist?(r(),se(qt,{key:0})):(r(),d("div",Zt,[l("div",{id:"chat",ref_key:"chatContainer",ref:ze,class:"chat"},[l("ul",{id:"chat-ul",ref_key:"scrollDom",ref:ye},[(r(!0),d(A,null,oe(a(i),(n,j)=>{var De,Fe;return r(),d("li",{key:j},[n.type==="user"?(r(),d("div",ea,[ta,l("div",aa,[l("p",sa,m(n.question),1),n.fileDataList.length?(r(),d("div",oa,[(r(!0),d(A,null,oe(n.fileDataList,p=>(r(),se(je,{key:p.file.lastModified,"file-data":p,"kb-id":a(b),"chat-id":a(g),status:"send"},null,8,["file-data","kb-id","chat-id"]))),128))])):L("",!0)])])):(r(),d("div",na,[la,l("div",ia,[l("div",ca,[l("p",{class:O(["question-text",[!n.source.length&&!((De=n==null?void 0:n.picList)!=null&&De.length)?"change-radius":"",n.showTools?"":"flashing"]])},[c(qe,{content:n.answer},null,8,["content"]),Object.keys(((Fe=n==null?void 0:n.itemInfo)==null?void 0:Fe.tokenInfo)||{}).length?(r(),se(At,{key:0,"chat-item-info":n.itemInfo},null,8,["chat-item-info"])):L("",!0)],2),n.source.length?(r(),d(A,{key:0},[l("div",{class:O(["source-total",a(F).includes(j)?"":"source-total-last"])},[a(_)==="zh"?(r(),d("span",ra," 找到了"+m(n.source.length)+"个信息来源： ",1)):(r(),d("span",ua," Found "+m(n.source.length)+" source of information ",1)),R(c(k,{name:"down",onClick:p=>Ze(j)},null,8,["onClick"]),[[N,!a(F).includes(j)]]),R(c(k,{name:"up",onClick:p=>et(j)},null,8,["onClick"]),[[N,a(F).includes(j)]])],2),R(l("div",da,[(r(!0),d(A,null,oe(n.source,(p,ae)=>(r(),d("div",{key:ae,class:"data-source"},[R(l("p",pa,[l("span",fa,m(a(y).dataSource)+m(ae+1)+":",1),p.file_url.startsWith("http")?(r(),d("a",{key:0,href:p.file_url,target:"_blank"},m(p.file_name),9,va)):(r(),d("span",{key:1,class:O(["file",xe(p.file_name)?"filename-active":""]),onClick:Le=>it(p)},m(p.file_name),11,ha)),R(c(k,{name:"iconup",onClick:Le=>Ye(n,ae)},null,8,["onClick"]),[[N,p.showDetailDataSource]]),R(c(k,{name:"icondown",onClick:Le=>Xe(n,ae)},null,8,["onClick"]),[[N,!p.showDetailDataSource]])],512),[[N,p.file_name]]),c(ft,{name:"sourceItem"},{default:x(()=>[R(l("div",_a,[c(qe,{content:p.content},null,8,["content"]),l("p",ma,[l("span",ga,m(a(y).correlation),1),J(" "+m(p.score),1)])],512),[[N,p.showDetailDataSource]])]),_:2},1024)]))),128))],512),[[N,a(F).includes(j)]])],64)):L("",!0),n.showTools?(r(),d("div",ya,[l("div",{class:"reload-box",onClick:p=>Ge(n)},[c(k,{name:"reload"}),l("span",wa,m(a(y).regenerate),1)],8,ka),l("div",ba,[c(k,{style:ge({color:n.copied?"#4D71FF":""}),name:"copy",onClick:p=>Ve(n)},null,8,["style","onClick"]),c(k,{style:ge({color:n.like?"#4D71FF":""}),name:"like",onClick:p=>a(Ae)(n,p)},null,8,["style","onClick"]),c(k,{style:ge({color:n.unlike?"#4D71FF":""}),name:"unlike",onClick:p=>Pe(n)},null,8,["style","onClick"])])])):L("",!0)])])]))])}),128))],512)],512),a(u)?(r(),d("div",Ca,[c(t,{onClick:Je},{icon:x(()=>[c(k,{name:"stop",class:O(a(u)?"loading":"")},null,8,["class"])]),default:x(()=>[J(" "+m(a(y).stop),1)]),_:1})])):L("",!0),l("div",Sa,[l("div",xa,[a(ve).length?(r(),d("div",Ta,[(r(!0),d(A,null,oe(a(ve),n=>(r(),se(je,{key:n.file_id,"file-data":n,"kb-id":a(b),"chat-id":a(g),status:"toBeSend",onDeleteFile:He},null,8,["file-data","kb-id","chat-id"]))),128))])):L("",!0),l("div",Da,[c(o,{value:a(C),"onUpdate:value":s[0]||(s[0]=n=>pt(C)?C.value=n:null),class:"send-textarea","max-length":"200",bordered:!1,placeholder:a(y).problemPlaceholder,"auto-size":{minRows:1,maxRows:8},onKeydown:Ee},null,8,["value","placeholder"]),l("div",Fa,[c(I,null,{content:x(()=>[J(m(a(b)?a(y).chatUpload:a(y).chatUploadNoKbId),1)]),default:x(()=>[l("span",{class:O(["question-icon",a(u)||!a(b)?"isPreventClick":""]),onClick:tt},[c(k,{name:"chat-upload"})],2)]),_:1}),c(I,null,{content:x(()=>[J(m(a(y).chatToPic),1)]),default:x(()=>[l("span",{class:O(["question-icon",a(u)?"isPreventClick":""]),onClick:at},[c(k,{name:"chat-download"})],2)]),_:1}),c(I,null,{content:x(()=>[J(m(a(y).modelSettingTitle),1)]),default:x(()=>[l("span",{class:"question-icon",onClick:s[1]||(s[1]=n=>nt(!0))},[c(k,{name:"chat-setting"})])]),_:1}),c(t,{type:"primary",disabled:a(u),shape:"circle",onClick:he},{default:x(()=>[c(k,{name:"sendplane"})]),_:1},8,["disabled"])])])])])])),l("div",{class:"scroll-btn-div"},[l("img",{class:"avatar",src:Ft,alt:"滑到底部",onClick:U})])]),c(Lt,{ref_key:"chatSettingForDialogRef",ref:Ce},null,512),c(wt,{content:a(me),"confirm-loading":a(_e),onOk:st},null,8,["content","confirm-loading"]),c(Bt,{"dialog-type":1})],64)}}}),Qa=Ne(La,[["__scopeId","data-v-0a066be1"]]);export{Qa as default};
