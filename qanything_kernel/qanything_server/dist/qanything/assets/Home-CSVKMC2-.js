import{a as qe,u as W,p as ge}from"./useOptiionList-B-uWg9iz.js";import{g as ce,u as as}from"./index-6oUtbOQt.js";import{d as X,A as c,B as u,C as t,J as v,G as o,L as re,M as ie,N as Z,r as D,c as h,R as k,z as O,E as x,W as S,H as $,F as Y,D as me,Y as I,a2 as J,a as ns,l as ls,o as xe,b as cs,O as ne,T as Q,U as R,K as q,a3 as rs,S as fe,Q as is,a4 as us}from"./index-DE5jAo-5.js";import{u as Ie,a as ds,b as hs,r as ps}from"./utils-CVRX5_sX.js";import{u as vs,b as _s,_ as gs,a as fs}from"./useChatSource-DhxrjnW0.js";import{u as ms,a as ys,b as Le,D as bs,f as ks,h as ws,_ as Cs,T as Ss}from"./html2canvas.esm-BX1dRO4B.js";import{u as le,_ as As,C as Ds,O as qs}from"./OptionList-Di8L4nin.js";import{u as Ls}from"./ChatSettingForm-CuWAXbZc.js";import{B as xs}from"./RightOutlined-Bly_GMgs.js";import"./collapseMotion-Bv6Bgtew.js";import"./index-C7hul5Vx.js";import"./index-JEbwr9jB.js";import"./index-Zgf1U6kq.js";import"./injectionKey-DGYNie3Z.js";import"./slide-DfxXrubr.js";const Is="/qanything/assets/icon-file-Bxz0aRpP.png",Ts=p=>(re("data-v-ec2d7664"),p=p(),ie(),p),$s={class:"upload-box"},Os=Ts(()=>t("img",{class:"icon-file",src:Is,alt:"图标"},null,-1)),Bs={class:"title"},Es={class:"desc-content"},Fs={class:"desc"},Qs={class:"desc"},Rs=X({__name:"UploadDom",props:{acceptList:{require:!0,type:Array,default:()=>[]}},emits:["update"],setup(p,{emit:i}){const d=ce().home,f=i,w=()=>{f("update")};return(l,b)=>(c(),u("div",$s,[t("div",{class:"tips",onClick:w},[Os,t("p",Bs,v(o(d).startDec),1),t("div",Es,[t("p",Fs,v(o(d).updesc2),1),t("p",Qs,v(o(d).require1),1)])])]))}}),Ns=Z(Rs,[["__scopeId","data-v-ec2d7664"]]),Us=p=>(re("data-v-9ccba3ef"),p=p(),ie(),p),Hs={class:"default"},Ms={class:"box"},js={class:"title"},zs=Us(()=>t("span",null," ",-1)),Ps={class:"color"},Ks={class:"desc"},Vs=X({__name:"Defaultpage",setup(p){const i=ce().home,{setFileList:d}=qe(),{setModalVisible:f}=qe(),{setCurrentId:w,getList:l,setCurrentKbName:b}=W(),U=[".doc",".docx",".ppt",".pptx",".xls",".xlsx",".pdf",".md",".jpg",".jpeg",".png",".bmp",".txt",".eml"],H=D(""),M=async()=>{console.log("updata");try{const _=await Ie.createKb({kb_name:i.defaultName});+_.code==200&&(H.value=_.data.kb_id,w(_.data.kb_id),b(_.kb_name),f(!0),l())}catch(_){d([]),k.error(_.msg)}};return(_,G)=>(c(),u("div",Hs,[t("div",Ms,[t("p",js,[t("span",null,v(o(i).homeTitle1),1),zs,t("span",Ps,v(o(i).homeTitle2),1)]),t("p",Ks,v(o(i).defaultDec),1),h(Ns,{"accept-list":U,onUpdate:M})])]))}}),Ys=Z(Vs,[["__scopeId","data-v-9ccba3ef"]]),Js="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAEgSURBVFiF7ZaxDcJADEVt0lAyQkaAKzIHI0BxkmeKCxiFAaKDDRAdJQvkQpNIEeQu9gVoyK8SXZz/ZPssA8ya9e/KYofW2nVRFMuqqh4pP5fEL0IHRJQj4tl7f7XW7hLMd734tRqgrutV94yIBw1Ea37o3rMsC2YgWALn3N0Yc0PEbQuxNcbcnHMXjXnTNPuyLE9qgBbiooEYMmfmY8wjCqCBSDEXAUggUs0BAFDyUachoxYoyVwNMATRl9YcQFiCvl7LMcUcIDIHfiV1BkIlkM6Jt7gp5p9oQnEGQldNO6ySAMbu+RSIUQDpkEmFGNsHVBMuBSLYhESUe++vUvMR8A0zD0KI9gFtZzPzsbshAPF9ICoiymPbzLfjZ836Dz0BusANDR+zFvgAAAAASUVORK5CYII=",Ws=p=>(re("data-v-52b8d98c"),p=p(),ie(),p),Xs={class:"history-chat"},Zs={class:"history-chat-content"},Gs={class:"list"},eo=Ws(()=>t("div",{class:"line"},null,-1)),so=["onClick"],oo=["onClick"],to=X({__name:"HistoryChat",props:{observer:{type:Object,required:!0},observeDom:{type:Object,default:null},qaObserver:{type:Object,required:!0},qaObserveDom:{type:Object,default:null},showLoading:{type:Boolean,require:!0}},emits:["scrollBottom","setObserveDom","setQaObserverDom","clearHistory"],setup(p,{emit:i}){const d=p,{chatList:f,chatId:w,QA_List:l,qaPageId:b,pageId:U,historyList:H}=O(le()),{deleteHistoryList:M,getChatById:_}=le(),{setSelectList:G}=W(),L=i;function ue(C){l.value.push({question:C,type:"user"})}function j(C,A,r,N,m){l.value.push({answer:A,question:C,type:"ai",qaId:N,copied:!1,like:!1,unlike:!1,source:m||[],showTools:!0,picList:r})}async function de(C){if(!d.showLoading){w.value=C.historyId,l.value=[],b.value=1,G([...C.kbIds]),L("clearHistory");try{const A=_(w.value);d.qaObserveDom!==null&&(d.qaObserver.unobserve(d.qaObserveDom),L("setQaObserverDom",null)),A.list.forEach(r=>{r.type==="user"?ue(r.question):r.type==="ai"&&j(r.question,r.answer,r.picList,r.qaId,r.source)}),L("scrollBottom"),A.list.length>=50&&await J(()=>{const r=document.getElementsByClassName("chat-li");r.length&&(d.qaObserver.observe(r[0]),L("setQaObserverDom",r[0]))})}catch(A){k.error(A.msg||"获取问答历史失败")}}}function z(){if(!d.showLoading){if(w.value===null){k.info("已切换最新对话");return}w.value=null,l.value=[],b.value=1,U.value=1,L("clearHistory")}}async function he(C,A){if(!d.showLoading)try{M(C.historyId),C.historyId===w.value&&z(),k.success("删除成功"),f.value.splice(A,1),await J(()=>{ee()})}catch(r){k.error(r.msg||"删除失败")}}function ee(){if(d.qaObserveDom!==null){d.qaObserver.unobserve(d.qaObserveDom),L("setQaObserverDom",null);const C=document.getElementsByClassName("chat-li");C.length&&(d.qaObserver.observe(C[0]),L("setQaObserverDom",C[0]))}}return(C,A)=>(c(),u("div",Xs,[t("div",Zs,[t("div",Gs,[t("div",{class:x(["new-chat",[p.showLoading?"disabled":"",o(w)===null?"new-active":""]]),onClick:z},[h(S,{name:"new-chat"}),$(" "+v(o(ce)().home.newConversation),1)],2),(c(!0),u(Y,null,me(o(H),(r,N)=>(c(),u("div",{key:r.historyId,class:x(["chat-item",o(w)===r.historyId?"item-active":"",p.showLoading?"disabled":""])},[eo,t("span",{onClick:m=>de(r)},v(r.title),9,so),o(w)===r.historyId?(c(),u("img",{key:0,src:Js,class:"close-icon",alt:"close",onClick:m=>he(r,N)},null,8,oo)):I("",!0)],2))),128))])])]))}}),ao=Z(to,[["__scopeId","data-v-52b8d98c"]]),Te=p=>(re("data-v-6976f76d"),p=p(),ie(),p),no={class:"container showSider"},lo={class:"my-page"},co={key:0,class:"user"},ro=Te(()=>t("img",{class:"avatar",src:fs,alt:"头像"},null,-1)),io={class:"question-text"},uo={key:1,class:"ai"},ho=Te(()=>t("img",{class:"avatar",src:Cs,alt:"头像"},null,-1)),po={class:"content"},vo={class:"ai-right"},_o={key:1},go={key:0},fo={key:1},mo={key:0},yo={key:0},bo={key:1},ko={key:0},wo={class:"source-list"},Co={class:"control"},So={class:"tips"},Ao=["href"],Do=["onClick"],qo={class:"source-content"},Lo=["innerHTML"],xo={class:"score"},Io={class:"tips"},To={key:3,class:"feed-back"},$o=["onClick"],Oo={class:"reload-text"},Bo={class:"tools"},Eo={key:0,class:"stop-btn"},Fo={class:"question-box"},Qo={class:"question"},Ro={class:"send-box"},No={class:"send-action"},Uo=X({__name:"Chat",setup(p){const i=ce().common,d=new Ss(e=>{e&&(l.value[l.value.length-1].answer+=e||"",console.log(l.value))}),{selectList:f,knowledgeBaseList:w}=O(W()),{QA_List:l,chatId:b,pageId:U,qaPageId:H,historyList:M}=O(le()),{chatSettingFormActive:_}=O(Ls()),{copy:G}=ms(),{addHistoryList:L,updateHistoryList:ue,addChatList:j,clearChatList:de}=le(),{setChatSourceVisible:z,setSourceType:he,setSourceUrl:ee,setTextContent:C}=vs(),{language:A}=O(as()),r=D(""),N=ns(()=>{const e=_.value.context,s=l.value.slice(-e),a=[];for(const g of s)g.type==="ai"&&a.push([g.question,g.answer]);return console.log(a),a});ls(()=>{console.log(N.value),console.log(l.value)});const m=D(!1),B=D([]),se=D(null),oe=D(null);let T;const $e=D(null),ye=D(null),E=()=>{J(()=>{var e;(e=ye.value)==null||e.scrollIntoView(!1)})},be=new IntersectionObserver(e=>{e.forEach(s=>{s.isIntersecting&&(console.log("entry.isIntersecting"),U.value++)})}),ke=new IntersectionObserver(e=>{e.forEach(s=>{s.isIntersecting&&(console.log("qa entry.isIntersecting"),H.value++)})});xe(()=>{console.log("------chatId",b.value),E()}),cs(()=>{se.value&&be.unobserve(se.value),oe.value&&ke.unobserve(oe.value)});const Oe=ys((e,s)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){s.target.parentNode.style.animation="shake ease-in .5s";const a=setTimeout(()=>{clearTimeout(a),s.target.parentNode.style.animation=""},600)}},800),Be=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},Ee=e=>{G(e.answer).then(()=>{e.copied=!e.copied,k.success(i.copySuccess,1);const s=setTimeout(()=>{clearTimeout(s),e.copied=!e.copied},1e3)}).catch(()=>{k.error(i.copyFailed,1)})},Fe=e=>{l.value.push({question:e,type:"user"}),console.log("QALIST------",l.value),E()},Qe=e=>{l.value.push({answer:"",question:e,onlySearch:_.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},Re=e=>{se.value=e},Ne=e=>{oe.value=e},we=(e,s,a)=>{try{ue(e,s,a)}catch(g){k.error(g.msg||"更新对话失败")}};function Ue(){if(!f.value.length)return;const e=[];f.value.forEach(s=>{w.value.some(a=>a.kb_id===s)&&e.push(s)}),f.value=e,M.value.forEach(s=>{b.value!==null&&s.historyId===b.value&&s.kbIds.join("")!==f.value.join("")&&we(s.title,s.historyId,f.value)})}const He=()=>{T&&T.abort(),d.done(),m.value=!1,l.value[l.value.length-1].showTools=!0},Me=e=>{try{if(console.log("chat-title=",e),b.value!==null)return;e.length>100&&(e=e.substring(0,100)),b.value=L(e),we(e,b.value,f.value)}catch(s){k.error(s.msg||"创建对话失败")}},pe=()=>{if(!r.value.trim().length)return;if(m.value){k.warn("正在聊天中...请等待结束");return}if(Ue(),f.value.length)k.info({content:i.type==="zh"?`已选择 ${f.value.length} 个知识库进行问答`:` ${f.value.length} knowledge base has been selected`,icon:" "});else return k.warning(i.chooseError);const e=r.value;Me(e),r.value="",Fe(e),j(b.value,l.value),m.value=!0,T=new AbortController,ks(hs+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:ds,kb_ids:f.value,history:N.value,question:e,streaming:!0,networking:_.value.capabilities.onlineSearch,product_source:"saas",only_need_search_results:_.value.capabilities.onlySearch,hybrid_search:_.value.capabilities.mixedSearch,max_token:_.value.maxToken,api_base:_.value.apiBase,api_key:_.value.apiKey,model:_.value.apiModelName,api_context_length:_.value.apiContextLength,top_p:_.value.top_P,temperature:_.value.temperature}),signal:T.signal,onopen(s){if(console.log("open"),s.ok&&s.headers.get("content-type")==="text/event-stream")Qe(e),d.start();else if(s.headers.get("content-type")==="application/json")return m.value=!1,s.json().then(a=>{k.error((a==null?void 0:a.msg)||"出错了,请稍后刷新重试。")}).catch(a=>{console.log(a),k.error("出错了,请稍后刷新重试。")})},onmessage(s){var g;console.log("message");const a=JSON.parse(s.data);console.log(a),(a==null?void 0:a.code)==200&&(a!=null&&a.response)&&(d.add(a==null?void 0:a.response),E()),(g=a==null?void 0:a.source_documents)!=null&&g.length&&(l.value[l.value.length-1].source=a==null?void 0:a.source_documents)},onclose(s){console.log("close"),console.log(s),d.done(),T.abort(),m.value=!1,l.value[l.value.length-1].showTools=!0,j(b.value,l.value),J(()=>{E()})},onerror(s){throw console.log("error"),d==null||d.done(),T==null||T.abort(),m.value=!1,l.value[l.value.length-1].showTools=!0,k.error(s.msg||"出错了"),j(b.value,l.value),J(()=>{E()}),s}})},je=e=>{console.log("reAnswer"),r.value=e.question,pe()},ze=(e,s)=>{e.source[s].showDetailDataSource=!e.source[s].showDetailDataSource},Pe=(e,s)=>{e.source[s].showDetailDataSource=!1},Ke=e=>{B.value.push(e)},Ve=e=>{B.value=B.value.filter(s=>s!==e)},{showModal:ve}=O(Le()),_e=D(!1),te=D(""),P=D(""),Ye=()=>{m.value||(P.value="download",ve.value=!0,te.value=i.saveTip)},Je=()=>{m.value||(P.value="delete",ve.value=!0,te.value=i.clearTip)},We=async()=>{if(_e.value=!0,P.value==="download"){console.log("download");try{const e=document.getElementById("chat-ul"),a=(await ws(e,{useCORS:!0})).toDataURL("image/png"),g=document.createElement("a");g.style.display="none",g.href=a,g.setAttribute("download","chat-shot.png"),typeof g.download>"u"&&g.setAttribute("target","_blank"),document.body.appendChild(g),g.click(),document.body.removeChild(g),window.URL.revokeObjectURL(a),k.success("下载成功"),Promise.resolve()}catch(e){console.log(e),k.error(e.message||e.msg||"出错了")}}else P.value==="delete"&&(console.log("delete"),de(b.value),b.value=null,l.value=[]);P.value="",te.value="",_e.value=!1,ve.value=!1},{showSettingModal:Xe}=O(Le()),Ze=e=>{Xe.value=e};let Ce=["pdf","docx","xlsx","txt","jpg","png","jpeg"];const Se=e=>{if(!e)return!1;const s=e.split(".");if(s.length){const a=s.pop();return!!Ce.includes(a)}else return!1},Ge=e=>{console.log("handleChatSource",e),Se(e.file_name)&&es(e)};async function es(e){try{ee(null);const s=await ps(await Ie.getFile({file_id:e.file_id}));console.log("queryFile",s);const a=e.file_name.split(".").pop(),g=os(a);if(console.log("b64Type",g),he(a),ee(`data:${g};base64,${s.base64_content}`),a==="txt"){const K=atob(s.base64_content),n=decodeURIComponent(escape(K));console.log("decodedTxt",n),C(n),z(!0)}else z(!0)}catch(s){k.error(s.msg||"获取文件失败")}}let ss=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","image/jpeg","image/png","image/jpeg"];function os(e){const s=Ce.indexOf(e);return ss[s]}function ts(){console.log("清空")}return E(),(e,s)=>{const a=xs,g=_s,K=gs;return c(),u(Y,null,[h(ao,{observer:o(be),"observe-dom":o(se),"qa-observe-dom":o(oe),"qa-observer":o(ke),"show-loading":o(m),onScrollBottom:E,onSetObserveDom:Re,onSetQaObserverDom:Ne,onClearHistory:ts},null,8,["observer","observe-dom","qa-observe-dom","qa-observer","show-loading"]),t("div",no,[t("div",lo,[t("div",{id:"chat",ref_key:"chatContainer",ref:$e,class:"chat showSider"},[t("ul",{id:"chat-ul",ref_key:"scrollDom",ref:ye},[(c(!0),u(Y,null,me(o(l),(n,F)=>{var Ae,De;return c(),u("li",{key:F},[n.type==="user"?(c(),u("div",co,[ro,t("p",io,v(n.question),1)])):(c(),u("div",uo,[ho,t("div",po,[t("div",vo,[n.onlySearch?I("",!0):(c(),u("p",{key:0,class:x(["question-text",[!n.source.length&&!((Ae=n==null?void 0:n.picList)!=null&&Ae.length)?"change-radius":"",n.showTools?"":"flashing"]])},[n.answer?(c(),ne(As,{key:0,content:n.answer},null,8,["content"])):(c(),u("span",_o,v(n.answer),1))],2)),n.onlySearch&&!n.source.length?(c(),u("p",{key:1,class:x(["question-text",[!n.source.length&&!((De=n==null?void 0:n.picList)!=null&&De.length)?"change-radius":"",n.showTools?"":"flashing"]])},[o(A)==="zh"?(c(),u("span",go,"未找到信息来源")):(c(),u("span",fo,"Information source not found"))],2)):I("",!0),n.source.length?(c(),u(Y,{key:2},[t("div",{class:x(["source-total",o(B).includes(F)?"":"source-total-last"])},[o(A)==="zh"?(c(),u("span",mo,[n.onlySearch?(c(),u("span",yo,"检索完成，")):I("",!0),$(" 找到了"+v(n.source.length)+"个信息来源： ",1)])):(c(),u("span",bo,[n.onlySearch?(c(),u("span",ko,"Search completed，")):I("",!0),$(" Found "+v(n.source.length)+" source of information ",1)])),Q(h(S,{name:"down",onClick:y=>Ke(F)},null,8,["onClick"]),[[R,!o(B).includes(F)]]),Q(h(S,{name:"up",onClick:y=>Ve(F)},null,8,["onClick"]),[[R,o(B).includes(F)]])],2),Q(t("div",wo,[(c(!0),u(Y,null,me(n.source,(y,ae)=>(c(),u("div",{key:ae,class:"data-source"},[Q(t("p",Co,[t("span",So,v(o(i).dataSource)+v(ae+1)+":",1),y.file_id.startsWith("http")?(c(),u("a",{key:0,href:y.file_id,target:"_blank"},v(y.file_name),9,Ao)):(c(),u("span",{key:1,class:x(["file",Se(y.file_name)?"filename-active":""]),onClick:V=>Ge(y)},v(y.file_name),11,Do)),Q(h(S,{name:"iconup",onClick:V=>Pe(n,ae)},null,8,["onClick"]),[[R,y.showDetailDataSource]]),Q(h(S,{name:"icondown",onClick:V=>ze(n,ae)},null,8,["onClick"]),[[R,!y.showDetailDataSource]])],512),[[R,y.file_name]]),h(rs,{name:"sourceitem"},{default:q(()=>{var V;return[Q(t("div",qo,[t("p",{innerHTML:(V=y.content)==null?void 0:V.replaceAll(`
`,"<br/>")},null,8,Lo),t("p",xo,[t("span",Io,v(o(i).correlation),1),$(v(y.score),1)])],512),[[R,y.showDetailDataSource]])]}),_:2},1024)]))),128))],512),[[R,o(B).includes(F)]])],64)):I("",!0),n.showTools?(c(),u("div",To,[t("div",{class:"reload-box",onClick:y=>je(n)},[h(S,{name:"reload"}),t("span",Oo,v(o(i).regenerate),1)],8,$o),t("div",Bo,[h(S,{style:fe({color:n.copied?"#4D71FF":""}),name:"copy",onClick:y=>Ee(n)},null,8,["style","onClick"]),h(S,{style:fe({color:n.like?"#4D71FF":""}),name:"like",onClick:y=>o(Oe)(n,y)},null,8,["style","onClick"]),h(S,{style:fe({color:n.unlike?"#4D71FF":""}),name:"unlike",onClick:y=>Be(n)},null,8,["style","onClick"])])])):I("",!0)])])]))])}),128))],512)],512),o(m)?(c(),u("div",Eo,[h(a,{onClick:He},{icon:q(()=>[h(S,{name:"stop",class:x(o(m)?"loading":"")},null,8,["class"])]),default:q(()=>[$(" "+v(o(i).stop),1)]),_:1})])):I("",!0),t("div",Fo,[t("div",Qo,[t("div",Ro,[h(g,{value:o(r),"onUpdate:value":s[0]||(s[0]=n=>is(r)?r.value=n:null),class:"send-textarea","max-length":"200",placeholder:o(i).problemPlaceholder,"auto-size":{minRows:3,maxRows:8},onKeyup:us(pe,["enter"])},null,8,["value","placeholder"]),t("div",No,[h(K,{placement:"topLeft"},{content:q(()=>[$(v(o(i).chatToPic),1)]),default:q(()=>[t("span",{class:x(["download",o(m)?"isPreventClick":""]),onClick:Ye},[h(S,{name:"chat-download"})],2)]),_:1}),h(K,null,{content:q(()=>[$(v(o(i).clearChat),1)]),default:q(()=>[t("span",{class:x(["delete",o(m)?"isPreventClick":""]),onClick:Je},[h(S,{name:"chat-delete"})],2)]),_:1}),h(K,null,{content:q(()=>[$(v(o(i).modelSettingTitle),1)]),default:q(()=>[t("span",{class:"setting",onClick:s[1]||(s[1]=n=>Ze(!0))},[h(S,{name:"chat-setting"})])]),_:1}),h(a,{type:"primary",disabled:o(m),shape:"circle",onClick:pe},{default:q(()=>[h(S,{name:"sendplane"})]),_:1},8,["disabled"])])])])])])]),h(Ds),h(bs,{content:o(te),"confirm-loading":o(_e),onOk:We},null,8,["content","confirm-loading"])],64)}}}),Ho=Z(Uo,[["__scopeId","data-v-6976f76d"]]),Mo={class:"page"},jo={class:"container"},zo=X({__name:"Home",setup(p){const{showDefault:i}=O(W()),{setDefault:d,getList:f}=W(),w=l=>{d(l),f()};return xe(()=>{console.log(i.value),f()}),(l,b)=>(c(),u("div",Mo,[t("div",jo,[o(i)===o(ge).default?(c(),ne(Ys,{key:0,onChange:w})):o(i)===o(ge).normal?(c(),ne(Ho,{key:1})):o(i)===o(ge).optionlist?(c(),ne(qs,{key:2})):I("",!0)])]))}}),lt=Z(zo,[["__scopeId","data-v-fe878bf5"]]);export{lt as default};
