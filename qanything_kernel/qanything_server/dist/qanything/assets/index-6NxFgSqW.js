import{d as Te,$ as it,a as R,o as De,A as r,B as u,C as i,c,G as s,W as _,X as T,J as v,r as w,N as Le,z as M,b as we,O as Z,F as z,D as ee,K as y,Q as ct,a2 as te,R as k,E as A,T as U,U as N,H as V,a3 as rt,S as ue,L as ut,M as dt}from"./index-Bj9wLH7w.js";import{u as pt,b as ht,_ as vt,c as ft,a as _t}from"./useChatSource-CYeYATxU.js";import{u as gt,a as mt,b as Ce,D as kt,f as yt,h as wt,T as Ct,_ as bt}from"./html2canvas.esm-AKI2Fzi2.js";import{g as St,u as xt}from"./index-DtByvqT9.js";import{f as Tt,p as Dt,r as Q,u as J,a as Lt,b as Ft,C as Bt}from"./utils--czjniUZ.js";import{u as be}from"./useQuickStart-CLYXWvs6.js";import{L as qt,C as $t,F as It,O as Mt}from"./OptionList-S9Cu2uTs.js";import{u as Ut,a as Nt,c as Se,p as Rt}from"./useUploadFiles-CE4-W4Wr.js";import{u as Ot}from"./useChatSetting-CX1ViVqR.js";import{C as Kt}from"./ChatInfoPanel-twNkejY5.js";import{B as jt}from"./RightOutlined-CTP4p-KW.js";import"./index-dXUC_bcH.js";import"./collapseMotion-5SmM8uKw.js";import"./index-CjF8ghwO.js";import"./index-B79F42LW.js";import"./injectionKey-DGYNie3Z.js";import"./slide-BSGQNT0H.js";const zt={class:"contain"},At={class:"file-icon"},Et={key:0,class:"loading"},Ht={class:"file-info"},Pt={class:"file-name"},Vt={key:0,class:"file-extension"},Qt={key:1,class:"file-extension"},Jt=Te({__name:"FileBlock",props:{fileData:{},kbId:{},status:{}},emits:["deleteFile"],setup(O,{emit:f}){const ae=f,se=O,{fileData:o,kbId:p}=it(se),m=R(()=>C.value!=="green"&&C.value!=="red"),D=R(()=>Dt(o.value.file_name)),g=R(()=>C.value==="red"?"file-error":C.value==="green"?"file-"+oe.get(D.value.fileExtension):"file-unknown"),C=R(()=>o.value.status),oe=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]),K=new Map([["gray","上传中"],["yellow","解析中"],["green","解析成功"],["red","解析失败"]]),ne=()=>{let L=w(null);L.value=setInterval(async()=>{var E;if(o.value.file_id===""&&o.value.status!=="loading"&&(o.value.status="red"),o.value.status==="green"||o.value.status==="red")clearInterval(L.value),L.value=null;else{const H=await Q(await J.fileList({kb_id:p.value,file_id:o.value.file_id}));console.log(H),o.value.status=((E=H.details[0])==null?void 0:E.status)||"red"}},2e3)},W=async()=>{ae("deleteFile",o.value.file_id,p.value)};return De(()=>{ne()}),(L,E)=>(r(),u("div",zt,[i("div",At,[c(_,{name:s(g)},null,8,["name"]),s(m)?(r(),u("div",Et,[c(qt)])):T("",!0)]),i("div",Ht,[i("span",Pt,v(s(D).fileName),1),s(C)==="green"?(r(),u("span",Vt,v(s(D).fileExtension.toUpperCase())+", "+v(s(Tt)(s(o).bytes)||0),1)):(r(),u("span",Qt,v(s(K).get(s(C))),1))]),L.status==="toBeSend"?(r(),u("div",{key:0,class:"file-close",onClick:W},[c(_,{name:"close"})])):T("",!0)]))}}),xe=Le(Jt,[["__scopeId","data-v-f1a2f795"]]),Fe=O=>(ut("data-v-4c525a60"),O=O(),dt(),O),Wt={class:"container"},Gt={key:1,class:"my-page"},Xt={key:0,class:"user"},Yt=Fe(()=>i("img",{class:"avatar",src:_t,alt:"头像"},null,-1)),Zt={class:"question-inner"},ea={class:"question-text"},ta={key:0,class:"file-list-box"},aa={key:1,class:"ai"},sa=Fe(()=>i("img",{class:"avatar",src:bt,alt:"头像"},null,-1)),oa={class:"ai-content"},na={class:"ai-right"},la={key:0},ia={key:1},ca={class:"source-list"},ra={class:"control"},ua={class:"tips"},da=["href"],pa=["onClick"],ha={class:"source-content"},va=["innerHTML"],fa={class:"score"},_a={class:"tips"},ga={key:1,class:"feed-back"},ma=["onClick"],ka={class:"reload-text"},ya={class:"tools"},wa={key:0,class:"stop-btn"},Ca={class:"question-box"},ba={class:"question"},Sa={key:0,class:"file-list-box"},xa={class:"send-box"},Ta={class:"scroll-btn-div"},Da={class:"send-action"},La=Te({__name:"index",setup(O){const{common:f,home:ae}=St(),{copy:se}=gt(),{QA_List:o,chatId:p,kbId:m,kbIdCopy:D,showLoading:g}=M(be()),{addHistoryList:C,updateHistoryList:oe,addChatList:K,clearChatList:ne,getHistoryById:W,renameHistory:L,addFileToBeSendList:E}=be(),{setChatSourceVisible:H,setSourceType:Be,setSourceUrl:de,setTextContent:qe}=pt(),{chatSettingFormActive:h}=M(Ot()),{showDefault:$e}=M(Ut()),{setModalVisible:Ie,setModalTitle:Me}=Nt(),{uploadFileListQuick:F}=M(Se()),{initUploadFileListQuick:pe}=Se(),{language:Ue}=M(xt()),G=R(()=>W(p.value)),B=new Ct(e=>{e&&(o.value[o.value.length-1].answer+=e||"")}),b=w(""),Ne=R(()=>{const e=h.value.context;if(e===0)return[];const a=o.value.filter(n=>n.type==="ai");return(e===1?a:a.slice(-e)).map(n=>[n.question,n.answer])}),q=w([]);let S;const Re=w(null),he=w(null),$=()=>{te(()=>{var e;(e=he.value)==null||e.scrollIntoView({behavior:"smooth",block:"end"})})},le=R(()=>{var a;return(((a=G.value)==null?void 0:a.fileToBeSendList.concat(F==null?void 0:F.value))||[]).filter(t=>t.file_id.length!==0)});De(()=>{D.value&&(m.value=D.value),$()}),we(()=>{F.value.length&&(E(p.value,[...F.value]),pe())});const Oe=e=>{e.keyCode===13&&(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey?b.value+=`
`:ie(),e.preventDefault())},Ke=mt((e,a)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){a.target.parentNode.style.animation="shake ease-in .5s";const t=setTimeout(()=>{clearTimeout(t),a.target.parentNode.style.animation=""},600)}},800),je=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},ze=e=>{se(e.answer).then(()=>{e.copied=!e.copied,k.success(f.copySuccess,1);const a=setTimeout(()=>{clearTimeout(a),e.copied=!e.copied},1e3)}).catch(()=>{k.error(f.copyFailed,1)})},Ae=async(e,a)=>{console.log(e);try{await Q(await J.deleteFile({file_ids:[e],kb_id:a})),k.success("删除成功");const t=F.value.findIndex(n=>n.file_id===e);t!==-1?F.value.splice(t,1):G.value.fileToBeSendList=G.value.fileToBeSendList.filter(n=>n.file_id!==e)}catch(t){k.error(t.msg||"删除失败")}},Ee=e=>{o.value.push({question:e,type:"user",fileDataList:[...le.value]}),$()},ve=e=>{o.value.push({answer:"",question:e,onlySearch:h.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},j=new Bt,He=()=>{S&&S.abort(),B.done(),g.value=!1,o.value[o.value.length-1].showTools=!0},Pe=async e=>{try{if(p.value!==null){W(p.value).title==="未命名对话"&&L(p.value,e);return}e.length>100&&(e=e.substring(0,100));const a=await Q(await J.createKb({kb_name:e}));m.value=a.kb_id,p.value=C(e),oe(e,p.value,m.value)}catch(a){k.error(a.msg||"创建对话失败")}},ie=async()=>{if(!b.value.trim().length)return;if(g.value){k.warn("正在聊天中...请等待结束");return}if(!await at()){k.error("模型设置错误，请先检查模型配置");return}const e=b.value;await Pe(e),b.value="",Ee(e),K(p.value,o.value),pe(),G.value.fileToBeSendList=[],g.value=!0,S=new AbortController;const a={kb_ids:[m.value],history:Ne.value,question:e,streaming:h.value.capabilities.onlySearch===!1,networking:h.value.capabilities.networkSearch,product_source:"saas",rerank:h.value.capabilities.rerank,only_need_search_results:h.value.capabilities.onlySearch,hybrid_search:h.value.capabilities.mixedSearch,max_token:h.value.maxToken,api_base:h.value.apiBase,api_key:h.value.apiKey,model:h.value.apiModelName,api_context_length:h.value.apiContextLength,chunk_size:h.value.chunkSize,top_p:h.value.top_P,temperature:h.value.temperature};if(h.value.capabilities.onlySearch){j.addChatSetting(h.value),ve(e);try{const t=await Q(await J.sendQuestion(a));t.code===200&&(o.value[o.value.length-1].answer=t!=null&&t.source_documents.length?f.searchCompleted:f.searchNotFound,o.value[o.value.length-1].source=t==null?void 0:t.source_documents)}catch(t){k.error(t.msg||"出错了"),o.value[o.value.length-1].answer=t||"error"}g.value=!1,o.value[o.value.length-1].showTools=!0,K(p.value,o.value),await te(()=>{$()})}else yt(Ft+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:Lt,...a}),signal:S.signal,onopen(t){console.log("open",t),j.addChatSetting(h.value),ve(e),t.ok&&t.headers.get("content-type")==="text/event-stream"&&B.start()},onmessage(t){var x;console.log("message",t);const n=JSON.parse(t.data);if((n==null?void 0:n.code)==200&&(n!=null&&n.response)&&n.msg==="success")B.add(n==null?void 0:n.response),$();else{const l=n.time_record.time_usage;delete l.retriever_search_by_milvus,j.addTime(n.time_record.time_usage),j.addToken(n.time_record.token_usage),j.addDate(Date.now())}(x=n==null?void 0:n.source_documents)!=null&&x.length&&(o.value[o.value.length-1].source=n==null?void 0:n.source_documents)},onclose(t){console.log("close",t),B.done(),S.abort(),g.value=!1,o.value[o.value.length-1].showTools=!0,o.value.at(-1).itemInfo=j.getChatInfo(),K(p.value,o.value),te(()=>{$()}),console.log(o.value)},onerror(t){throw console.log("error",t),B==null||B.done(),S==null||S.abort(),g.value=!1,o.value[o.value.length-1].showTools=!0,k.error(t.msg||"出错了"),K(p.value,o.value),te(()=>{$()}),t}})},Ve=e=>{b.value=e.question,ie()},Qe=(e,a)=>{e.source[a].showDetailDataSource=!e.source[a].showDetailDataSource},Je=(e,a)=>{e.source[a].showDetailDataSource=!1},We=e=>{q.value.push(e)},Ge=e=>{q.value=q.value.filter(a=>a!==e)},{showModal:fe}=M(Ce()),ce=w(!1),re=w(""),X=w(""),Xe=()=>{m.value&&(Ie(!0),Me(ae.upload))},Ye=()=>{g.value||(X.value="download",fe.value=!0,re.value=f.saveTip)},Ze=async()=>{if(ce.value=!0,X.value==="download")try{const e=document.getElementById("chat-ul"),t=(await wt(e,{useCORS:!0})).toDataURL("image/png"),n=document.createElement("a");n.style.display="none",n.href=t,n.setAttribute("download","chat-shot.png"),typeof n.download>"u"&&n.setAttribute("target","_blank"),document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(t),k.success("下载成功"),await Promise.resolve()}catch(e){k.error(e.message||e.msg||"出错了")}else X.value==="delete"&&(ne(p.value),p.value=null,o.value=[]);X.value="",re.value="",ce.value=!1,fe.value=!1},{showSettingModal:et}=M(Ce()),tt=e=>{et.value=e},_e=w(),at=()=>_e.value.handleOk();let ge=["pdf","docx","xlsx","txt","md","jpg","png","jpeg"];const me=e=>{if(!e)return!1;const a=e.split(".");if(a.length){const t=a.pop();return ge.includes(t)}else return!1},st=e=>{me(e.file_name)&&ot(e)};async function ot(e){try{de(null);const a=await Q(await J.getFile({file_id:e.file_id})),t=e.file_name.split(".").pop(),n=lt(t);if(Be(t),de(`data:${n};base64,${a.file_base64}`),t==="txt"){const x=atob(a.file_base64),l=decodeURIComponent(escape(x));qe(l),H(!0)}else H(!0)}catch(a){k.error(a.msg||"获取文件失败")}}let nt=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/markdown","image/jpeg","image/png","image/jpeg"];function lt(e){const a=ge.indexOf(e);return nt[a]}return we(()=>{D.value=m.value,m.value=""}),(e,a)=>{const t=jt,n=ht,x=vt;return r(),u(z,null,[i("div",Wt,[s($e)===s(Rt).optionlist?(r(),Z(Mt,{key:0})):(r(),u("div",Gt,[i("div",{id:"chat",ref_key:"chatContainer",ref:Re,class:"chat"},[i("ul",{id:"chat-ul",ref_key:"scrollDom",ref:he},[(r(!0),u(z,null,ee(s(o),(l,I)=>{var ke,ye;return r(),u("li",{key:I},[l.type==="user"?(r(),u("div",Xt,[Yt,i("div",Zt,[i("p",ea,v(l.question),1),l.fileDataList.length?(r(),u("div",ta,[(r(!0),u(z,null,ee(l.fileDataList,d=>(r(),Z(xe,{key:d.file.lastModified,"file-data":d,"kb-id":s(m),"chat-id":s(p),status:"send"},null,8,["file-data","kb-id","chat-id"]))),128))])):T("",!0)])])):(r(),u("div",aa,[sa,i("div",oa,[i("div",na,[i("p",{class:A(["question-text",[!l.source.length&&!((ke=l==null?void 0:l.picList)!=null&&ke.length)?"change-radius":"",l.showTools?"":"flashing"]])},[c(ft,{content:l.answer},null,8,["content"]),Object.keys(((ye=l==null?void 0:l.itemInfo)==null?void 0:ye.tokenInfo)||{}).length?(r(),Z(Kt,{key:0,"chat-item-info":l.itemInfo},null,8,["chat-item-info"])):T("",!0)],2),l.source.length?(r(),u(z,{key:0},[i("div",{class:A(["source-total",s(q).includes(I)?"":"source-total-last"])},[s(Ue)==="zh"?(r(),u("span",la," 找到了"+v(l.source.length)+"个信息来源： ",1)):(r(),u("span",ia," Found "+v(l.source.length)+" source of information ",1)),U(c(_,{name:"down",onClick:d=>We(I)},null,8,["onClick"]),[[N,!s(q).includes(I)]]),U(c(_,{name:"up",onClick:d=>Ge(I)},null,8,["onClick"]),[[N,s(q).includes(I)]])],2),U(i("div",ca,[(r(!0),u(z,null,ee(l.source,(d,Y)=>(r(),u("div",{key:Y,class:"data-source"},[U(i("p",ra,[i("span",ua,v(s(f).dataSource)+v(Y+1)+":",1),d.file_url.startsWith("http")?(r(),u("a",{key:0,href:d.file_url,target:"_blank"},v(d.file_name),9,da)):(r(),u("span",{key:1,class:A(["file",me(d.file_name)?"filename-active":""]),onClick:P=>st(d)},v(d.file_name),11,pa)),U(c(_,{name:"iconup",onClick:P=>Je(l,Y)},null,8,["onClick"]),[[N,d.showDetailDataSource]]),U(c(_,{name:"icondown",onClick:P=>Qe(l,Y)},null,8,["onClick"]),[[N,!d.showDetailDataSource]])],512),[[N,d.file_name]]),c(rt,{name:"sourceItem"},{default:y(()=>{var P;return[U(i("div",ha,[i("p",{innerHTML:(P=d.content)==null?void 0:P.replaceAll(`
`,"<br/>")},null,8,va),i("p",fa,[i("span",_a,v(s(f).correlation),1),V(v(d.score),1)])],512),[[N,d.showDetailDataSource]])]}),_:2},1024)]))),128))],512),[[N,s(q).includes(I)]])],64)):T("",!0),l.showTools?(r(),u("div",ga,[i("div",{class:"reload-box",onClick:d=>Ve(l)},[c(_,{name:"reload"}),i("span",ka,v(s(f).regenerate),1)],8,ma),i("div",ya,[c(_,{style:ue({color:l.copied?"#4D71FF":""}),name:"copy",onClick:d=>ze(l)},null,8,["style","onClick"]),c(_,{style:ue({color:l.like?"#4D71FF":""}),name:"like",onClick:d=>s(Ke)(l,d)},null,8,["style","onClick"]),c(_,{style:ue({color:l.unlike?"#4D71FF":""}),name:"unlike",onClick:d=>je(l)},null,8,["style","onClick"])])])):T("",!0)])])]))])}),128))],512)],512),s(g)?(r(),u("div",wa,[c(t,{onClick:He},{icon:y(()=>[c(_,{name:"stop",class:A(s(g)?"loading":"")},null,8,["class"])]),default:y(()=>[V(" "+v(s(f).stop),1)]),_:1})])):T("",!0),i("div",Ca,[i("div",ba,[s(le).length?(r(),u("div",Sa,[(r(!0),u(z,null,ee(s(le),l=>(r(),Z(xe,{key:l.file_id,"file-data":l,"kb-id":s(m),"chat-id":s(p),status:"toBeSend",onDeleteFile:Ae},null,8,["file-data","kb-id","chat-id"]))),128))])):T("",!0),i("div",xa,[i("div",Ta,[c(t,{type:"primary",shape:"circle",size:"large",onClick:$},{icon:y(()=>[c(_,{name:"scroll"})]),_:1})]),c(n,{value:s(b),"onUpdate:value":a[0]||(a[0]=l=>ct(b)?b.value=l:null),class:"send-textarea","max-length":"200",bordered:!1,placeholder:s(f).problemPlaceholder,"auto-size":{minRows:4,maxRows:8},onKeydown:Oe},null,8,["value","placeholder"]),i("div",Da,[c(x,null,{content:y(()=>[V(v(s(m)?s(f).chatUpload:s(f).chatUploadNoKbId),1)]),default:y(()=>[i("span",{class:A(["question-icon",s(g)||!s(m)?"isPreventClick":""]),onClick:Xe},[c(_,{name:"chat-upload"})],2)]),_:1}),c(x,null,{content:y(()=>[V(v(s(f).chatToPic),1)]),default:y(()=>[i("span",{class:A(["question-icon",s(g)?"isPreventClick":""]),onClick:Ye},[c(_,{name:"chat-download"})],2)]),_:1}),c(x,null,{content:y(()=>[V(v(s(f).modelSettingTitle),1)]),default:y(()=>[i("span",{class:"question-icon",onClick:a[1]||(a[1]=l=>tt(!0))},[c(_,{name:"chat-setting"})])]),_:1}),c(t,{type:"primary",disabled:s(g),shape:"circle",onClick:ie},{default:y(()=>[c(_,{name:"sendplane"})]),_:1},8,["disabled"])])])])])]))]),c($t,{ref_key:"chatSettingForDialogRef",ref:_e},null,512),c(kt,{content:s(re),"confirm-loading":s(ce),onOk:Ze},null,8,["content","confirm-loading"]),c(It,{"dialog-type":1})],64)}}}),Va=Le(La,[["__scopeId","data-v-4c525a60"]]);export{Va as default};
