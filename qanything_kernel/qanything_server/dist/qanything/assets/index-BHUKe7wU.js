import{d as ue,a as ne,o as de,A as l,B as i,c,G as a,W as _,C as n,J as d,N as pe,z as B,r as y,O as I,F as z,D as J,K as v,Y as D,Q as Ie,a4 as Je,a2 as W,R as g,E as w,H as C,T as L,U as q,a3 as We,S as G,L as Ge,M as Ye}from"./index-DE5jAo-5.js";import{u as Xe,b as Ze,_ as es,a as ss}from"./useChatSource-DhxrjnW0.js";import{u as ts,a as os,b as le,D as as,f as ns,h as ls,T as cs,_ as is}from"./html2canvas.esm-BX1dRO4B.js";import{_ as rs,C as us,O as ds}from"./OptionList-Di8L4nin.js";import{g as ps,u as hs}from"./index-6oUtbOQt.js";import{f as _s,p as fs,a as vs,b as gs,r as ce,u as ie}from"./utils-CVRX5_sX.js";import{a as re,u as ms}from"./useQuickStart-DTrqkC1o.js";import{u as ks,a as ys,p as ws}from"./useOptiionList-B-uWg9iz.js";import{B as Cs}from"./RightOutlined-Bly_GMgs.js";import"./ChatSettingForm-CuWAXbZc.js";import"./slide-DfxXrubr.js";import"./index-JEbwr9jB.js";import"./collapseMotion-Bv6Bgtew.js";import"./index-C7hul5Vx.js";import"./index-Zgf1U6kq.js";import"./injectionKey-DGYNie3Z.js";const Ss={class:"contain"},bs={class:"file-info"},xs={class:"file-name"},Ts={class:"file-extension"},Ds=ue({__name:"FileBlock",props:{fileData:{}},setup(F){const{fileData:h}=F,M=ne(()=>fs(h.file_name)),P=ne(()=>"file-"+r.get(M.value.fileExtension)),r=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]);return de(()=>{console.log(h)}),(m,O)=>(l(),i("div",Ss,[c(_,{name:a(P)},null,8,["name"]),n("div",bs,[n("span",xs,d(a(M).fileName),1),n("span",Ts,d(a(M).fileExtension.toUpperCase())+", "+d(a(_s)(m.fileData.file.size)||0),1)])]))}}),Ls=pe(Ds,[["__scopeId","data-v-368d020f"]]),he=F=>(Ge("data-v-b076070d"),F=F(),Ye(),F),qs={class:"container"},Fs={key:1,class:"my-page"},$s={key:0,class:"user"},Bs=he(()=>n("img",{class:"avatar",src:ss,alt:"头像"},null,-1)),Ms={class:"question-text"},js={key:1,class:"ai"},Ns=he(()=>n("img",{class:"avatar",src:is,alt:"头像"},null,-1)),Rs={class:"content"},Us={class:"ai-right"},zs={key:1},Os={key:0},As={key:1},Es={key:0},Ps={key:0},Vs={key:1},Hs={key:0},Ks={class:"source-list"},Qs={class:"control"},Is={class:"tips"},Js=["href"],Ws=["onClick"],Gs={class:"source-content"},Ys=["innerHTML"],Xs={class:"score"},Zs={class:"tips"},et={key:3,class:"feed-back"},st=["onClick"],tt={class:"reload-text"},ot={class:"tools"},at={key:0,class:"stop-btn"},nt={class:"question-box"},lt={class:"question"},ct={class:"file-list-box"},it={class:"send-box"},rt={class:"send-action"},ut=ue({__name:"index",setup(F){const{common:h,home:M}=ps(),{copy:P}=ts(),{QA_List:r,chatId:m,kbId:O,showLoading:f}=B(re()),{addHistoryList:_e,updateHistoryList:fe,addChatList:V,clearChatList:ve}=re(),{setChatSourceVisible:Y,setSourceType:ge,setSourceUrl:X,setTextContent:me}=Xe(),{showDefault:ke}=B(ks()),{setModalVisible:ye,setModalTitle:we}=ys(),{uploadFileList:Ce}=B(ms()),{language:Z}=B(hs()),S=new cs(e=>{e&&(r.value[r.value.length-1].answer+=e||"")}),b=y(""),j=y([]),x=y([]);let k;const Se=y(null),ee=y(null),N=()=>{W(()=>{var e;(e=ee.value)==null||e.scrollIntoView(!1)})};de(()=>{N()});const be=os((e,s)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){s.target.parentNode.style.animation="shake ease-in .5s";const o=setTimeout(()=>{clearTimeout(o),s.target.parentNode.style.animation=""},600)}},800),xe=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},Te=e=>{P(e.answer).then(()=>{e.copied=!e.copied,g.success(h.copySuccess,1);const s=setTimeout(()=>{clearTimeout(s),e.copied=!e.copied},1e3)}).catch(()=>{g.error(h.copyFailed,1)})},De=e=>{r.value.push({question:e,type:"user"}),N()},Le=e=>{r.value.push({answer:"",question:e,onlySearch:!1,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},qe=(e,s,o)=>{try{fe(e,s,o)}catch(p){g.error(p.msg||"更新对话失败")}},Fe=()=>{k&&k.abort(),S.done(),f.value=!1,r.value[r.value.length-1].showTools=!0},$e=async e=>{try{if(m.value!==null)return;e.length>100&&(e=e.substring(0,100));const s=await ce(await ie.createKb({kb_name:e}));O.value=s.kb_id,m.value=_e(e),qe(e,m.value,O.value)}catch(s){g.error(s.msg||"创建对话失败")}},H=async()=>{if(!b.value.trim().length)return;if(f.value){g.warn("正在聊天中...请等待结束");return}const e=b.value;await $e(e),b.value="",De(e),V(m.value,r.value),j.value.length>=3&&(j.value=[]),f.value=!0,k=new AbortController,ns(gs+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:vs,kb_ids:[O.value],history:j.value,question:e,streaming:!0,networking:!0,product_source:"saas",only_need_search_results:!1}),signal:k.signal,onopen(s){if(s.ok&&s.headers.get("content-type")==="text/event-stream")Le(e),S.start();else if(s.headers.get("content-type")==="application/json")return f.value=!1,s.json().then(o=>{g.error((o==null?void 0:o.msg)||"出错了,请稍后刷新重试。")}).catch(()=>{g.error("出错了,请稍后刷新重试。")})},onmessage(s){var p;const o=JSON.parse(s.data);(o==null?void 0:o.code)==200&&(o!=null&&o.response)&&(S.add(o==null?void 0:o.response),N()),(p=o==null?void 0:o.source_documents)!=null&&p.length&&(r.value[r.value.length-1].source=o==null?void 0:o.source_documents),o!=null&&o.history.length&&(j.value=o==null?void 0:o.history)},onclose(){S.done(),k.abort(),f.value=!1,r.value[r.value.length-1].showTools=!0,V(m.value,r.value),W(()=>{N()})},onerror(s){throw S==null||S.done(),k==null||k.abort(),f.value=!1,r.value[r.value.length-1].showTools=!0,g.error(s.msg||"出错了"),V(m.value,r.value),W(()=>{N()}),s}})},Be=e=>{b.value=e.question,H()},Me=(e,s)=>{e.source[s].showDetailDataSource=!e.source[s].showDetailDataSource},je=(e,s)=>{e.source[s].showDetailDataSource=!1},Ne=e=>{x.value.push(e)},Re=e=>{x.value=x.value.filter(s=>s!==e)},{showModal:K}=B(le()),Q=y(!1),A=y(""),R=y(""),Ue=()=>{ye(!0),we(M.upload)},ze=()=>{f.value||(R.value="download",K.value=!0,A.value=h.saveTip)},Oe=()=>{f.value||(R.value="delete",K.value=!0,A.value=h.clearTip)},Ae=async()=>{if(Q.value=!0,R.value==="download")try{const e=document.getElementById("chat-ul"),o=(await ls(e,{useCORS:!0})).toDataURL("image/png"),p=document.createElement("a");p.style.display="none",p.href=o,p.setAttribute("download","chat-shot.png"),typeof p.download>"u"&&p.setAttribute("target","_blank"),document.body.appendChild(p),p.click(),document.body.removeChild(p),window.URL.revokeObjectURL(o),g.success("下载成功"),await Promise.resolve()}catch(e){g.error(e.message||e.msg||"出错了")}else R.value==="delete"&&(j.value=[],ve(m.value),m.value=null,r.value=[]);R.value="",A.value="",Q.value=!1,K.value=!1},{showSettingModal:Ee}=B(le()),Pe=e=>{Ee.value=e};let se=["pdf","docx","xlsx","txt","jpg","png","jpeg"];const te=e=>{if(!e)return!1;const s=e.split(".");if(s.length){const o=s.pop();return se.includes(o)}else return!1},Ve=e=>{te(e.file_name)&&He(e)};async function He(e){try{X(null);const s=await ce(await ie.getFile({file_id:e.file_id})),o=e.file_name.split(".").pop(),p=Qe(o);if(ge(o),X(`data:${p};base64,${s.base64_content}`),o==="txt"){const $=atob(s.base64_content),t=decodeURIComponent(escape($));me(t),Y(!0)}else Y(!0)}catch(s){g.error(s.msg||"获取文件失败")}}let Ke=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","image/jpeg","image/png","image/jpeg"];function Qe(e){const s=se.indexOf(e);return Ke[s]}return(e,s)=>{const o=Cs,p=Ze,$=es;return l(),i(z,null,[n("div",qs,[a(ke)===a(ws).optionlist?(l(),I(ds,{key:0})):(l(),i("div",Fs,[n("div",{id:"chat",ref_key:"chatContainer",ref:Se,class:"chat"},[n("ul",{id:"chat-ul",ref_key:"scrollDom",ref:ee},[(l(!0),i(z,null,J(a(r),(t,T)=>{var oe,ae;return l(),i("li",{key:T},[t.type==="user"?(l(),i("div",$s,[Bs,n("p",Ms,d(t.question),1)])):(l(),i("div",js,[Ns,n("div",Rs,[n("div",Us,[t.onlySearch?D("",!0):(l(),i("p",{key:0,class:w(["question-text",[!t.source.length&&!((oe=t==null?void 0:t.picList)!=null&&oe.length)?"change-radius":"",t.showTools?"":"flashing"]])},[t.answer?(l(),I(rs,{key:0,content:t.answer},null,8,["content"])):(l(),i("span",zs,d(t.answer),1))],2)),t.onlySearch&&!t.source.length?(l(),i("p",{key:1,class:w(["question-text",[!t.source.length&&!((ae=t==null?void 0:t.picList)!=null&&ae.length)?"change-radius":"",t.showTools?"":"flashing"]])},[a(Z)==="zh"?(l(),i("span",Os,"未找到信息来源")):(l(),i("span",As,"Information source not found"))],2)):D("",!0),t.source.length?(l(),i(z,{key:2},[n("div",{class:w(["source-total",a(x).includes(T)?"":"source-total-last"])},[a(Z)==="zh"?(l(),i("span",Es,[t.onlySearch?(l(),i("span",Ps,"检索完成，")):D("",!0),C(" 找到了"+d(t.source.length)+"个信息来源： ",1)])):(l(),i("span",Vs,[t.onlySearch?(l(),i("span",Hs,"Search completed，")):D("",!0),C(" Found "+d(t.source.length)+" source of information ",1)])),L(c(_,{name:"down",onClick:u=>Ne(T)},null,8,["onClick"]),[[q,!a(x).includes(T)]]),L(c(_,{name:"up",onClick:u=>Re(T)},null,8,["onClick"]),[[q,a(x).includes(T)]])],2),L(n("div",Ks,[(l(!0),i(z,null,J(t.source,(u,E)=>(l(),i("div",{key:E,class:"data-source"},[L(n("p",Qs,[n("span",Is,d(a(h).dataSource)+d(E+1)+":",1),u.file_id.startsWith("http")?(l(),i("a",{key:0,href:u.file_id,target:"_blank"},d(u.file_name),9,Js)):(l(),i("span",{key:1,class:w(["file",te(u.file_name)?"filename-active":""]),onClick:U=>Ve(u)},d(u.file_name),11,Ws)),L(c(_,{name:"iconup",onClick:U=>je(t,E)},null,8,["onClick"]),[[q,u.showDetailDataSource]]),L(c(_,{name:"icondown",onClick:U=>Me(t,E)},null,8,["onClick"]),[[q,!u.showDetailDataSource]])],512),[[q,u.file_name]]),c(We,{name:"sourceItem"},{default:v(()=>{var U;return[L(n("div",Gs,[n("p",{innerHTML:(U=u.content)==null?void 0:U.replaceAll(`
`,"<br/>")},null,8,Ys),n("p",Xs,[n("span",Zs,d(a(h).correlation),1),C(d(u.score),1)])],512),[[q,u.showDetailDataSource]])]}),_:2},1024)]))),128))],512),[[q,a(x).includes(T)]])],64)):D("",!0),t.showTools?(l(),i("div",et,[n("div",{class:"reload-box",onClick:u=>Be(t)},[c(_,{name:"reload"}),n("span",tt,d(a(h).regenerate),1)],8,st),n("div",ot,[c(_,{style:G({color:t.copied?"#4D71FF":""}),name:"copy",onClick:u=>Te(t)},null,8,["style","onClick"]),c(_,{style:G({color:t.like?"#4D71FF":""}),name:"like",onClick:u=>a(be)(t,u)},null,8,["style","onClick"]),c(_,{style:G({color:t.unlike?"#4D71FF":""}),name:"unlike",onClick:u=>xe(t)},null,8,["style","onClick"])])])):D("",!0)])])]))])}),128))],512)],512),a(f)?(l(),i("div",at,[c(o,{onClick:Fe},{icon:v(()=>[c(_,{name:"stop",class:w(a(f)?"loading":"")},null,8,["class"])]),default:v(()=>[C(" "+d(a(h).stop),1)]),_:1})])):D("",!0),n("div",nt,[n("div",lt,[n("div",ct,[(l(!0),i(z,null,J(a(Ce),t=>(l(),I(Ls,{key:t.file.lastModified,"file-data":t},null,8,["file-data"]))),128))]),n("div",it,[c(p,{value:a(b),"onUpdate:value":s[0]||(s[0]=t=>Ie(b)?b.value=t:null),class:"send-textarea","max-length":"200",placeholder:a(h).problemPlaceholder,"auto-size":{minRows:3,maxRows:8},onKeyup:Je(H,["enter"])},null,8,["value","placeholder"]),n("div",rt,[c($,null,{content:v(()=>[C(d(a(h).chatUpload),1)]),default:v(()=>[n("span",{class:w(["question-icon",a(f)?"isPreventClick":""]),onClick:Ue},[c(_,{name:"chat-upload"})],2)]),_:1}),c($,null,{content:v(()=>[C(d(a(h).chatToPic),1)]),default:v(()=>[n("span",{class:w(["question-icon",a(f)?"isPreventClick":""]),onClick:ze},[c(_,{name:"chat-download"})],2)]),_:1}),c($,null,{content:v(()=>[C(d(a(h).clearChat),1)]),default:v(()=>[n("span",{class:w(["question-icon",a(f)?"isPreventClick":""]),onClick:Oe},[c(_,{name:"chat-delete"})],2)]),_:1}),c($,null,{content:v(()=>[C(d(a(h).modelSettingTitle),1)]),default:v(()=>[n("span",{class:"question-icon",onClick:s[1]||(s[1]=t=>Pe(!0))},[c(_,{name:"chat-setting"})])]),_:1}),c(o,{type:"primary",disabled:a(f),shape:"circle",onClick:H},{default:v(()=>[c(_,{name:"sendplane"})]),_:1},8,["disabled"])])])])])]))]),c(us),c(as,{content:a(A),"confirm-loading":a(Q),onOk:Ae},null,8,["content","confirm-loading"])],64)}}}),Dt=pe(ut,[["__scopeId","data-v-b076070d"]]);export{Dt as default};
