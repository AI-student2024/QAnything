import{d as e,a0 as a,a as l,r as t,o as s,z as n,L as i,D as o,c,G as u,T as r,N as d,U as v,E as p,J as m,K as f,y as h,e as g,A as k,F as y,M as _,C as w,H as x,a2 as b,B as C,Q as S,R as j,V as D,a5 as T,O as L,Z as F,$ as I}from"./index-XFSJnQA8.js";import{u as q,a as B,b as U,D as O,f as K,h as E,C as M,c as R,T as z,_ as A,d as N}from"./ChatInfoPanel-BLaqnlFp.js";import{_ as P}from"./scroll-down-Dm5D91pw.js";import{a as H,u as Q,b as V}from"./useChatSource-UNzIihme.js";import{g as $,u as J}from"./index-QxdYnEqj.js";import{f as W,p as G,r as Z,u as X,a as Y,b as ee,C as ae}from"./utils-BazlbssD.js";import{u as le}from"./useQuickStart-BYVbjAoR.js";import{u as te,a as se,c as ne,p as ie}from"./useUploadFiles-DkyoZaiN.js";import{L as oe,_ as ce,F as ue,O as re}from"./OptionList-btd985mb.js";import{_ as de}from"./ActionButton-Bb8A1Lwz.js";import{_ as ve}from"./index-B1MhNjnP.js";import"./index-C-ZzOSKu.js";import"./class-CSb3T_eq.js";import"./collapseMotion-C9RdmJHL.js";import"./slide-Cs6oHcOu.js";import"./index-DxOe7nEl.js";import"./index-BdE43Btm.js";import"./index-BKqeJmg4.js";import"./index-CNtf2ifb.js";import"./injectionKey-BS_bSTfS.js";const pe={class:"contain"},me={key:0,class:"loading"},fe={key:1,class:"progress"},he={class:"file-name"},ge={key:0,class:"file-extension"},ke={key:1,class:"file-extension"},ye=f(e({__name:"FileBlock",props:{fileData:{},kbId:{},status:{}},emits:["deleteFile"],setup(e,{emit:f}){const{setChatSourceVisible:h,setSourceType:g,setSourceUrl:k,setTextContent:y}=H(),_=f,w=e,{fileData:x,kbId:b}=a(w),C=l((()=>"gray"===D.value)),S=l((()=>G(x.value.file_name))),j=l((()=>"red"===D.value?"file-error":"green"===D.value?"file-"+T.get(S.value.fileExtension):"file-unknown")),D=l((()=>x.value.status)),T=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]),L=new Map([["gray","上传中"],["yellow","解析中"],["green","解析成功"],["red","解析失败"]]),F=t(0),I=async()=>{_("deleteFile",x.value.file_id,b.value)};s((()=>{(()=>{let e=t(null);e.value=setInterval((async()=>{var a,l,t;if(""===x.value.file_id&&"loading"!==x.value.status&&(x.value.status="red"),"green"===x.value.status||"red"===x.value.status)clearInterval(e.value),e.value=null;else{const e=await Z(await X.fileList({kb_id:b.value,file_id:x.value.file_id}));x.value.status=(null==(a=e.details[0])?void 0:a.status)||"red","yellow"===(null==(l=e.details[0])?void 0:l.status)&&(F.value=parseInt(null==(t=e.details[0])?void 0:t.msg.match(/\d+/)[0],10))}}),1e3)})()}));const q=()=>{"yellow"===D.value||"green"===D.value?U(x.value):m.warn("解析中、解析完成才可以预览")};let B=["pdf","docx","xlsx","txt","md","jpg","png","jpeg"];const U=e=>{(e=>{if(!e)return!1;const a=e.split(".");if(a.length){const e=a.pop();return B.includes(e)}return!1})(e.file_name)&&async function(e){try{k(null);const a=await Z(await X.getFile({file_id:e.file_id})),l=e.file_name.split(".").pop(),t=function(e){const a=B.indexOf(e);return O[a]}(l);if(g(l),k(`data:${t};base64,${a.file_base64}`),"txt"===l||"md"===l){const e=atob(a.file_base64),l=decodeURIComponent(escape(e));y(l),h(!0)}else h(!0)}catch(a){m.error(a.msg||"获取文件失败")}}(e)};let O=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/markdown","image/jpeg","image/png","image/jpeg"];return(e,a)=>{const l=ce;return n(),i("div",pe,[o("div",{class:"file-icon",onClick:q},[c(r,{name:u(j)},null,8,["name"]),o("div",{class:d(u(C)||"yellow"===u(D)?"mask":"")},null,2),u(C)?(n(),i("div",me,[c(oe)])):v("",!0),"yellow"===u(D)?(n(),i("div",fe,[c(l,{type:"circle",percent:u(F),size:25},null,8,["percent"])])):v("",!0)]),o("div",{class:"file-info",onClick:q},[o("span",he,p(u(S).fileName),1),"green"===u(D)?(n(),i("span",ge,p(u(S).fileExtension.toUpperCase())+", "+p(u(W)(u(x).bytes)||0),1)):(n(),i("span",ke,p(u(L).get(u(D))),1))]),"toBeSend"===e.status?(n(),i("div",{key:0,class:"file-close",onClick:I},[c(r,{name:"close"})])):v("",!0)])}}}),[["__scopeId","data-v-9a48aea2"]]),_e=e=>(F("data-v-5e3cc537"),e=e(),I(),e),we={class:"container"},xe={key:1,class:"my-page"},be={key:0,class:"user"},Ce=_e((()=>o("img",{class:"avatar",src:A,alt:"头像"},null,-1))),Se={class:"question-inner"},je={class:"question-text"},De={key:0,class:"file-list-box"},Te={key:1,class:"ai"},Le=_e((()=>o("img",{class:"avatar",src:N,alt:"头像"},null,-1))),Fe={class:"ai-content"},Ie={class:"ai-right"},qe={key:0},Be={key:1},Ue={class:"source-list"},Oe={class:"control"},Ke={class:"tips"},Ee=["href"],Me=["onClick"],Re={class:"source-content"},ze={class:"score"},Ae={class:"tips"},Ne={key:1,class:"feed-back"},Pe=["onClick"],He={class:"reload-text"},Qe={class:"tools"},Ve={key:0,class:"stop-btn"},$e={class:"question-box"},Je={class:"question"},We={key:0,class:"file-list-box"},Ge={class:"send-box"},Ze={class:"send-action"},Xe=f(e({__name:"index",setup(e){const{common:a,home:f}=$(),{copy:F}=q(),{QA_List:I,chatId:A,kbId:N,kbIdCopy:W,showLoading:G}=h(le()),{addHistoryList:oe,updateHistoryList:ce,addChatList:pe,clearChatList:me,getHistoryById:fe,renameHistory:he,addFileToBeSendList:ge}=le(),{setChatSourceVisible:ke,setSourceType:_e,setSourceUrl:Xe,setTextContent:Ye}=H(),{chatSettingFormActive:ea}=h(Q()),{showDefault:aa}=h(te()),{setModalVisible:la,setModalTitle:ta}=se(),{uploadFileListQuick:sa}=h(ne()),{initUploadFileListQuick:na}=ne(),{language:ia}=h(J()),oa=l((()=>fe(A.value))),ca=new z((e=>{e&&(I.value[I.value.length-1].answer+=e||"")})),ua=t(""),ra=l((()=>{const e=ea.value.context;if(0===e)return[];const a=I.value.filter((e=>"ai"===e.type));return(1===e?a:a.slice(-e)).map((e=>[e.question,e.answer]))})),da=t([]);let va;const pa=t(null),ma=t(null),fa=()=>{b((()=>{var e;null==(e=ma.value)||e.scrollIntoView({behavior:"smooth",block:"end"})}))},ha=l((()=>{var e;return((null==(e=oa.value)?void 0:e.fileToBeSendList.concat(null==sa?void 0:sa.value))||[]).filter((e=>0!==e.file_id.length))}));s((()=>{W.value&&(N.value=W.value),fa()})),g((()=>{ga()}));const ga=()=>{sa.value.length&&(ge(A.value,[...sa.value]),na())};window.addEventListener("beforeunload",ga);const ka=e=>{13===e.keyCode&&(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey?ua.value+="\n":Ca(),e.preventDefault())},ya=B(((e,a)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){a.target.parentNode.style.animation="shake ease-in .5s";const e=setTimeout((()=>{clearTimeout(e),a.target.parentNode.style.animation=""}),600)}}),800),_a=async(e,a)=>{try{await Z(await X.deleteFile({file_ids:[e],kb_id:a})),m.success("删除成功");const l=sa.value.findIndex((a=>a.file_id===e));-1!==l?sa.value.splice(l,1):oa.value.fileToBeSendList=oa.value.fileToBeSendList.filter((a=>a.file_id!==e))}catch(l){m.error(l.msg||"删除失败")}},wa=e=>{I.value.push({answer:"",question:e,onlySearch:ea.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},xa=new ae,ba=()=>{va&&va.abort(),ca.done(),G.value=!1,I.value[I.value.length-1].showTools=!0},Ca=async()=>{if(!ua.value.trim().length)return;if(G.value)return void m.warn("正在聊天中...请等待结束");if(!(await Ua()))return void m.error("模型设置错误，请先检查模型配置");const e=ua.value;await(async e=>{try{if(null!==A.value)return void("未命名对话"===fe(A.value).title&&he(A.value,e));e.length>100&&(e=e.substring(0,100));const a=await Z(await X.createKb({kb_name:e}));N.value=a.kb_id,A.value=oe(e),ce(e,A.value,N.value)}catch(a){m.error(a.msg||"创建对话失败")}})(e),ua.value="",(e=>{I.value.push({question:e,type:"user",fileDataList:[...ha.value.filter((e=>"red"!==e.status))]}),fa()})(e),pe(A.value,I.value),na(),oa.value.fileToBeSendList=[],G.value=!0,va=new AbortController;const l={kb_ids:[N.value],history:ra.value,question:e,streaming:!1===ea.value.capabilities.onlySearch,networking:ea.value.capabilities.networkSearch,product_source:"saas",rerank:ea.value.capabilities.rerank,only_need_search_results:ea.value.capabilities.onlySearch,hybrid_search:ea.value.capabilities.mixedSearch,max_token:ea.value.maxToken,api_base:ea.value.apiBase,api_key:ea.value.apiKey,model:ea.value.apiModelName,api_context_length:ea.value.apiContextLength,chunk_size:ea.value.chunkSize,top_p:ea.value.top_P,top_k:ea.value.top_K,temperature:ea.value.temperature};if(ea.value.capabilities.onlySearch){xa.addChatSetting(ea.value),wa(e);try{const e=await Z(await X.sendQuestion(l));200===e.code&&(I.value[I.value.length-1].answer=(null==e?void 0:e.source_documents.length)?a.searchCompleted:a.searchNotFound,I.value[I.value.length-1].source=null==e?void 0:e.source_documents)}catch(t){m.error(t.msg||"出错了"),I.value[I.value.length-1].answer=t||"error"}G.value=!1,I.value[I.value.length-1].showTools=!0,pe(A.value,I.value),await b((()=>{fa()}))}else K(ee+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:Y,...l}),signal:va.signal,onopen(a){wa(e),a.ok&&"text/event-stream"===a.headers.get("content-type")?(xa.addChatSetting(ea.value),ca.start()):"application/json"===a.headers.get("content-type")&&ca.add("Error 请检查模型是否配置正确")},onmessage(e){var a,l;const t=JSON.parse(e.data);if(200==(null==t?void 0:t.code)&&(null==t?void 0:t.response)&&"success"===t.msg)ca.add(null==t?void 0:t.response),fa();else{delete t.time_record.time_usage.retriever_search_by_milvus,xa.addTime(t.time_record.time_usage),xa.addToken(t.time_record.token_usage),xa.addDate(Date.now())}(null==(a=null==t?void 0:t.source_documents)?void 0:a.length)&&(I.value[I.value.length-1].source=null==t?void 0:t.source_documents),(null==(l=null==t?void 0:t.show_images)?void 0:l.length)&&(null==t||t.show_images.map((e=>{ca.add(e)})))},onclose(e){ca.done(),va.abort(),G.value=!1,I.value[I.value.length-1].showTools=!0,I.value.at(-1).itemInfo=xa.getChatInfo(),pe(A.value,I.value),b((()=>{fa()}))},onerror(e){throw null==ca||ca.done(),null==va||va.abort(),G.value=!1,I.value[I.value.length-1].showTools=!0,m.error(e.msg||"出错了"),pe(A.value,I.value),b((()=>{fa()})),e}})},{showModal:Sa}=h(U()),ja=t(!1),Da=t(""),Ta=t(""),La=()=>{G.value||N.value&&(la(!0),ta(f.upload))},Fa=()=>{G.value||(Ta.value="download",Sa.value=!0,Da.value=a.saveTip)},Ia=async()=>{if(ja.value=!0,"download"===Ta.value)try{const e=document.getElementById("chat-ul"),a=(await E(e,{useCORS:!0})).toDataURL("image/png"),l=document.createElement("a");l.style.display="none",l.href=a,l.setAttribute("download","chat-shot.png"),void 0===l.download&&l.setAttribute("target","_blank"),document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(a),m.success("下载成功"),await Promise.resolve()}catch(e){m.error(e.message||e.msg||"出错了")}else"delete"===Ta.value&&(me(A.value),A.value=null,I.value=[]);Ta.value="",Da.value="",ja.value=!1,Sa.value=!1},{showSettingModal:qa}=h(U()),Ba=t(),Ua=()=>Ba.value.handleOk();let Oa=["pdf","docx","xlsx","txt","md","jpg","png","jpeg","csv","eml"];const Ka=e=>{if(!e)return!1;const a=e.split(".");if(a.length){const e=a.pop();return Oa.includes(e)}return!1},Ea=e=>{Ka(e.file_name)&&async function(e){try{Xe(null);const a=await Z(await X.getFile({file_id:e.file_id})),l=e.file_name.split(".").pop(),t=function(e){const a=Oa.indexOf(e);return Ma[a]}(l);if(_e(l),Xe(`data:${t};base64,${a.file_base64}`),"txt"===l||"md"===l||"csv"===l||"eml"===l){const e=atob(a.file_base64),l=decodeURIComponent(escape(e));Ye(l),ke(!0)}else ke(!0)}catch(a){m.error(a.msg||"获取文件失败")}}(e)};let Ma=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/markdown","image/jpeg","image/png","image/jpeg","text/csv","message/rfc822","application/vnd.openxmlformats-officedocument.presentationml.presentation"];g((()=>{Ra()}));const Ra=()=>{W.value=N.value,N.value=""};return window.addEventListener("onbeforeunload",Ra),(e,l)=>{const t=C,s=de,f=ve;return n(),i(y,null,[o("div",we,[u(aa)===u(ie).optionlist?(n(),k(re,{key:0})):(n(),i("div",xe,[o("div",{id:"chat",ref_key:"chatContainer",ref:pa,class:"chat"},[o("ul",{id:"chat-ul",ref_key:"scrollDom",ref:ma},[(n(!0),i(y,null,_(u(I),((e,l)=>{var t,s;return n(),i("li",{key:l},["user"===e.type?(n(),i("div",be,[Ce,o("div",Se,[o("p",je,p(e.question),1),e.fileDataList.length?(n(),i("div",De,[(n(!0),i(y,null,_(e.fileDataList,(e=>(n(),k(ye,{key:e.file.lastModified,"file-data":e,"kb-id":u(N),"chat-id":u(A),status:"send"},null,8,["file-data","kb-id","chat-id"])))),128))])):v("",!0)])])):(n(),i("div",Te,[Le,o("div",Fe,[o("div",Ie,[o("p",{class:d(["question-text",[e.source.length||(null==(t=null==e?void 0:e.picList)?void 0:t.length)?"":"change-radius",e.showTools?"":"flashing"]])},[c(V,{content:e.answer},null,8,["content"]),Object.keys((null==(s=null==e?void 0:e.itemInfo)?void 0:s.tokenInfo)||{}).length?(n(),k(M,{key:0,"chat-item-info":e.itemInfo},null,8,["chat-item-info"])):v("",!0)],2),e.source.length?(n(),i(y,{key:0},[o("div",{class:d(["source-total",u(da).includes(l)?"":"source-total-last"])},["zh"===u(ia)?(n(),i("span",qe," 找到了"+p(e.source.length)+"个信息来源： ",1)):(n(),i("span",Be," Found "+p(e.source.length)+" source of information ",1)),S(c(r,{name:"down",onClick:e=>(e=>{da.value.push(e)})(l)},null,8,["onClick"]),[[j,!u(da).includes(l)]]),S(c(r,{name:"up",onClick:e=>(e=>{da.value=da.value.filter((a=>a!==e))})(l)},null,8,["onClick"]),[[j,u(da).includes(l)]])],2),S(o("div",Ue,[(n(!0),i(y,null,_(e.source,((l,t)=>(n(),i("div",{key:t,class:"data-source"},[S(o("p",Oe,[o("span",Ke,p(u(a).dataSource)+p(t+1)+":",1),l.file_url.startsWith("http")?(n(),i("a",{key:0,href:l.file_url,target:"_blank"},p(l.file_name),9,Ee)):(n(),i("span",{key:1,class:d(["file",Ka(l.file_name)?"filename-active":""]),onClick:e=>Ea(l)},p(l.file_name),11,Me)),S(c(r,{name:"iconup",onClick:a=>((e,a)=>{e.source[a].showDetailDataSource=!1})(e,t)},null,8,["onClick"]),[[j,l.showDetailDataSource]]),S(c(r,{name:"icondown",onClick:a=>((e,a)=>{e.source[a].showDetailDataSource=!e.source[a].showDetailDataSource})(e,t)},null,8,["onClick"]),[[j,!l.showDetailDataSource]])],512),[[j,l.file_name]]),c(T,{name:"sourceItem"},{default:w((()=>[S(o("div",Re,[c(V,{content:l.content},null,8,["content"]),o("p",ze,[o("span",Ae,p(u(a).correlation),1),D(" "+p(l.score),1)])],512),[[j,l.showDetailDataSource]])])),_:2},1024)])))),128))],512),[[j,u(da).includes(l)]])],64)):v("",!0),e.showTools?(n(),i("div",Ne,[o("div",{class:"reload-box",onClick:a=>(e=>{ua.value=e.question,Ca()})(e)},[c(r,{name:"reload"}),o("span",He,p(u(a).regenerate),1)],8,Pe),o("div",Qe,[c(r,{style:L({color:e.copied?"#4D71FF":""}),name:"copy",onClick:l=>(e=>{F(e.answer).then((()=>{e.copied=!e.copied,m.success(a.copySuccess,1);const l=setTimeout((()=>{clearTimeout(l),e.copied=!e.copied}),1e3)})).catch((()=>{m.error(a.copyFailed,1)}))})(e)},null,8,["style","onClick"]),c(r,{style:L({color:e.like?"#4D71FF":""}),name:"like",onClick:a=>u(ya)(e,a)},null,8,["style","onClick"]),c(r,{style:L({color:e.unlike?"#4D71FF":""}),name:"unlike",onClick:a=>(e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])})(e)},null,8,["style","onClick"])])])):v("",!0)])])]))])})),128))],512)],512),u(G)?(n(),i("div",Ve,[c(t,{onClick:ba},{icon:w((()=>[c(r,{name:"stop",class:d(u(G)?"loading":"")},null,8,["class"])])),default:w((()=>[D(" "+p(u(a).stop),1)])),_:1})])):v("",!0),o("div",$e,[o("div",Je,[u(ha).length?(n(),i("div",We,[(n(!0),i(y,null,_(u(ha),(e=>(n(),k(ye,{key:e.file_id,"file-data":e,"kb-id":u(N),"chat-id":u(A),status:"toBeSend",onDeleteFile:_a},null,8,["file-data","kb-id","chat-id"])))),128))])):v("",!0),o("div",Ge,[c(s,{value:u(ua),"onUpdate:value":l[0]||(l[0]=e=>x(ua)?ua.value=e:null),class:"send-textarea","max-length":"200",bordered:!1,placeholder:u(a).problemPlaceholder,"auto-size":{minRows:1,maxRows:8},onKeydown:ka},null,8,["value","placeholder"]),o("div",Ze,[c(f,null,{content:w((()=>[D(p(u(N)?u(a).chatUpload:u(a).chatUploadNoKbId),1)])),default:w((()=>[o("span",{class:d(["question-icon",u(G)||!u(N)?"isPreventClick":""]),onClick:La},[c(r,{name:"chat-upload"})],2)])),_:1}),c(f,null,{content:w((()=>[D(p(u(a).chatToPic),1)])),default:w((()=>[o("span",{class:d(["question-icon",u(G)?"isPreventClick":""]),onClick:Fa},[c(r,{name:"chat-download"})],2)])),_:1}),c(f,null,{content:w((()=>[D(p(u(a).modelSettingTitle),1)])),default:w((()=>[o("span",{class:"question-icon",onClick:l[1]||(l[1]=e=>{return a=!0,void(qa.value=a);var a})},[c(r,{name:"chat-setting"})])])),_:1}),c(t,{type:"primary",disabled:u(G),shape:"circle",onClick:Ca},{default:w((()=>[c(r,{name:"sendplane"})])),_:1},8,["disabled"])])])])]),c(ue,{"dialog-type":1})])),o("div",{class:"scroll-btn-div"},[o("img",{class:"avatar",src:P,alt:"滑到底部",onClick:fa})])]),c(R,{ref_key:"chatSettingForDialogRef",ref:Ba},null,512),c(O,{content:u(Da),"confirm-loading":u(ja),onOk:Ia},null,8,["content","confirm-loading"])],64)}}}),[["__scopeId","data-v-5e3cc537"]]);export{Xe as default};
