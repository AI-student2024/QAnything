import{d as Ce,$ as at,a as H,o as oe,A as n,B as i,c as l,G as s,W as v,X as w,C as c,J as d,r as D,N as we,z as B,O as Q,F as E,D as te,K as m,Q as st,a2 as ae,R as C,a4 as ot,E as x,H as T,T as I,U as M,a3 as nt,S as se,L as lt,M as ct}from"./index-BmCpu3aX.js";import{u as it,b as rt,_ as ut,a as dt}from"./useChatSource-Ct8ZfR7q.js";import{u as pt,a as ht,b as me,D as _t,f as ft,h as vt,T as gt,_ as mt}from"./html2canvas.esm-tBO9NWBt.js";import{_ as kt,C as yt}from"./HighLightMarkDown.vue_vue_type_style_index_0_lang-CoQFcd4t.js";import{g as Ct,u as wt}from"./index-BuoR8LFG.js";import{f as bt,p as St,r as ne,u as le,a as xt,b as Tt,C as Dt}from"./utils-QvmHLhCR.js";import{u as ke}from"./useQuickStart-CJdVSd6L.js";import{L as Lt,a as ye,C as Ft,b as qt,F as $t,O as Bt}from"./OptionList-Crrjmppv.js";import{u as It,a as Mt,p as Nt}from"./icon-loading-DmogqWCf.js";import{u as Ut}from"./useChatSetting-L4m0xpHA.js";import{B as jt}from"./RightOutlined-vt2WRkOT.js";import"./slide-CMPzkUn6.js";import"./collapseMotion-ftRCz4Z8.js";import"./index-GBhCQPyN.js";import"./index-BNxGScwJ.js";import"./injectionKey-DGYNie3Z.js";const zt={class:"contain"},Ot={key:0,class:"loading"},Pt={class:"file-info"},Rt={class:"file-name"},At={key:0,class:"file-extension"},Et={key:1,class:"file-extension"},Ht=Ce({__name:"FileBlock",props:{fileData:{},kbId:{}},setup(N){const f=N,{fileData:k,kbId:J}=at(f),r=H(()=>p.value!=="green"&&p.value!=="red");oe(()=>{console.log("00---fileData0",k.value)});const g=H(()=>St(k.value.file_name)),y=H(()=>p.value!=="green"?"file-unknown":"file-"+W.get(g.value.fileExtension)),p=H(()=>k.value.status),W=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]),G=new Map([["gray","上传中"],["yellow","解析中"],["green","解析成功"],["red","上传失败"]]),z=()=>{let U=D(null);U.value=setInterval(async()=>{if(console.log("setinterval",k.value),k.value.status==="green"||k.value.status==="red")clearInterval(U.value),U.value=null;else{const O=await ne(await le.fileList({kb_id:J.value,file_id:k.value.file_id}));console.log(O),k.value.status=O.details[0].status}},5e3)};return oe(()=>{z()}),(U,O)=>(n(),i("div",zt,[l(v,{name:s(y)},null,8,["name"]),s(r)?(n(),i("div",Ot,[l(Lt)])):w("",!0),c("div",Pt,[c("span",Rt,d(s(g).fileName),1),s(p)==="green"?(n(),i("span",At,d(s(g).fileExtension.toUpperCase())+", "+d(s(bt)(s(k).file.size)||0),1)):(n(),i("span",Et,d(s(G).get(s(p))),1))])]))}}),Kt=we(Ht,[["__scopeId","data-v-ff217fdc"]]),be=N=>(lt("data-v-aaea1310"),N=N(),ct(),N),Vt={class:"container"},Qt={key:1,class:"my-page"},Jt={key:0,class:"user"},Wt=be(()=>c("img",{class:"avatar",src:dt,alt:"头像"},null,-1)),Gt={class:"question-text"},Xt={key:1,class:"ai"},Yt=be(()=>c("img",{class:"avatar",src:mt,alt:"头像"},null,-1)),Zt={class:"ai-content"},ea={class:"ai-right"},ta={key:1},aa={key:0},sa={key:1},oa={key:0},na={key:0},la={key:1},ca={key:0},ia={class:"source-list"},ra={class:"control"},ua={class:"tips"},da=["href"],pa=["onClick"],ha={class:"source-content"},_a=["innerHTML"],fa={class:"score"},va={class:"tips"},ga={key:3,class:"feed-back"},ma=["onClick"],ka={class:"reload-text"},ya={class:"tools"},Ca={key:0,class:"stop-btn"},wa={class:"question-box"},ba={class:"question"},Sa={key:0,class:"file-list-box"},xa={class:"send-box"},Ta={class:"send-action"},Da=Ce({__name:"index",setup(N){const{common:f,home:k}=Ct(),{copy:J}=pt(),{QA_List:r,chatId:g,kbId:y,showLoading:p}=B(ke()),{addHistoryList:W,updateHistoryList:G,addChatList:z,clearChatList:U,getHistoryById:O,renameHistory:Se}=ke(),{setChatSourceVisible:ce,setSourceType:xe,setSourceUrl:ie,setTextContent:Te}=it(),{chatSettingFormActive:h}=B(Ut()),{showDefault:De}=B(It()),{setModalVisible:Le,setModalTitle:Fe}=Mt(),{uploadFileList:re}=B(ye()),{initUploadFileList:qe}=ye(),{language:ue}=B(wt()),L=new gt(e=>{e&&(r.value[r.value.length-1].answer+=e||"")}),F=D(""),$e=H(()=>{const e=h.value.context;if(e===0)return[];const t=r.value.filter(u=>u.type==="ai");return(e===1?t:t.slice(-e)).map(u=>[u.question,u.answer])}),q=D([]);let b;const Be=D(null),de=D(null),j=()=>{ae(()=>{var e;(e=de.value)==null||e.scrollIntoView({behavior:"smooth",block:"end"})})};oe(()=>{j()});const Ie=ht((e,t)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){t.target.parentNode.style.animation="shake ease-in .5s";const o=setTimeout(()=>{clearTimeout(o),t.target.parentNode.style.animation=""},600)}},800),Me=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},Ne=e=>{J(e.answer).then(()=>{e.copied=!e.copied,C.success(f.copySuccess,1);const t=setTimeout(()=>{clearTimeout(t),e.copied=!e.copied},1e3)}).catch(()=>{C.error(f.copyFailed,1)})},Ue=e=>{r.value.push({question:e,type:"user"}),j()},pe=e=>{r.value.push({answer:"",question:e,onlySearch:h.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},P=new Dt,je=()=>{b&&b.abort(),L.done(),p.value=!1,r.value[r.value.length-1].showTools=!0},ze=async e=>{try{if(g.value!==null){O(g.value).title==="未命名对话"&&Se(g.value,e);return}e.length>100&&(e=e.substring(0,100));const t=await ne(await le.createKb({kb_name:e}));y.value=t.kb_id,g.value=W(e),G(e,g.value,y.value)}catch(t){C.error(t.msg||"创建对话失败")}},X=async()=>{if(!F.value.trim().length)return;if(p.value){C.warn("正在聊天中...请等待结束");return}if(!Ge()){C.error("模型设置错误，请先检查模型配置");return}qe();const e=F.value;await ze(e),F.value="",Ue(e),z(g.value,r.value),p.value=!0,b=new AbortController,ft(Tt+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:xt,kb_ids:[y.value],history:$e.value,question:e,streaming:h.value.capabilities.onlySearch===!1,networking:h.value.capabilities.networkSearch,product_source:"saas",rerank:h.value.capabilities.rerank,only_need_search_results:h.value.capabilities.onlySearch,hybrid_search:h.value.capabilities.mixedSearch,max_token:h.value.maxToken,api_base:h.value.apiBase,api_key:h.value.apiKey,model:h.value.apiModelName,api_context_length:h.value.apiContextLength,chunk_size:h.value.chunkSize,top_p:h.value.top_P,temperature:h.value.temperature}),signal:b.signal,async onopen(t){console.log("eee",t),P.addChatSetting(h.value),t.ok&&t.headers.get("content-type")==="text/event-stream"?(pe(e),L.start()):t.headers.get("content-type")==="application/json"&&(console.log("ssss"),pe(e))},onmessage(t){var u;console.log("onmessage",t);const o=JSON.parse(t.data);if((o==null?void 0:o.code)==200&&(o!=null&&o.response)&&o.msg==="success")L.add(o==null?void 0:o.response),j();else{const S=o.time_record.time_usage;delete S.retriever_search_by_milvus,P.addTime(o.time_record.time_usage),P.addToken(o.time_record.token_usage),P.addDate(Date.now())}(u=o==null?void 0:o.source_documents)!=null&&u.length&&(r.value[r.value.length-1].source=o==null?void 0:o.source_documents)},onclose(){console.log("onclose"),L.done(),b.abort(),p.value=!1,r.value[r.value.length-1].showTools=!0,r.value.at(-1).itemInfo=P.getChatInfo(),z(g.value,r.value),ae(()=>{j()})},onerror(t){throw console.log("onerror",t),L==null||L.done(),b==null||b.abort(),p.value=!1,r.value[r.value.length-1].showTools=!0,C.error(t.msg||"出错了"),z(g.value,r.value),ae(()=>{j()}),t}})},Oe=e=>{F.value=e.question,X()},Pe=(e,t)=>{e.source[t].showDetailDataSource=!e.source[t].showDetailDataSource},Re=(e,t)=>{e.source[t].showDetailDataSource=!1},Ae=e=>{q.value.push(e)},Ee=e=>{q.value=q.value.filter(t=>t!==e)},{showModal:Y}=B(me()),Z=D(!1),K=D(""),R=D(""),He=()=>{y.value&&(Le(!0),Fe(k.upload))},Ke=()=>{p.value||(R.value="download",Y.value=!0,K.value=f.saveTip)},Ve=()=>{p.value||(R.value="delete",Y.value=!0,K.value=f.clearTip)},Qe=async()=>{if(Z.value=!0,R.value==="download")try{const e=document.getElementById("chat-ul"),o=(await vt(e,{useCORS:!0})).toDataURL("image/png"),u=document.createElement("a");u.style.display="none",u.href=o,u.setAttribute("download","chat-shot.png"),typeof u.download>"u"&&u.setAttribute("target","_blank"),document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(o),C.success("下载成功"),await Promise.resolve()}catch(e){C.error(e.message||e.msg||"出错了")}else R.value==="delete"&&(U(g.value),g.value=null,r.value=[]);R.value="",K.value="",Z.value=!1,Y.value=!1},{showSettingModal:Je}=B(me()),We=e=>{Je.value=e},Ge=()=>!!(h.value.apiKey&&h.value.apiBase&&h.value.apiModelName);let he=["pdf","docx","xlsx","txt","jpg","png","jpeg"];const _e=e=>{if(!e)return!1;const t=e.split(".");if(t.length){const o=t.pop();return he.includes(o)}else return!1},Xe=e=>{_e(e.file_name)&&Ye(e)};async function Ye(e){try{ie(null);const t=await ne(await le.getFile({file_id:e.file_id})),o=e.file_name.split(".").pop(),u=et(o);if(xe(o),ie(`data:${u};base64,${t.base64_content}`),o==="txt"){const S=atob(t.base64_content),ee=decodeURIComponent(escape(S));Te(ee),ce(!0)}else ce(!0)}catch(t){C.error(t.msg||"获取文件失败")}}let Ze=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","image/jpeg","image/png","image/jpeg"];function et(e){const t=he.indexOf(e);return Ze[t]}return(e,t)=>{const o=jt,u=rt,S=ut,ee=$t,tt=ot;return n(),i(E,null,[c("div",Vt,[s(De)===s(Nt).optionlist?(n(),Q(Bt,{key:0})):(n(),i("div",Qt,[c("div",{id:"chat",ref_key:"chatContainer",ref:Be,class:"chat"},[c("ul",{id:"chat-ul",ref_key:"scrollDom",ref:de},[(n(!0),i(E,null,te(s(r),(a,$)=>{var fe,ve,ge;return n(),i("li",{key:$},[a.type==="user"?(n(),i("div",Jt,[Wt,c("p",Gt,d(a.question),1)])):(n(),i("div",Xt,[Yt,c("div",Zt,[c("div",ea,[a.onlySearch?a.onlySearch&&!a.source.length?(n(),i("p",{key:1,class:x(["question-text",[!a.source.length&&!((ge=a==null?void 0:a.picList)!=null&&ge.length)?"change-radius":"",a.showTools?"":"flashing"]])},[s(ue)==="zh"?(n(),i("span",aa,"未找到信息来源")):(n(),i("span",sa,"Information source not found"))],2)):w("",!0):(n(),i("p",{key:0,class:x(["question-text",[!a.source.length&&!((fe=a==null?void 0:a.picList)!=null&&fe.length)?"change-radius":"",a.showTools?"":"flashing"]])},[a.answer?(n(),Q(kt,{key:0,content:a.answer},null,8,["content"])):(n(),i("span",ta,d(a.answer),1)),Object.keys(((ve=a==null?void 0:a.itemInfo)==null?void 0:ve.tokenInfo)||{}).length?(n(),Q(yt,{key:2,"chat-item-info":a.itemInfo},null,8,["chat-item-info"])):w("",!0)],2)),a.source.length?(n(),i(E,{key:2},[c("div",{class:x(["source-total",s(q).includes($)?"":"source-total-last"])},[s(ue)==="zh"?(n(),i("span",oa,[a.onlySearch?(n(),i("span",na,"检索完成，")):w("",!0),T(" 找到了"+d(a.source.length)+"个信息来源： ",1)])):(n(),i("span",la,[a.onlySearch?(n(),i("span",ca,"Search completed，")):w("",!0),T(" Found "+d(a.source.length)+" source of information ",1)])),I(l(v,{name:"down",onClick:_=>Ae($)},null,8,["onClick"]),[[M,!s(q).includes($)]]),I(l(v,{name:"up",onClick:_=>Ee($)},null,8,["onClick"]),[[M,s(q).includes($)]])],2),I(c("div",ia,[(n(!0),i(E,null,te(a.source,(_,V)=>(n(),i("div",{key:V,class:"data-source"},[I(c("p",ra,[c("span",ua,d(s(f).dataSource)+d(V+1)+":",1),_.file_id.startsWith("http")?(n(),i("a",{key:0,href:_.file_id,target:"_blank"},d(_.file_name),9,da)):(n(),i("span",{key:1,class:x(["file",_e(_.file_name)?"filename-active":""]),onClick:A=>Xe(_)},d(_.file_name),11,pa)),I(l(v,{name:"iconup",onClick:A=>Re(a,V)},null,8,["onClick"]),[[M,_.showDetailDataSource]]),I(l(v,{name:"icondown",onClick:A=>Pe(a,V)},null,8,["onClick"]),[[M,!_.showDetailDataSource]])],512),[[M,_.file_name]]),l(nt,{name:"sourceItem"},{default:m(()=>{var A;return[I(c("div",ha,[c("p",{innerHTML:(A=_.content)==null?void 0:A.replaceAll(`
`,"<br/>")},null,8,_a),c("p",fa,[c("span",va,d(s(f).correlation),1),T(d(_.score),1)])],512),[[M,_.showDetailDataSource]])]}),_:2},1024)]))),128))],512),[[M,s(q).includes($)]])],64)):w("",!0),a.showTools?(n(),i("div",ga,[c("div",{class:"reload-box",onClick:_=>Oe(a)},[l(v,{name:"reload"}),c("span",ka,d(s(f).regenerate),1)],8,ma),c("div",ya,[l(v,{style:se({color:a.copied?"#4D71FF":""}),name:"copy",onClick:_=>Ne(a)},null,8,["style","onClick"]),l(v,{style:se({color:a.like?"#4D71FF":""}),name:"like",onClick:_=>s(Ie)(a,_)},null,8,["style","onClick"]),l(v,{style:se({color:a.unlike?"#4D71FF":""}),name:"unlike",onClick:_=>Me(a)},null,8,["style","onClick"])])])):w("",!0)])])]))])}),128))],512)],512),s(p)?(n(),i("div",Ca,[l(o,{onClick:je},{icon:m(()=>[l(v,{name:"stop",class:x(s(p)?"loading":"")},null,8,["class"])]),default:m(()=>[T(" "+d(s(f).stop),1)]),_:1})])):w("",!0),c("div",wa,[c("div",ba,[s(re).length?(n(),i("div",Sa,[(n(!0),i(E,null,te(s(re),a=>(n(),Q(Kt,{key:a.file.lastModified,"file-data":a,"kb-id":s(y)},null,8,["file-data","kb-id"]))),128))])):w("",!0),c("div",xa,[l(u,{value:s(F),"onUpdate:value":t[0]||(t[0]=a=>st(F)?F.value=a:null),class:"send-textarea","max-length":"200",bordered:!1,placeholder:s(f).problemPlaceholder,"auto-size":{minRows:4,maxRows:8},onPressEnter:X},null,8,["value","placeholder"]),c("div",Ta,[l(S,null,{content:m(()=>[T(d(s(y)?s(f).chatUpload:s(f).chatUploadNoKbId),1)]),default:m(()=>[c("span",{class:x(["question-icon",s(p)||!s(y)?"isPreventClick":""]),onClick:He},[l(v,{name:"chat-upload"})],2)]),_:1}),l(S,null,{content:m(()=>[T(d(s(f).chatToPic),1)]),default:m(()=>[c("span",{class:x(["question-icon",s(p)?"isPreventClick":""]),onClick:Ke},[l(v,{name:"chat-download"})],2)]),_:1}),l(S,null,{content:m(()=>[T(d(s(f).clearChat),1)]),default:m(()=>[c("span",{class:x(["question-icon",s(p)?"isPreventClick":""]),onClick:Ve},[l(v,{name:"chat-delete"})],2)]),_:1}),l(S,null,{content:m(()=>[T(d(s(f).modelSettingTitle),1)]),default:m(()=>[c("span",{class:"question-icon",onClick:t[1]||(t[1]=a=>We(!0))},[l(v,{name:"chat-setting"})])]),_:1}),l(o,{type:"primary",disabled:s(p),shape:"circle",onClick:X},{default:m(()=>[l(v,{name:"sendplane"})]),_:1},8,["disabled"])])])])])]))]),l(Ft),l(_t,{content:s(K),"confirm-loading":s(Z),onOk:Qe},null,8,["content","confirm-loading"]),l(qt,{"dialog-type":1}),l(tt,{theme:{token:{colorPrimary:"#5a47e5"}}},{default:m(()=>[l(ee,{class:"scroll-btn",type:"primary",onClick:j},{icon:m(()=>[l(v,{name:"scroll"})]),_:1})]),_:1})],64)}}}),Ha=we(Da,[["__scopeId","data-v-aaea1310"]]);export{Ha as default};
