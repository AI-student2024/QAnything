import{d as fe,a as K,r as b,o as ve,A as n,B as c,c as i,G as a,W as v,Y as x,C as l,J as d,N as ge,z as q,O as W,F as A,D as G,K as m,Q as Ye,a5 as Xe,a3 as Y,R as y,E as C,H as S,T as $,U as M,a4 as Ze,S as X,L as et,M as tt}from"./index-CMFkO_GU.js";import{u as st,b as at,_ as ot,a as nt}from"./useChatSource-io57M7CK.js";import{u as lt,a as ct,b as ue,D as it,f as rt,h as ut,T as dt,_ as pt}from"./html2canvas.esm-kFJZZfhN.js";import{L as ht,_ as _t,C as ft,O as vt}from"./OptionList-wGWAdOdt.js";import{g as gt,u as mt}from"./index-HIZRnN-c.js";import{f as yt,p as kt,a as wt,b as Ct,r as de,u as pe}from"./utils-BMBi6enm.js";import{a as he,u as _e}from"./useQuickStart-B7nYk-yZ.js";import{u as St,a as bt,p as xt}from"./useOptiionList-A5QF3qRY.js";import{u as Tt}from"./ChatSettingForm-Csuu61xa.js";import{B as Dt}from"./RightOutlined-DYIfZQgd.js";import"./collapseMotion-of088ERU.js";import"./index-4A__t0NZ.js";import"./index-ByPLnd9i.js";import"./index-DiJaZQsu.js";import"./injectionKey-DGYNie3Z.js";import"./slide-DHFTURcp.js";const Lt={class:"contain"},Ft={key:0,class:"loading"},qt={class:"file-info"},$t={class:"file-name"},Mt={key:0,class:"file-extension"},Bt={key:1,class:"file-extension"},Nt=fe({__name:"FileBlock",props:{fileData:{}},setup(B){const{fileData:h}=B,P=K(()=>(console.log(g),g.value!=="green")),U=K(()=>kt(h.file_name)),u=K(()=>g.value!=="green"?"file-unknown":"file-"+k.get(U.value.fileExtension)),g=b(h.status),k=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]);ve(()=>{console.log(h)});const f=new Map([["gray","上传中"],["yellow","解析中"],["green","解析成功"],["red","上传失败"]]);return(V,Z)=>(n(),c("div",Lt,[i(v,{name:a(u)},null,8,["name"]),a(P)?(n(),c("div",Ft,[i(ht)])):x("",!0),l("div",qt,[l("span",$t,d(a(U).fileName),1),a(g)==="green"?(n(),c("span",Mt,d(a(U).fileExtension.toUpperCase())+", "+d(a(yt)(V.fileData.file.size)||0),1)):(n(),c("span",Bt,d(a(f).get(a(g))),1))])]))}}),Ut=ge(Nt,[["__scopeId","data-v-f9750499"]]),me=B=>(et("data-v-11978c06"),B=B(),tt(),B),Rt={class:"container"},jt={key:1,class:"my-page"},zt={key:0,class:"user"},At=me(()=>l("img",{class:"avatar",src:nt,alt:"头像"},null,-1)),Ot={class:"question-text"},Et={key:1,class:"ai"},Kt=me(()=>l("img",{class:"avatar",src:pt,alt:"头像"},null,-1)),Pt={class:"ai-content"},Vt={class:"ai-right"},Ht={key:1},It={key:0},Qt={key:1},Jt={key:0},Wt={key:0},Gt={key:1},Yt={key:0},Xt={class:"source-list"},Zt={class:"control"},es={class:"tips"},ts=["href"],ss=["onClick"],as={class:"source-content"},os=["innerHTML"],ns={class:"score"},ls={class:"tips"},cs={key:3,class:"feed-back"},is=["onClick"],rs={class:"reload-text"},us={class:"tools"},ds={key:0,class:"stop-btn"},ps={class:"question-box"},hs={class:"question"},_s={key:0,class:"file-list-box"},fs={class:"send-box"},vs={class:"send-action"},gs=fe({__name:"index",setup(B){const{common:h,home:P}=gt(),{copy:U}=lt(),{QA_List:u,chatId:g,kbId:k,showLoading:f}=q(he()),{addHistoryList:V,updateHistoryList:Z,addChatList:H,clearChatList:ye}=he(),{setChatSourceVisible:ee,setSourceType:ke,setSourceUrl:te,setTextContent:we}=st(),{chatSettingFormActive:_}=q(Tt()),{showDefault:Ce}=q(St()),{setModalVisible:Se,setModalTitle:be}=bt(),{uploadFileList:se}=q(_e()),{initUploadFileList:xe}=_e(),{language:ae}=q(mt()),T=new dt(e=>{e&&(u.value[u.value.length-1].answer+=e||"")}),D=b(""),Te=K(()=>{const e=_.value.context;if(e===0)return[];const t=u.value.filter(r=>r.type==="ai");return(e===1?t:t.slice(-e)).map(r=>[r.question,r.answer])}),L=b([]);let w;const De=b(null),oe=b(null),R=()=>{Y(()=>{var e;(e=oe.value)==null||e.scrollIntoView(!1)})};ve(()=>{R()});const Le=ct((e,t)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){t.target.parentNode.style.animation="shake ease-in .5s";const o=setTimeout(()=>{clearTimeout(o),t.target.parentNode.style.animation=""},600)}},800),Fe=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},qe=e=>{U(e.answer).then(()=>{e.copied=!e.copied,y.success(h.copySuccess,1);const t=setTimeout(()=>{clearTimeout(t),e.copied=!e.copied},1e3)}).catch(()=>{y.error(h.copyFailed,1)})},$e=e=>{u.value.push({question:e,type:"user"}),R()},ne=e=>{u.value.push({answer:"",question:e,onlySearch:_.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},Me=(e,t,o)=>{try{Z(e,t,o)}catch(r){y.error(r.msg||"更新对话失败")}},Be=()=>{w&&w.abort(),T.done(),f.value=!1,u.value[u.value.length-1].showTools=!0},Ne=async e=>{try{if(g.value!==null)return;e.length>100&&(e=e.substring(0,100));const t=await de(await pe.createKb({kb_name:e}));k.value=t.kb_id,g.value=V(e),Me(e,g.value,k.value)}catch(t){y.error(t.msg||"创建对话失败")}},I=async()=>{if(!D.value.trim().length)return;if(f.value){y.warn("正在聊天中...请等待结束");return}if(!Ie()){y.error("模型设置错误，请先检查模型配置");return}const e=D.value;await Ne(e),D.value="",$e(e),H(g.value,u.value),f.value=!0,w=new AbortController,rt(Ct+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:wt,kb_ids:[k.value],history:Te.value,question:e,streaming:_.value.capabilities.onlySearch===!1,networking:_.value.capabilities.onlineSearch,product_source:"saas",only_need_search_results:_.value.capabilities.onlySearch,hybrid_search:_.value.capabilities.mixedSearch,max_token:_.value.maxToken,api_base:_.value.apiBase,api_key:_.value.apiKey,model:_.value.apiModelName,api_context_length:_.value.apiContextLength,top_p:_.value.top_P,temperature:_.value.temperature}),signal:w.signal,onopen(t){xe(),t.ok&&t.headers.get("content-type")==="text/event-stream"?(ne(e),T.start()):t.headers.get("content-type")==="application/json"&&ne(e)},onmessage(t){var r;console.log("onmessage");const o=JSON.parse(t.data);(o==null?void 0:o.code)==200&&(o!=null&&o.response)&&o.msg==="success"&&(T.add(o==null?void 0:o.response),R()),(r=o==null?void 0:o.source_documents)!=null&&r.length&&(u.value[u.value.length-1].source=o==null?void 0:o.source_documents)},onclose(){T.done(),w.abort(),f.value=!1,u.value[u.value.length-1].showTools=!0,H(g.value,u.value),Y(()=>{R()})},onerror(t){throw T==null||T.done(),w==null||w.abort(),f.value=!1,u.value[u.value.length-1].showTools=!0,y.error(t.msg||"出错了"),H(g.value,u.value),Y(()=>{R()}),t}})},Ue=e=>{D.value=e.question,I()},Re=(e,t)=>{e.source[t].showDetailDataSource=!e.source[t].showDetailDataSource},je=(e,t)=>{e.source[t].showDetailDataSource=!1},ze=e=>{L.value.push(e)},Ae=e=>{L.value=L.value.filter(t=>t!==e)},{showModal:Q}=q(ue()),J=b(!1),O=b(""),j=b(""),Oe=()=>{k.value&&(Se(!0),be(P.upload))},Ee=()=>{f.value||(j.value="download",Q.value=!0,O.value=h.saveTip)},Ke=()=>{f.value||(j.value="delete",Q.value=!0,O.value=h.clearTip)},Pe=async()=>{if(J.value=!0,j.value==="download")try{const e=document.getElementById("chat-ul"),o=(await ut(e,{useCORS:!0})).toDataURL("image/png"),r=document.createElement("a");r.style.display="none",r.href=o,r.setAttribute("download","chat-shot.png"),typeof r.download>"u"&&r.setAttribute("target","_blank"),document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(o),y.success("下载成功"),await Promise.resolve()}catch(e){y.error(e.message||e.msg||"出错了")}else j.value==="delete"&&(ye(g.value),g.value=null,u.value=[]);j.value="",O.value="",J.value=!1,Q.value=!1},{showSettingModal:Ve}=q(ue()),He=e=>{Ve.value=e},Ie=()=>!!(_.value.apiKey&&_.value.apiBase&&_.value.apiModelName);let le=["pdf","docx","xlsx","txt","jpg","png","jpeg"];const ce=e=>{if(!e)return!1;const t=e.split(".");if(t.length){const o=t.pop();return le.includes(o)}else return!1},Qe=e=>{ce(e.file_name)&&Je(e)};async function Je(e){try{te(null);const t=await de(await pe.getFile({file_id:e.file_id})),o=e.file_name.split(".").pop(),r=Ge(o);if(ke(o),te(`data:${r};base64,${t.base64_content}`),o==="txt"){const N=atob(t.base64_content),s=decodeURIComponent(escape(N));we(s),ee(!0)}else ee(!0)}catch(t){y.error(t.msg||"获取文件失败")}}let We=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","image/jpeg","image/png","image/jpeg"];function Ge(e){const t=le.indexOf(e);return We[t]}return(e,t)=>{const o=Dt,r=at,N=ot;return n(),c(A,null,[l("div",Rt,[a(Ce)===a(xt).optionlist?(n(),W(vt,{key:0})):(n(),c("div",jt,[l("div",{id:"chat",ref_key:"chatContainer",ref:De,class:"chat"},[l("ul",{id:"chat-ul",ref_key:"scrollDom",ref:oe},[(n(!0),c(A,null,G(a(u),(s,F)=>{var ie,re;return n(),c("li",{key:F},[s.type==="user"?(n(),c("div",zt,[At,l("p",Ot,d(s.question),1)])):(n(),c("div",Et,[Kt,l("div",Pt,[l("div",Vt,[s.onlySearch?s.onlySearch&&!s.source.length?(n(),c("p",{key:1,class:C(["question-text",[!s.source.length&&!((re=s==null?void 0:s.picList)!=null&&re.length)?"change-radius":"",s.showTools?"":"flashing"]])},[a(ae)==="zh"?(n(),c("span",It,"未找到信息来源")):(n(),c("span",Qt,"Information source not found"))],2)):x("",!0):(n(),c("p",{key:0,class:C(["question-text",[!s.source.length&&!((ie=s==null?void 0:s.picList)!=null&&ie.length)?"change-radius":"",s.showTools?"":"flashing"]])},[s.answer?(n(),W(_t,{key:0,content:s.answer},null,8,["content"])):(n(),c("span",Ht,d(s.answer),1))],2)),s.source.length?(n(),c(A,{key:2},[l("div",{class:C(["source-total",a(L).includes(F)?"":"source-total-last"])},[a(ae)==="zh"?(n(),c("span",Jt,[s.onlySearch?(n(),c("span",Wt,"检索完成，")):x("",!0),S(" 找到了"+d(s.source.length)+"个信息来源： ",1)])):(n(),c("span",Gt,[s.onlySearch?(n(),c("span",Yt,"Search completed，")):x("",!0),S(" Found "+d(s.source.length)+" source of information ",1)])),$(i(v,{name:"down",onClick:p=>ze(F)},null,8,["onClick"]),[[M,!a(L).includes(F)]]),$(i(v,{name:"up",onClick:p=>Ae(F)},null,8,["onClick"]),[[M,a(L).includes(F)]])],2),$(l("div",Xt,[(n(!0),c(A,null,G(s.source,(p,E)=>(n(),c("div",{key:E,class:"data-source"},[$(l("p",Zt,[l("span",es,d(a(h).dataSource)+d(E+1)+":",1),p.file_id.startsWith("http")?(n(),c("a",{key:0,href:p.file_id,target:"_blank"},d(p.file_name),9,ts)):(n(),c("span",{key:1,class:C(["file",ce(p.file_name)?"filename-active":""]),onClick:z=>Qe(p)},d(p.file_name),11,ss)),$(i(v,{name:"iconup",onClick:z=>je(s,E)},null,8,["onClick"]),[[M,p.showDetailDataSource]]),$(i(v,{name:"icondown",onClick:z=>Re(s,E)},null,8,["onClick"]),[[M,!p.showDetailDataSource]])],512),[[M,p.file_name]]),i(Ze,{name:"sourceItem"},{default:m(()=>{var z;return[$(l("div",as,[l("p",{innerHTML:(z=p.content)==null?void 0:z.replaceAll(`
`,"<br/>")},null,8,os),l("p",ns,[l("span",ls,d(a(h).correlation),1),S(d(p.score),1)])],512),[[M,p.showDetailDataSource]])]}),_:2},1024)]))),128))],512),[[M,a(L).includes(F)]])],64)):x("",!0),s.showTools?(n(),c("div",cs,[l("div",{class:"reload-box",onClick:p=>Ue(s)},[i(v,{name:"reload"}),l("span",rs,d(a(h).regenerate),1)],8,is),l("div",us,[i(v,{style:X({color:s.copied?"#4D71FF":""}),name:"copy",onClick:p=>qe(s)},null,8,["style","onClick"]),i(v,{style:X({color:s.like?"#4D71FF":""}),name:"like",onClick:p=>a(Le)(s,p)},null,8,["style","onClick"]),i(v,{style:X({color:s.unlike?"#4D71FF":""}),name:"unlike",onClick:p=>Fe(s)},null,8,["style","onClick"])])])):x("",!0)])])]))])}),128))],512)],512),a(f)?(n(),c("div",ds,[i(o,{onClick:Be},{icon:m(()=>[i(v,{name:"stop",class:C(a(f)?"loading":"")},null,8,["class"])]),default:m(()=>[S(" "+d(a(h).stop),1)]),_:1})])):x("",!0),l("div",ps,[l("div",hs,[a(se).length?(n(),c("div",_s,[(n(!0),c(A,null,G(a(se),s=>(n(),W(Ut,{key:s.file.lastModified,"file-data":s},null,8,["file-data"]))),128))])):x("",!0),l("div",fs,[i(r,{value:a(D),"onUpdate:value":t[0]||(t[0]=s=>Ye(D)?D.value=s:null),class:"send-textarea","max-length":"200",placeholder:a(h).problemPlaceholder,"auto-size":{minRows:3,maxRows:8},onKeyup:Xe(I,["enter"])},null,8,["value","placeholder"]),l("div",vs,[i(N,null,{content:m(()=>[S(d(a(k)?a(h).chatUpload:a(h).chatUploadNoKbId),1)]),default:m(()=>[l("span",{class:C(["question-icon",a(f)||!a(k)?"isPreventClick":""]),onClick:Oe},[i(v,{name:"chat-upload"})],2)]),_:1}),i(N,null,{content:m(()=>[S(d(a(h).chatToPic),1)]),default:m(()=>[l("span",{class:C(["question-icon",a(f)?"isPreventClick":""]),onClick:Ee},[i(v,{name:"chat-download"})],2)]),_:1}),i(N,null,{content:m(()=>[S(d(a(h).clearChat),1)]),default:m(()=>[l("span",{class:C(["question-icon",a(f)?"isPreventClick":""]),onClick:Ke},[i(v,{name:"chat-delete"})],2)]),_:1}),i(N,null,{content:m(()=>[S(d(a(h).modelSettingTitle),1)]),default:m(()=>[l("span",{class:"question-icon",onClick:t[1]||(t[1]=s=>He(!0))},[i(v,{name:"chat-setting"})])]),_:1}),i(o,{type:"primary",disabled:a(f),shape:"circle",onClick:I},{default:m(()=>[i(v,{name:"sendplane"})]),_:1},8,["disabled"])])])])])]))]),i(ft),i(it,{content:a(O),"confirm-loading":a(J),onOk:Pe},null,8,["content","confirm-loading"])],64)}}}),Ns=ge(gs,[["__scopeId","data-v-11978c06"]]);export{Ns as default};
