import{a as Le,u as W,p as fe}from"./useOptiionList-A5QF3qRY.js";import{g as ce,u as as}from"./index-HIZRnN-c.js";import{d as X,A as l,B as u,C as t,J as f,G as o,L as ie,M as re,N as Z,r as D,c as h,R as C,z as $,E as x,W as S,H as T,F as Y,D as me,Y as O,a3 as J,a as ns,o as Ie,b as ls,O as ne,T as Q,U as R,K as q,a4 as cs,S as ge,Q as is,a5 as rs}from"./index-CMFkO_GU.js";import{u as Te,a as us,b as ds,r as hs}from"./utils-BMBi6enm.js";import{u as ps,b as vs,_ as _s,a as fs}from"./useChatSource-io57M7CK.js";import{u as gs,a as ms,b as xe,D as ys,f as bs,h as ks,_ as ws,T as Cs}from"./html2canvas.esm-kFJZZfhN.js";import{u as le,_ as Ss,C as As,O as Ds}from"./OptionList-wGWAdOdt.js";import{u as qs}from"./ChatSettingForm-Csuu61xa.js";import{B as Ls}from"./RightOutlined-DYIfZQgd.js";import"./collapseMotion-of088ERU.js";import"./index-4A__t0NZ.js";import"./index-ByPLnd9i.js";import"./index-DiJaZQsu.js";import"./injectionKey-DGYNie3Z.js";import"./slide-DHFTURcp.js";const xs="/qanything/assets/icon-file-Bxz0aRpP.png",Is=p=>(ie("data-v-ec2d7664"),p=p(),re(),p),Ts={class:"upload-box"},$s=Is(()=>t("img",{class:"icon-file",src:xs,alt:"图标"},null,-1)),Os={class:"title"},Bs={class:"desc-content"},Es={class:"desc"},Fs={class:"desc"},Qs=X({__name:"UploadDom",props:{acceptList:{require:!0,type:Array,default:()=>[]}},emits:["update"],setup(p,{emit:r}){const d=ce().home,g=r,k=()=>{g("update")};return(c,y)=>(l(),u("div",Ts,[t("div",{class:"tips",onClick:k},[$s,t("p",Os,f(o(d).startDec),1),t("div",Bs,[t("p",Es,f(o(d).updesc2),1),t("p",Fs,f(o(d).require1),1)])])]))}}),Rs=Z(Qs,[["__scopeId","data-v-ec2d7664"]]),Ns=p=>(ie("data-v-9ccba3ef"),p=p(),re(),p),Us={class:"default"},Hs={class:"box"},Ms={class:"title"},js=Ns(()=>t("span",null," ",-1)),zs={class:"color"},Ps={class:"desc"},Ks=X({__name:"Defaultpage",setup(p){const r=ce().home,{setFileList:d}=Le(),{setModalVisible:g}=Le(),{setCurrentId:k,getList:c,setCurrentKbName:y}=W(),N=[".doc",".docx",".ppt",".pptx",".xls",".xlsx",".pdf",".md",".jpg",".jpeg",".png",".bmp",".txt",".eml"],U=D(""),H=async()=>{console.log("updata");try{const v=await Te.createKb({kb_name:r.defaultName});+v.code==200&&(U.value=v.data.kb_id,k(v.data.kb_id),y(v.kb_name),g(!0),c())}catch(v){d([]),C.error(v.msg)}};return(v,G)=>(l(),u("div",Us,[t("div",Hs,[t("p",Ms,[t("span",null,f(o(r).homeTitle1),1),js,t("span",zs,f(o(r).homeTitle2),1)]),t("p",Ps,f(o(r).defaultDec),1),h(Rs,{"accept-list":N,onUpdate:H})])]))}}),Vs=Z(Ks,[["__scopeId","data-v-9ccba3ef"]]),Ys="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAEgSURBVFiF7ZaxDcJADEVt0lAyQkaAKzIHI0BxkmeKCxiFAaKDDRAdJQvkQpNIEeQu9gVoyK8SXZz/ZPssA8ya9e/KYofW2nVRFMuqqh4pP5fEL0IHRJQj4tl7f7XW7hLMd734tRqgrutV94yIBw1Ea37o3rMsC2YgWALn3N0Yc0PEbQuxNcbcnHMXjXnTNPuyLE9qgBbiooEYMmfmY8wjCqCBSDEXAUggUs0BAFDyUachoxYoyVwNMATRl9YcQFiCvl7LMcUcIDIHfiV1BkIlkM6Jt7gp5p9oQnEGQldNO6ySAMbu+RSIUQDpkEmFGNsHVBMuBSLYhESUe++vUvMR8A0zD0KI9gFtZzPzsbshAPF9ICoiymPbzLfjZ836Dz0BusANDR+zFvgAAAAASUVORK5CYII=",Js=p=>(ie("data-v-52b8d98c"),p=p(),re(),p),Ws={class:"history-chat"},Xs={class:"history-chat-content"},Zs={class:"list"},Gs=Js(()=>t("div",{class:"line"},null,-1)),eo=["onClick"],so=["onClick"],oo=X({__name:"HistoryChat",props:{observer:{type:Object,required:!0},observeDom:{type:Object,default:null},qaObserver:{type:Object,required:!0},qaObserveDom:{type:Object,default:null},showLoading:{type:Boolean,require:!0}},emits:["scrollBottom","setObserveDom","setQaObserverDom","clearHistory"],setup(p,{emit:r}){const d=p,{chatList:g,chatId:k,QA_List:c,qaPageId:y,pageId:N,historyList:U}=$(le()),{deleteHistoryList:H,getChatById:v}=le(),{setSelectList:G}=W(),L=r;function ue(w){c.value.push({question:w,type:"user"})}function M(w,A,i,z,b){c.value.push({answer:A,question:w,type:"ai",qaId:z,copied:!1,like:!1,unlike:!1,source:b||[],showTools:!0,picList:i})}async function de(w){if(!d.showLoading){k.value=w.historyId,c.value=[],y.value=1,G([...w.kbIds]),L("clearHistory");try{const A=v(k.value);d.qaObserveDom!==null&&(d.qaObserver.unobserve(d.qaObserveDom),L("setQaObserverDom",null)),A.list.forEach(i=>{i.type==="user"?ue(i.question):i.type==="ai"&&M(i.question,i.answer,i.picList,i.qaId,i.source)}),L("scrollBottom"),A.list.length>=50&&await J(()=>{const i=document.getElementsByClassName("chat-li");i.length&&(d.qaObserver.observe(i[0]),L("setQaObserverDom",i[0]))})}catch(A){C.error(A.msg||"获取问答历史失败")}}}function j(){if(!d.showLoading){if(k.value===null){C.info("已切换最新对话");return}k.value=null,c.value=[],y.value=1,N.value=1,L("clearHistory")}}async function he(w,A){if(!d.showLoading)try{H(w.historyId),w.historyId===k.value&&j(),C.success("删除成功"),g.value.splice(A,1),await J(()=>{ee()})}catch(i){C.error(i.msg||"删除失败")}}function ee(){if(d.qaObserveDom!==null){d.qaObserver.unobserve(d.qaObserveDom),L("setQaObserverDom",null);const w=document.getElementsByClassName("chat-li");w.length&&(d.qaObserver.observe(w[0]),L("setQaObserverDom",w[0]))}}return(w,A)=>(l(),u("div",Ws,[t("div",Xs,[t("div",Zs,[t("div",{class:x(["new-chat",[p.showLoading?"disabled":"",o(k)===null?"new-active":""]]),onClick:j},[h(S,{name:"new-chat"}),T(" "+f(o(ce)().home.newConversation),1)],2),(l(!0),u(Y,null,me(o(U),(i,z)=>(l(),u("div",{key:i.historyId,class:x(["chat-item",o(k)===i.historyId?"item-active":"",p.showLoading?"disabled":""])},[Gs,t("span",{onClick:b=>de(i)},f(i.title),9,eo),o(k)===i.historyId?(l(),u("img",{key:0,src:Ys,class:"close-icon",alt:"close",onClick:b=>he(i,z)},null,8,so)):O("",!0)],2))),128))])])]))}}),to=Z(oo,[["__scopeId","data-v-52b8d98c"]]),$e=p=>(ie("data-v-2df2fd31"),p=p(),re(),p),ao={class:"container showSider"},no={class:"my-page"},lo={key:0,class:"user"},co=$e(()=>t("img",{class:"avatar",src:fs,alt:"头像"},null,-1)),io={class:"question-text"},ro={key:1,class:"ai"},uo=$e(()=>t("img",{class:"avatar",src:ws,alt:"头像"},null,-1)),ho={class:"ai-content"},po={class:"ai-right"},vo={key:1},_o={key:0},fo={key:1},go={key:0},mo={key:0},yo={key:1},bo={key:0},ko={class:"source-list"},wo={class:"control"},Co={class:"tips"},So=["href"],Ao=["onClick"],Do={class:"source-content"},qo=["innerHTML"],Lo={class:"score"},xo={class:"tips"},Io={key:3,class:"feed-back"},To=["onClick"],$o={class:"reload-text"},Oo={class:"tools"},Bo={key:0,class:"stop-btn"},Eo={class:"question-box"},Fo={class:"question"},Qo={class:"send-box"},Ro={class:"send-action"},No=X({__name:"Chat",setup(p){const r=ce().common,d=new Cs(e=>{e&&(c.value[c.value.length-1].answer+=e||"",console.log(c.value))}),{selectList:g,knowledgeBaseList:k}=$(W()),{QA_List:c,chatId:y,pageId:N,qaPageId:U,historyList:H}=$(le()),{chatSettingFormActive:v}=$(qs()),{copy:G}=gs(),{addHistoryList:L,updateHistoryList:ue,addChatList:M,clearChatList:de}=le(),{setChatSourceVisible:j,setSourceType:he,setSourceUrl:ee,setTextContent:w}=ps(),{language:A}=$(as()),i=D(""),z=ns(()=>{const e=v.value.context;if(e===0)return[];const s=c.value.filter(_=>_.type==="ai");return(e===11?s:s.slice(-e)).map(_=>[_.question,_.answer])}),b=D(!1),B=D([]),se=D(null),oe=D(null);let I;const Oe=D(null),ye=D(null),E=()=>{J(()=>{var e;(e=ye.value)==null||e.scrollIntoView(!1)})},be=new IntersectionObserver(e=>{e.forEach(s=>{s.isIntersecting&&(console.log("entry.isIntersecting"),N.value++)})}),ke=new IntersectionObserver(e=>{e.forEach(s=>{s.isIntersecting&&(console.log("qa entry.isIntersecting"),U.value++)})});Ie(()=>{console.log("------chatId",y.value),E()}),ls(()=>{se.value&&be.unobserve(se.value),oe.value&&ke.unobserve(oe.value)});const Be=ms((e,s)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){s.target.parentNode.style.animation="shake ease-in .5s";const n=setTimeout(()=>{clearTimeout(n),s.target.parentNode.style.animation=""},600)}},800),Ee=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},Fe=e=>{G(e.answer).then(()=>{e.copied=!e.copied,C.success(r.copySuccess,1);const s=setTimeout(()=>{clearTimeout(s),e.copied=!e.copied},1e3)}).catch(()=>{C.error(r.copyFailed,1)})},Qe=e=>{c.value.push({question:e,type:"user"}),console.log("QALIST------",c.value),E()},we=e=>{c.value.push({answer:"",question:e,onlySearch:v.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},Re=e=>{se.value=e},Ne=e=>{oe.value=e},Ce=(e,s,n)=>{try{ue(e,s,n)}catch(_){C.error(_.msg||"更新对话失败")}};function Ue(){if(!g.value.length)return;const e=[];g.value.forEach(s=>{k.value.some(n=>n.kb_id===s)&&e.push(s)}),g.value=e,H.value.forEach(s=>{y.value!==null&&s.historyId===y.value&&s.kbIds.join("")!==g.value.join("")&&Ce(s.title,s.historyId,g.value)})}const He=()=>{I&&I.abort(),d.done(),b.value=!1,c.value[c.value.length-1].showTools=!0},Me=e=>{try{if(console.log("chat-title=",e),y.value!==null)return;e.length>100&&(e=e.substring(0,100)),y.value=L(e),Ce(e,y.value,g.value)}catch(s){C.error(s.msg||"创建对话失败")}},pe=()=>{if(!i.value.trim().length)return;if(b.value){C.warn("正在聊天中...请等待结束");return}if(Ue(),g.value.length)C.info({content:r.type==="zh"?`已选择 ${g.value.length} 个知识库进行问答`:` ${g.value.length} knowledge base has been selected`,icon:" "});else return C.warning(r.chooseError);const e=i.value;Me(e),i.value="",Qe(e),M(y.value,c.value),b.value=!0,I=new AbortController,bs(ds+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:us,kb_ids:g.value,history:z.value,question:e,streaming:v.value.capabilities.onlySearch===!1,networking:v.value.capabilities.onlineSearch,product_source:"saas",only_need_search_results:v.value.capabilities.onlySearch,hybrid_search:v.value.capabilities.mixedSearch,max_token:v.value.maxToken,api_base:v.value.apiBase,api_key:v.value.apiKey,model:v.value.apiModelName,api_context_length:v.value.apiContextLength,top_p:v.value.top_P,temperature:v.value.temperature}),signal:I.signal,onopen(s){console.log("open"),s.ok&&s.headers.get("content-type")==="text/event-stream"?(we(e),d.start()):s.headers.get("content-type")==="application/json"&&we(e)},onmessage(s){var _;console.log("message");const n=JSON.parse(s.data);console.log(n),(n==null?void 0:n.code)==200&&(n!=null&&n.response)&&n.msg==="success"&&(d.add(n==null?void 0:n.response),E()),(_=n==null?void 0:n.source_documents)!=null&&_.length&&(c.value[c.value.length-1].source=n==null?void 0:n.source_documents)},onclose(s){console.log("close"),console.log(s),d.done(),I.abort(),b.value=!1,c.value[c.value.length-1].showTools=!0,M(y.value,c.value),J(()=>{E()})},onerror(s){throw console.log("error"),d==null||d.done(),I==null||I.abort(),b.value=!1,c.value[c.value.length-1].showTools=!0,C.error(s.msg||"出错了"),M(y.value,c.value),J(()=>{E()}),s}})},je=e=>{console.log("reAnswer"),i.value=e.question,pe()},ze=(e,s)=>{e.source[s].showDetailDataSource=!e.source[s].showDetailDataSource},Pe=(e,s)=>{e.source[s].showDetailDataSource=!1},Ke=e=>{B.value.push(e)},Ve=e=>{B.value=B.value.filter(s=>s!==e)},{showModal:ve}=$(xe()),_e=D(!1),te=D(""),P=D(""),Ye=()=>{b.value||(P.value="download",ve.value=!0,te.value=r.saveTip)},Je=()=>{b.value||(P.value="delete",ve.value=!0,te.value=r.clearTip)},We=async()=>{if(_e.value=!0,P.value==="download"){console.log("download");try{const e=document.getElementById("chat-ul"),n=(await ks(e,{useCORS:!0})).toDataURL("image/png"),_=document.createElement("a");_.style.display="none",_.href=n,_.setAttribute("download","chat-shot.png"),typeof _.download>"u"&&_.setAttribute("target","_blank"),document.body.appendChild(_),_.click(),document.body.removeChild(_),window.URL.revokeObjectURL(n),C.success("下载成功"),Promise.resolve()}catch(e){console.log(e),C.error(e.message||e.msg||"出错了")}}else P.value==="delete"&&(console.log("delete"),de(y.value),y.value=null,c.value=[]);P.value="",te.value="",_e.value=!1,ve.value=!1},{showSettingModal:Xe}=$(xe()),Ze=e=>{Xe.value=e};let Se=["pdf","docx","xlsx","txt","jpg","png","jpeg"];const Ae=e=>{if(!e)return!1;const s=e.split(".");if(s.length){const n=s.pop();return!!Se.includes(n)}else return!1},Ge=e=>{console.log("handleChatSource",e),Ae(e.file_name)&&es(e)};async function es(e){try{ee(null);const s=await hs(await Te.getFile({file_id:e.file_id}));console.log("queryFile",s);const n=e.file_name.split(".").pop(),_=os(n);if(console.log("b64Type",_),he(n),ee(`data:${_};base64,${s.base64_content}`),n==="txt"){const K=atob(s.base64_content),a=decodeURIComponent(escape(K));console.log("decodedTxt",a),w(a),j(!0)}else j(!0)}catch(s){C.error(s.msg||"获取文件失败")}}let ss=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","image/jpeg","image/png","image/jpeg"];function os(e){const s=Se.indexOf(e);return ss[s]}function ts(){console.log("清空")}return E(),(e,s)=>{const n=Ls,_=vs,K=_s;return l(),u(Y,null,[h(to,{observer:o(be),"observe-dom":o(se),"qa-observe-dom":o(oe),"qa-observer":o(ke),"show-loading":o(b),onScrollBottom:E,onSetObserveDom:Re,onSetQaObserverDom:Ne,onClearHistory:ts},null,8,["observer","observe-dom","qa-observe-dom","qa-observer","show-loading"]),t("div",ao,[t("div",no,[t("div",{id:"chat",ref_key:"chatContainer",ref:Oe,class:"chat showSider"},[t("ul",{id:"chat-ul",ref_key:"scrollDom",ref:ye},[(l(!0),u(Y,null,me(o(c),(a,F)=>{var De,qe;return l(),u("li",{key:F},[a.type==="user"?(l(),u("div",lo,[co,t("p",io,f(a.question),1)])):(l(),u("div",ro,[uo,t("div",ho,[t("div",po,[a.onlySearch?a.onlySearch&&!a.source.length?(l(),u("p",{key:1,class:x(["question-text",[!a.source.length&&!((qe=a==null?void 0:a.picList)!=null&&qe.length)?"change-radius":"",a.showTools?"":"flashing"]])},[o(A)==="zh"?(l(),u("span",_o,"未找到信息来源")):(l(),u("span",fo,"Information source not found"))],2)):O("",!0):(l(),u("p",{key:0,class:x(["question-text",[!a.source.length&&!((De=a==null?void 0:a.picList)!=null&&De.length)?"change-radius":"",a.showTools?"":"flashing"]])},[a.answer?(l(),ne(Ss,{key:0,content:a.answer},null,8,["content"])):(l(),u("span",vo,f(a.answer),1))],2)),a.source.length?(l(),u(Y,{key:2},[t("div",{class:x(["source-total",o(B).includes(F)?"":"source-total-last"])},[o(A)==="zh"?(l(),u("span",go,[a.onlySearch?(l(),u("span",mo,"检索完成，")):O("",!0),T(" 找到了"+f(a.source.length)+"个信息来源： ",1)])):(l(),u("span",yo,[a.onlySearch?(l(),u("span",bo,"Search completed，")):O("",!0),T(" Found "+f(a.source.length)+" source of information ",1)])),Q(h(S,{name:"down",onClick:m=>Ke(F)},null,8,["onClick"]),[[R,!o(B).includes(F)]]),Q(h(S,{name:"up",onClick:m=>Ve(F)},null,8,["onClick"]),[[R,o(B).includes(F)]])],2),Q(t("div",ko,[(l(!0),u(Y,null,me(a.source,(m,ae)=>(l(),u("div",{key:ae,class:"data-source"},[Q(t("p",wo,[t("span",Co,f(o(r).dataSource)+f(ae+1)+":",1),m.file_id.startsWith("http")?(l(),u("a",{key:0,href:m.file_id,target:"_blank"},f(m.file_name),9,So)):(l(),u("span",{key:1,class:x(["file",Ae(m.file_name)?"filename-active":""]),onClick:V=>Ge(m)},f(m.file_name),11,Ao)),Q(h(S,{name:"iconup",onClick:V=>Pe(a,ae)},null,8,["onClick"]),[[R,m.showDetailDataSource]]),Q(h(S,{name:"icondown",onClick:V=>ze(a,ae)},null,8,["onClick"]),[[R,!m.showDetailDataSource]])],512),[[R,m.file_name]]),h(cs,{name:"sourceitem"},{default:q(()=>{var V;return[Q(t("div",Do,[t("p",{innerHTML:(V=m.content)==null?void 0:V.replaceAll(`
`,"<br/>")},null,8,qo),t("p",Lo,[t("span",xo,f(o(r).correlation),1),T(f(m.score),1)])],512),[[R,m.showDetailDataSource]])]}),_:2},1024)]))),128))],512),[[R,o(B).includes(F)]])],64)):O("",!0),a.showTools?(l(),u("div",Io,[t("div",{class:"reload-box",onClick:m=>je(a)},[h(S,{name:"reload"}),t("span",$o,f(o(r).regenerate),1)],8,To),t("div",Oo,[h(S,{style:ge({color:a.copied?"#4D71FF":""}),name:"copy",onClick:m=>Fe(a)},null,8,["style","onClick"]),h(S,{style:ge({color:a.like?"#4D71FF":""}),name:"like",onClick:m=>o(Be)(a,m)},null,8,["style","onClick"]),h(S,{style:ge({color:a.unlike?"#4D71FF":""}),name:"unlike",onClick:m=>Ee(a)},null,8,["style","onClick"])])])):O("",!0)])])]))])}),128))],512)],512),o(b)?(l(),u("div",Bo,[h(n,{onClick:He},{icon:q(()=>[h(S,{name:"stop",class:x(o(b)?"loading":"")},null,8,["class"])]),default:q(()=>[T(" "+f(o(r).stop),1)]),_:1})])):O("",!0),t("div",Eo,[t("div",Fo,[t("div",Qo,[h(_,{value:o(i),"onUpdate:value":s[0]||(s[0]=a=>is(i)?i.value=a:null),class:"send-textarea","max-length":"200",placeholder:o(r).problemPlaceholder,"auto-size":{minRows:3,maxRows:8},onKeyup:rs(pe,["enter"])},null,8,["value","placeholder"]),t("div",Ro,[h(K,{placement:"topLeft"},{content:q(()=>[T(f(o(r).chatToPic),1)]),default:q(()=>[t("span",{class:x(["download",o(b)?"isPreventClick":""]),onClick:Ye},[h(S,{name:"chat-download"})],2)]),_:1}),h(K,null,{content:q(()=>[T(f(o(r).clearChat),1)]),default:q(()=>[t("span",{class:x(["delete",o(b)?"isPreventClick":""]),onClick:Je},[h(S,{name:"chat-delete"})],2)]),_:1}),h(K,null,{content:q(()=>[T(f(o(r).modelSettingTitle),1)]),default:q(()=>[t("span",{class:"setting",onClick:s[1]||(s[1]=a=>Ze(!0))},[h(S,{name:"chat-setting"})])]),_:1}),h(n,{type:"primary",disabled:o(b),shape:"circle",onClick:pe},{default:q(()=>[h(S,{name:"sendplane"})]),_:1},8,["disabled"])])])])])])]),h(As),h(ys,{content:o(te),"confirm-loading":o(_e),onOk:We},null,8,["content","confirm-loading"])],64)}}}),Uo=Z(No,[["__scopeId","data-v-2df2fd31"]]),Ho={class:"page"},Mo={class:"container"},jo=X({__name:"Home",setup(p){const{showDefault:r}=$(W()),{setDefault:d,getList:g}=W(),k=c=>{d(c),g()};return Ie(()=>{console.log(r.value),g()}),(c,y)=>(l(),u("div",Ho,[t("div",Mo,[o(r)===o(fe).default?(l(),ne(Vs,{key:0,onChange:k})):o(r)===o(fe).normal?(l(),ne(Uo,{key:1})):o(r)===o(fe).optionlist?(l(),ne(Ds,{key:2})):O("",!0)])]))}}),nt=Z(jo,[["__scopeId","data-v-fe878bf5"]]);export{nt as default};
