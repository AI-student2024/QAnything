import{d as ke,$ as st,a as E,o as Ce,A as n,B as i,c as l,G as s,W as v,X as w,C as c,J as p,r as L,N as we,z as B,O as Q,F as A,D as te,K as m,Q as ot,a2 as ae,R as C,a4 as nt,E as T,H as D,T as I,U as M,a3 as lt,S as se,L as ct,M as it}from"./index-uS7D60Vj.js";import{u as rt,b as ut,_ as dt,a as pt}from"./useChatSource-BnvcgUzt.js";import{u as ht,a as _t,b as ge,D as ft,f as vt,h as gt,T as mt,_ as yt}from"./html2canvas.esm-kffUbUtV.js";import{_ as kt,C as Ct}from"./ChatInfoPanel-BeNnHoZi.js";import{g as wt,u as bt}from"./index-BtipXdVs.js";import{f as St,p as xt,r as oe,u as ne,a as Tt,b as Dt,C as Lt}from"./utils-CXxq_1WL.js";import{u as me}from"./useQuickStart-DUhL4wTW.js";import{L as Ft,a as ye,C as qt,b as $t,F as Bt,O as It}from"./OptionList-DOrW3azC.js";import{u as Mt,a as Nt,p as Ut}from"./icon-loading-BT-1esjm.js";import{u as Kt}from"./useChatSetting-DLMERjxB.js";import{B as jt}from"./RightOutlined-dFqRQOx1.js";import"./slide-CIPjZ2vL.js";import"./collapseMotion-paX0PkVM.js";import"./index-vKtJiJDO.js";import"./index-BX6bNqE-.js";import"./injectionKey-DGYNie3Z.js";const zt={class:"contain"},Ot={key:0,class:"loading"},Rt={class:"file-info"},Pt={class:"file-name"},At={key:0,class:"file-extension"},Et={key:1,class:"file-extension"},Ht=ke({__name:"FileBlock",props:{fileData:{},kbId:{}},setup(N){const f=N,{fileData:y,kbId:J}=st(f),r=E(()=>u.value!=="green"&&u.value!=="red"),g=E(()=>xt(y.value.file_name)),k=E(()=>u.value==="red"?"file-error":u.value==="green"?"file-"+W.get(g.value.fileExtension):"file-unknown"),u=E(()=>y.value.status),W=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]),G=new Map([["gray","上传中"],["yellow","解析中"],["green","解析成功"],["red","上传失败"]]),j=()=>{let U=L(null);U.value=setInterval(async()=>{if(y.value.file_id===""&&y.value.status!=="loading"&&(y.value.status="red"),y.value.status==="green"||y.value.status==="red")clearInterval(U.value),U.value=null;else{const z=await oe(await ne.fileList({kb_id:J.value,file_id:y.value.file_id}));console.log(z),y.value.status=z.details[0].status}},2e3)};return Ce(()=>{j()}),(U,z)=>(n(),i("div",zt,[l(v,{name:s(k)},null,8,["name"]),s(r)?(n(),i("div",Ot,[l(Ft)])):w("",!0),c("div",Rt,[c("span",Pt,p(s(g).fileName),1),s(u)==="green"?(n(),i("span",At,p(s(g).fileExtension.toUpperCase())+", "+p(s(St)(s(y).file.size)||0),1)):(n(),i("span",Et,p(s(G).get(s(u))),1))])]))}}),Vt=we(Ht,[["__scopeId","data-v-2f14786d"]]),be=N=>(ct("data-v-afa467f1"),N=N(),it(),N),Qt={class:"container"},Jt={key:1,class:"my-page"},Wt={key:0,class:"user"},Gt=be(()=>c("img",{class:"avatar",src:pt,alt:"头像"},null,-1)),Xt={class:"question-text"},Yt={key:1,class:"ai"},Zt=be(()=>c("img",{class:"avatar",src:yt,alt:"头像"},null,-1)),ea={class:"ai-content"},ta={class:"ai-right"},aa={key:1},sa={key:0},oa={key:1},na={key:0},la={key:0},ca={key:1},ia={key:0},ra={class:"source-list"},ua={class:"control"},da={class:"tips"},pa=["href"],ha=["onClick"],_a={class:"source-content"},fa=["innerHTML"],va={class:"score"},ga={class:"tips"},ma={key:3,class:"feed-back"},ya=["onClick"],ka={class:"reload-text"},Ca={class:"tools"},wa={key:0,class:"stop-btn"},ba={class:"question-box"},Sa={class:"question"},xa={key:0,class:"file-list-box"},Ta={class:"send-box"},Da={class:"send-action"},La=ke({__name:"index",setup(N){const{common:f,home:y}=wt(),{copy:J}=ht(),{QA_List:r,chatId:g,kbId:k,showLoading:u}=B(me()),{addHistoryList:W,updateHistoryList:G,addChatList:j,clearChatList:U,getHistoryById:z,renameHistory:Se}=me(),{setChatSourceVisible:le,setSourceType:xe,setSourceUrl:ce,setTextContent:Te}=rt(),{chatSettingFormActive:h}=B(Kt()),{showDefault:De}=B(Mt()),{setModalVisible:Le,setModalTitle:Fe}=Nt(),{uploadFileList:ie}=B(ye()),{initUploadFileList:qe}=ye(),{language:re}=B(bt()),F=new mt(e=>{e&&(r.value[r.value.length-1].answer+=e||"")}),b=L(""),$e=E(()=>{const e=h.value.context;if(e===0)return[];const t=r.value.filter(d=>d.type==="ai");return(e===1?t:t.slice(-e)).map(d=>[d.question,d.answer])}),q=L([]);let S;const Be=L(null),ue=L(null),K=()=>{ae(()=>{var e;(e=ue.value)==null||e.scrollIntoView({behavior:"smooth",block:"end"})})};Ce(()=>{K()});const Ie=e=>{e.keyCode===13&&(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey?b.value+=`
`:X(),e.preventDefault())},Me=_t((e,t)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){t.target.parentNode.style.animation="shake ease-in .5s";const o=setTimeout(()=>{clearTimeout(o),t.target.parentNode.style.animation=""},600)}},800),Ne=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},Ue=e=>{J(e.answer).then(()=>{e.copied=!e.copied,C.success(f.copySuccess,1);const t=setTimeout(()=>{clearTimeout(t),e.copied=!e.copied},1e3)}).catch(()=>{C.error(f.copyFailed,1)})},Ke=e=>{r.value.push({question:e,type:"user"}),K()},de=e=>{r.value.push({answer:"",question:e,onlySearch:h.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},O=new Lt,je=()=>{S&&S.abort(),F.done(),u.value=!1,r.value[r.value.length-1].showTools=!0},ze=async e=>{try{if(g.value!==null){z(g.value).title==="未命名对话"&&Se(g.value,e);return}e.length>100&&(e=e.substring(0,100));const t=await oe(await ne.createKb({kb_name:e}));k.value=t.kb_id,g.value=W(e),G(e,g.value,k.value)}catch(t){C.error(t.msg||"创建对话失败")}},X=async()=>{if(!b.value.trim().length)return;if(u.value){C.warn("正在聊天中...请等待结束");return}if(!Xe()){C.error("模型设置错误，请先检查模型配置");return}qe();const e=b.value;await ze(e),b.value="",Ke(e),j(g.value,r.value),u.value=!0,S=new AbortController,vt(Dt+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:Tt,kb_ids:[k.value],history:$e.value,question:e,streaming:h.value.capabilities.onlySearch===!1,networking:h.value.capabilities.networkSearch,product_source:"saas",rerank:h.value.capabilities.rerank,only_need_search_results:h.value.capabilities.onlySearch,hybrid_search:h.value.capabilities.mixedSearch,max_token:h.value.maxToken,api_base:h.value.apiBase,api_key:h.value.apiKey,model:h.value.apiModelName,api_context_length:h.value.apiContextLength,chunk_size:h.value.chunkSize,top_p:h.value.top_P,temperature:h.value.temperature}),signal:S.signal,async onopen(t){console.log("eee",t),O.addChatSetting(h.value),t.ok&&t.headers.get("content-type")==="text/event-stream"?(de(e),F.start()):t.headers.get("content-type")==="application/json"&&(console.log("ssss"),de(e))},onmessage(t){var d;console.log("onmessage",t);const o=JSON.parse(t.data);if((o==null?void 0:o.code)==200&&(o!=null&&o.response)&&o.msg==="success")F.add(o==null?void 0:o.response),K();else{const x=o.time_record.time_usage;delete x.retriever_search_by_milvus,O.addTime(o.time_record.time_usage),O.addToken(o.time_record.token_usage),O.addDate(Date.now())}(d=o==null?void 0:o.source_documents)!=null&&d.length&&(r.value[r.value.length-1].source=o==null?void 0:o.source_documents)},onclose(){console.log("onclose"),F.done(),S.abort(),u.value=!1,r.value[r.value.length-1].showTools=!0,r.value.at(-1).itemInfo=O.getChatInfo(),j(g.value,r.value),ae(()=>{K()})},onerror(t){throw console.log("onerror",t),F==null||F.done(),S==null||S.abort(),u.value=!1,r.value[r.value.length-1].showTools=!0,C.error(t.msg||"出错了"),j(g.value,r.value),ae(()=>{K()}),t}})},Oe=e=>{b.value=e.question,X()},Re=(e,t)=>{e.source[t].showDetailDataSource=!e.source[t].showDetailDataSource},Pe=(e,t)=>{e.source[t].showDetailDataSource=!1},Ae=e=>{q.value.push(e)},Ee=e=>{q.value=q.value.filter(t=>t!==e)},{showModal:Y}=B(ge()),Z=L(!1),H=L(""),R=L(""),He=()=>{k.value&&(Le(!0),Fe(y.upload))},Ve=()=>{u.value||(R.value="download",Y.value=!0,H.value=f.saveTip)},Qe=()=>{u.value||(R.value="delete",Y.value=!0,H.value=f.clearTip)},Je=async()=>{if(Z.value=!0,R.value==="download")try{const e=document.getElementById("chat-ul"),o=(await gt(e,{useCORS:!0})).toDataURL("image/png"),d=document.createElement("a");d.style.display="none",d.href=o,d.setAttribute("download","chat-shot.png"),typeof d.download>"u"&&d.setAttribute("target","_blank"),document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(o),C.success("下载成功"),await Promise.resolve()}catch(e){C.error(e.message||e.msg||"出错了")}else R.value==="delete"&&(U(g.value),g.value=null,r.value=[]);R.value="",H.value="",Z.value=!1,Y.value=!1},{showSettingModal:We}=B(ge()),Ge=e=>{We.value=e},Xe=()=>!!(h.value.apiKey&&h.value.apiBase&&h.value.apiModelName);let pe=["pdf","docx","xlsx","txt","jpg","png","jpeg"];const he=e=>{if(!e)return!1;const t=e.split(".");if(t.length){const o=t.pop();return pe.includes(o)}else return!1},Ye=e=>{he(e.file_name)&&Ze(e)};async function Ze(e){try{ce(null);const t=await oe(await ne.getFile({file_id:e.file_id})),o=e.file_name.split(".").pop(),d=tt(o);if(xe(o),ce(`data:${d};base64,${t.base64_content}`),o==="txt"){const x=atob(t.base64_content),ee=decodeURIComponent(escape(x));Te(ee),le(!0)}else le(!0)}catch(t){C.error(t.msg||"获取文件失败")}}let et=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","image/jpeg","image/png","image/jpeg"];function tt(e){const t=pe.indexOf(e);return et[t]}return(e,t)=>{const o=jt,d=ut,x=dt,ee=Bt,at=nt;return n(),i(A,null,[c("div",Qt,[s(De)===s(Ut).optionlist?(n(),Q(It,{key:0})):(n(),i("div",Jt,[c("div",{id:"chat",ref_key:"chatContainer",ref:Be,class:"chat"},[c("ul",{id:"chat-ul",ref_key:"scrollDom",ref:ue},[(n(!0),i(A,null,te(s(r),(a,$)=>{var _e,fe,ve;return n(),i("li",{key:$},[a.type==="user"?(n(),i("div",Wt,[Gt,c("p",Xt,p(a.question),1)])):(n(),i("div",Yt,[Zt,c("div",ea,[c("div",ta,[a.onlySearch?a.onlySearch&&!a.source.length?(n(),i("p",{key:1,class:T(["question-text",[!a.source.length&&!((ve=a==null?void 0:a.picList)!=null&&ve.length)?"change-radius":"",a.showTools?"":"flashing"]])},[s(re)==="zh"?(n(),i("span",sa,"未找到信息来源")):(n(),i("span",oa,"Information source not found"))],2)):w("",!0):(n(),i("p",{key:0,class:T(["question-text",[!a.source.length&&!((_e=a==null?void 0:a.picList)!=null&&_e.length)?"change-radius":"",a.showTools?"":"flashing"]])},[a.answer?(n(),Q(kt,{key:0,content:a.answer},null,8,["content"])):(n(),i("span",aa,p(a.answer),1)),Object.keys(((fe=a==null?void 0:a.itemInfo)==null?void 0:fe.tokenInfo)||{}).length?(n(),Q(Ct,{key:2,"chat-item-info":a.itemInfo},null,8,["chat-item-info"])):w("",!0)],2)),a.source.length?(n(),i(A,{key:2},[c("div",{class:T(["source-total",s(q).includes($)?"":"source-total-last"])},[s(re)==="zh"?(n(),i("span",na,[a.onlySearch?(n(),i("span",la,"检索完成，")):w("",!0),D(" 找到了"+p(a.source.length)+"个信息来源： ",1)])):(n(),i("span",ca,[a.onlySearch?(n(),i("span",ia,"Search completed，")):w("",!0),D(" Found "+p(a.source.length)+" source of information ",1)])),I(l(v,{name:"down",onClick:_=>Ae($)},null,8,["onClick"]),[[M,!s(q).includes($)]]),I(l(v,{name:"up",onClick:_=>Ee($)},null,8,["onClick"]),[[M,s(q).includes($)]])],2),I(c("div",ra,[(n(!0),i(A,null,te(a.source,(_,V)=>(n(),i("div",{key:V,class:"data-source"},[I(c("p",ua,[c("span",da,p(s(f).dataSource)+p(V+1)+":",1),_.file_id.startsWith("http")?(n(),i("a",{key:0,href:_.file_id,target:"_blank"},p(_.file_name),9,pa)):(n(),i("span",{key:1,class:T(["file",he(_.file_name)?"filename-active":""]),onClick:P=>Ye(_)},p(_.file_name),11,ha)),I(l(v,{name:"iconup",onClick:P=>Pe(a,V)},null,8,["onClick"]),[[M,_.showDetailDataSource]]),I(l(v,{name:"icondown",onClick:P=>Re(a,V)},null,8,["onClick"]),[[M,!_.showDetailDataSource]])],512),[[M,_.file_name]]),l(lt,{name:"sourceItem"},{default:m(()=>{var P;return[I(c("div",_a,[c("p",{innerHTML:(P=_.content)==null?void 0:P.replaceAll(`
`,"<br/>")},null,8,fa),c("p",va,[c("span",ga,p(s(f).correlation),1),D(p(_.score),1)])],512),[[M,_.showDetailDataSource]])]}),_:2},1024)]))),128))],512),[[M,s(q).includes($)]])],64)):w("",!0),a.showTools?(n(),i("div",ma,[c("div",{class:"reload-box",onClick:_=>Oe(a)},[l(v,{name:"reload"}),c("span",ka,p(s(f).regenerate),1)],8,ya),c("div",Ca,[l(v,{style:se({color:a.copied?"#4D71FF":""}),name:"copy",onClick:_=>Ue(a)},null,8,["style","onClick"]),l(v,{style:se({color:a.like?"#4D71FF":""}),name:"like",onClick:_=>s(Me)(a,_)},null,8,["style","onClick"]),l(v,{style:se({color:a.unlike?"#4D71FF":""}),name:"unlike",onClick:_=>Ne(a)},null,8,["style","onClick"])])])):w("",!0)])])]))])}),128))],512)],512),s(u)?(n(),i("div",wa,[l(o,{onClick:je},{icon:m(()=>[l(v,{name:"stop",class:T(s(u)?"loading":"")},null,8,["class"])]),default:m(()=>[D(" "+p(s(f).stop),1)]),_:1})])):w("",!0),c("div",ba,[c("div",Sa,[s(ie).length?(n(),i("div",xa,[(n(!0),i(A,null,te(s(ie),a=>(n(),Q(Vt,{key:a.file.lastModified,"file-data":a,"kb-id":s(k)},null,8,["file-data","kb-id"]))),128))])):w("",!0),c("div",Ta,[l(d,{value:s(b),"onUpdate:value":t[0]||(t[0]=a=>ot(b)?b.value=a:null),class:"send-textarea","max-length":"200",bordered:!1,placeholder:s(f).problemPlaceholder,"auto-size":{minRows:4,maxRows:8},onKeydown:Ie},null,8,["value","placeholder"]),c("div",Da,[l(x,null,{content:m(()=>[D(p(s(k)?s(f).chatUpload:s(f).chatUploadNoKbId),1)]),default:m(()=>[c("span",{class:T(["question-icon",s(u)||!s(k)?"isPreventClick":""]),onClick:He},[l(v,{name:"chat-upload"})],2)]),_:1}),l(x,null,{content:m(()=>[D(p(s(f).chatToPic),1)]),default:m(()=>[c("span",{class:T(["question-icon",s(u)?"isPreventClick":""]),onClick:Ve},[l(v,{name:"chat-download"})],2)]),_:1}),l(x,null,{content:m(()=>[D(p(s(f).clearChat),1)]),default:m(()=>[c("span",{class:T(["question-icon",s(u)?"isPreventClick":""]),onClick:Qe},[l(v,{name:"chat-delete"})],2)]),_:1}),l(x,null,{content:m(()=>[D(p(s(f).modelSettingTitle),1)]),default:m(()=>[c("span",{class:"question-icon",onClick:t[1]||(t[1]=a=>Ge(!0))},[l(v,{name:"chat-setting"})])]),_:1}),l(o,{type:"primary",disabled:s(u),shape:"circle",onClick:X},{default:m(()=>[l(v,{name:"sendplane"})]),_:1},8,["disabled"])])])])])]))]),l(qt),l(ft,{content:s(H),"confirm-loading":s(Z),onOk:Je},null,8,["content","confirm-loading"]),l($t,{"dialog-type":1}),l(at,{theme:{token:{colorPrimary:"#5a47e5"}}},{default:m(()=>[l(ee,{class:"scroll-btn",type:"primary",onClick:K},{icon:m(()=>[l(v,{name:"scroll"})]),_:1})]),_:1})],64)}}}),Ha=we(La,[["__scopeId","data-v-afa467f1"]]);export{Ha as default};
