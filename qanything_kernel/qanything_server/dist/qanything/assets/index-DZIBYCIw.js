import{d as Ce,$ as tt,a as H,o as oe,A as n,B as i,c as l,G as a,W as v,X as w,C as c,J as d,r as D,N as we,z as B,O as Q,F as P,D as te,K as m,Q as st,a2 as se,R as C,E as x,H as T,T as I,U as M,a3 as at,S as ae,L as ot,M as nt}from"./index-BB04rY58.js";import{u as lt,b as ct,_ as it,a as rt}from"./useChatSource-2Dow4nHs.js";import{u as ut,a as dt,b as me,D as pt,f as ht,h as _t,T as ft,_ as vt}from"./html2canvas.esm-guWa6VPI.js";import{u as gt,_ as mt,C as kt}from"./HighLightMarkDown.vue_vue_type_style_index_0_lang-AC7oiOW5.js";import{g as yt,u as Ct}from"./index-BRx6CWe0.js";import{f as wt,p as bt,r as ne,u as le,a as St,b as xt,C as Tt}from"./utils-JpxPgV8N.js";import{u as ke}from"./useQuickStart-BN0pQb4j.js";import{L as Dt,a as ye,F as Lt,C as Ft,b as qt,O as $t}from"./OptionList-kcxsz6PA.js";import{u as Bt,a as It,p as Mt}from"./icon-loading-DB3eWrGB.js";import{B as Nt}from"./RightOutlined-DU9NHOkM.js";import"./slide-DYGLV4nk.js";import"./index-DvWVgLSr.js";import"./collapseMotion-CsiYUmAW.js";import"./index-B980c6KK.js";import"./index-B_pmgZfR.js";import"./injectionKey-DGYNie3Z.js";const Ut={class:"contain"},jt={key:0,class:"loading"},Ot={class:"file-info"},Rt={class:"file-name"},zt={key:0,class:"file-extension"},At={key:1,class:"file-extension"},Et=Ce({__name:"FileBlock",props:{fileData:{},kbId:{}},setup(N){const f=N,{fileData:k,kbId:J}=tt(f),r=H(()=>p.value!=="green"&&p.value!=="red");oe(()=>{console.log("00---fileData0",k.value)});const g=H(()=>bt(k.value.file_name)),y=H(()=>p.value!=="green"?"file-unknown":"file-"+W.get(g.value.fileExtension)),p=H(()=>k.value.status),W=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]),G=new Map([["gray","上传中"],["yellow","解析中"],["green","解析成功"],["red","上传失败"]]),O=()=>{let U=D(null);U.value=setInterval(async()=>{if(console.log("setinterval",k.value),k.value.status==="green"||k.value.status==="red")clearInterval(U.value),U.value=null;else{const R=await ne(await le.fileList({kb_id:J.value,file_id:k.value.file_id}));console.log(R),k.value.status=R.details[0].status}},5e3)};return oe(()=>{O()}),(U,R)=>(n(),i("div",Ut,[l(v,{name:a(y)},null,8,["name"]),a(r)?(n(),i("div",jt,[l(Dt)])):w("",!0),c("div",Ot,[c("span",Rt,d(a(g).fileName),1),a(p)==="green"?(n(),i("span",zt,d(a(g).fileExtension.toUpperCase())+", "+d(a(wt)(a(k).file.size)||0),1)):(n(),i("span",At,d(a(G).get(a(p))),1))])]))}}),Pt=we(Et,[["__scopeId","data-v-ff217fdc"]]),be=N=>(ot("data-v-d2e003d2"),N=N(),nt(),N),Ht={class:"container"},Kt={key:1,class:"my-page"},Vt={key:0,class:"user"},Qt=be(()=>c("img",{class:"avatar",src:rt,alt:"头像"},null,-1)),Jt={class:"question-text"},Wt={key:1,class:"ai"},Gt=be(()=>c("img",{class:"avatar",src:vt,alt:"头像"},null,-1)),Xt={class:"ai-content"},Yt={class:"ai-right"},Zt={key:1},es={key:0},ts={key:1},ss={key:0},as={key:0},os={key:1},ns={key:0},ls={class:"source-list"},cs={class:"control"},is={class:"tips"},rs=["href"],us=["onClick"],ds={class:"source-content"},ps=["innerHTML"],hs={class:"score"},_s={class:"tips"},fs={key:3,class:"feed-back"},vs=["onClick"],gs={class:"reload-text"},ms={class:"tools"},ks={key:0,class:"stop-btn"},ys={class:"question-box"},Cs={class:"question"},ws={key:0,class:"file-list-box"},bs={class:"send-box"},Ss={class:"send-action"},xs=Ce({__name:"index",setup(N){const{common:f,home:k}=yt(),{copy:J}=ut(),{QA_List:r,chatId:g,kbId:y,showLoading:p}=B(ke()),{addHistoryList:W,updateHistoryList:G,addChatList:O,clearChatList:U,getHistoryById:R,renameHistory:Se}=ke(),{setChatSourceVisible:ce,setSourceType:xe,setSourceUrl:ie,setTextContent:Te}=lt(),{chatSettingFormActive:_}=B(gt()),{showDefault:De}=B(Bt()),{setModalVisible:Le,setModalTitle:Fe}=It(),{uploadFileList:re}=B(ye()),{initUploadFileList:qe}=ye(),{language:ue}=B(Ct()),L=new ft(e=>{e&&(r.value[r.value.length-1].answer+=e||"")}),F=D(""),$e=H(()=>{const e=_.value.context;if(e===0)return[];const t=r.value.filter(u=>u.type==="ai");return(e===1?t:t.slice(-e)).map(u=>[u.question,u.answer])}),q=D([]);let b;const Be=D(null),de=D(null),j=()=>{se(()=>{var e;(e=de.value)==null||e.scrollIntoView({behavior:"smooth",block:"end"})})};oe(()=>{j()});const Ie=dt((e,t)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){t.target.parentNode.style.animation="shake ease-in .5s";const o=setTimeout(()=>{clearTimeout(o),t.target.parentNode.style.animation=""},600)}},800),Me=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},Ne=e=>{J(e.answer).then(()=>{e.copied=!e.copied,C.success(f.copySuccess,1);const t=setTimeout(()=>{clearTimeout(t),e.copied=!e.copied},1e3)}).catch(()=>{C.error(f.copyFailed,1)})},Ue=e=>{r.value.push({question:e,type:"user"}),j()},pe=e=>{r.value.push({answer:"",question:e,onlySearch:_.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},z=new Tt,je=()=>{b&&b.abort(),L.done(),p.value=!1,r.value[r.value.length-1].showTools=!0},Oe=async e=>{try{if(g.value!==null){R(g.value).title==="未命名对话"&&Se(g.value,e);return}e.length>100&&(e=e.substring(0,100));const t=await ne(await le.createKb({kb_name:e}));y.value=t.kb_id,g.value=W(e),G(e,g.value,y.value)}catch(t){C.error(t.msg||"创建对话失败")}},X=async()=>{if(!F.value.trim().length)return;if(p.value){C.warn("正在聊天中...请等待结束");return}if(!Ge()){C.error("模型设置错误，请先检查模型配置");return}qe();const e=F.value;await Oe(e),F.value="",Ue(e),O(g.value,r.value),p.value=!0,b=new AbortController,ht(xt+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:St,kb_ids:[y.value],history:$e.value,question:e,streaming:_.value.capabilities.onlySearch===!1,networking:_.value.capabilities.networkSearch,product_source:"saas",rerank:_.value.capabilities.rerank,only_need_search_results:_.value.capabilities.onlySearch,hybrid_search:_.value.capabilities.mixedSearch,max_token:_.value.maxToken,api_base:_.value.apiBase,api_key:_.value.apiKey,model:_.value.apiModelName,api_context_length:_.value.apiContextLength,top_p:_.value.top_P,temperature:_.value.temperature}),signal:b.signal,async onopen(t){console.log("eee",t),z.addChatSetting(_.value),t.ok&&t.headers.get("content-type")==="text/event-stream"?(pe(e),L.start()):t.headers.get("content-type")==="application/json"&&(console.log("ssss"),pe(e))},onmessage(t){var u;console.log("onmessage",t);const o=JSON.parse(t.data);if((o==null?void 0:o.code)==200&&(o!=null&&o.response)&&o.msg==="success")L.add(o==null?void 0:o.response),j();else{const S=o.time_record.time_usage;delete S.retriever_search_by_milvus,z.addTime(o.time_record.time_usage),z.addToken(o.time_record.token_usage),z.addDate(Date.now())}(u=o==null?void 0:o.source_documents)!=null&&u.length&&(r.value[r.value.length-1].source=o==null?void 0:o.source_documents)},onclose(){console.log("onclose"),L.done(),b.abort(),p.value=!1,r.value[r.value.length-1].showTools=!0,r.value.at(-1).itemInfo=z.getChatInfo(),O(g.value,r.value),se(()=>{j()})},onerror(t){throw console.log("onerror",t),L==null||L.done(),b==null||b.abort(),p.value=!1,r.value[r.value.length-1].showTools=!0,C.error(t.msg||"出错了"),O(g.value,r.value),se(()=>{j()}),t}})},Re=e=>{F.value=e.question,X()},ze=(e,t)=>{e.source[t].showDetailDataSource=!e.source[t].showDetailDataSource},Ae=(e,t)=>{e.source[t].showDetailDataSource=!1},Ee=e=>{q.value.push(e)},Pe=e=>{q.value=q.value.filter(t=>t!==e)},{showModal:Y}=B(me()),Z=D(!1),K=D(""),A=D(""),He=()=>{y.value&&(Le(!0),Fe(k.upload))},Ke=()=>{p.value||(A.value="download",Y.value=!0,K.value=f.saveTip)},Ve=()=>{p.value||(A.value="delete",Y.value=!0,K.value=f.clearTip)},Qe=async()=>{if(Z.value=!0,A.value==="download")try{const e=document.getElementById("chat-ul"),o=(await _t(e,{useCORS:!0})).toDataURL("image/png"),u=document.createElement("a");u.style.display="none",u.href=o,u.setAttribute("download","chat-shot.png"),typeof u.download>"u"&&u.setAttribute("target","_blank"),document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(o),C.success("下载成功"),await Promise.resolve()}catch(e){C.error(e.message||e.msg||"出错了")}else A.value==="delete"&&(U(g.value),g.value=null,r.value=[]);A.value="",K.value="",Z.value=!1,Y.value=!1},{showSettingModal:Je}=B(me()),We=e=>{Je.value=e},Ge=()=>!!(_.value.apiKey&&_.value.apiBase&&_.value.apiModelName);let he=["pdf","docx","xlsx","txt","jpg","png","jpeg"];const _e=e=>{if(!e)return!1;const t=e.split(".");if(t.length){const o=t.pop();return he.includes(o)}else return!1},Xe=e=>{_e(e.file_name)&&Ye(e)};async function Ye(e){try{ie(null);const t=await ne(await le.getFile({file_id:e.file_id})),o=e.file_name.split(".").pop(),u=et(o);if(xe(o),ie(`data:${u};base64,${t.base64_content}`),o==="txt"){const S=atob(t.base64_content),ee=decodeURIComponent(escape(S));Te(ee),ce(!0)}else ce(!0)}catch(t){C.error(t.msg||"获取文件失败")}}let Ze=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","image/jpeg","image/png","image/jpeg"];function et(e){const t=he.indexOf(e);return Ze[t]}return(e,t)=>{const o=Nt,u=ct,S=it,ee=Lt;return n(),i(P,null,[c("div",Ht,[a(De)===a(Mt).optionlist?(n(),Q($t,{key:0})):(n(),i("div",Kt,[c("div",{id:"chat",ref_key:"chatContainer",ref:Be,class:"chat"},[c("ul",{id:"chat-ul",ref_key:"scrollDom",ref:de},[(n(!0),i(P,null,te(a(r),(s,$)=>{var fe,ve,ge;return n(),i("li",{key:$},[s.type==="user"?(n(),i("div",Vt,[Qt,c("p",Jt,d(s.question),1)])):(n(),i("div",Wt,[Gt,c("div",Xt,[c("div",Yt,[s.onlySearch?s.onlySearch&&!s.source.length?(n(),i("p",{key:1,class:x(["question-text",[!s.source.length&&!((ge=s==null?void 0:s.picList)!=null&&ge.length)?"change-radius":"",s.showTools?"":"flashing"]])},[a(ue)==="zh"?(n(),i("span",es,"未找到信息来源")):(n(),i("span",ts,"Information source not found"))],2)):w("",!0):(n(),i("p",{key:0,class:x(["question-text",[!s.source.length&&!((fe=s==null?void 0:s.picList)!=null&&fe.length)?"change-radius":"",s.showTools?"":"flashing"]])},[s.answer?(n(),Q(mt,{key:0,content:s.answer},null,8,["content"])):(n(),i("span",Zt,d(s.answer),1)),Object.keys(((ve=s==null?void 0:s.itemInfo)==null?void 0:ve.tokenInfo)||{}).length?(n(),Q(kt,{key:2,"chat-item-info":s.itemInfo},null,8,["chat-item-info"])):w("",!0)],2)),s.source.length?(n(),i(P,{key:2},[c("div",{class:x(["source-total",a(q).includes($)?"":"source-total-last"])},[a(ue)==="zh"?(n(),i("span",ss,[s.onlySearch?(n(),i("span",as,"检索完成，")):w("",!0),T(" 找到了"+d(s.source.length)+"个信息来源： ",1)])):(n(),i("span",os,[s.onlySearch?(n(),i("span",ns,"Search completed，")):w("",!0),T(" Found "+d(s.source.length)+" source of information ",1)])),I(l(v,{name:"down",onClick:h=>Ee($)},null,8,["onClick"]),[[M,!a(q).includes($)]]),I(l(v,{name:"up",onClick:h=>Pe($)},null,8,["onClick"]),[[M,a(q).includes($)]])],2),I(c("div",ls,[(n(!0),i(P,null,te(s.source,(h,V)=>(n(),i("div",{key:V,class:"data-source"},[I(c("p",cs,[c("span",is,d(a(f).dataSource)+d(V+1)+":",1),h.file_id.startsWith("http")?(n(),i("a",{key:0,href:h.file_id,target:"_blank"},d(h.file_name),9,rs)):(n(),i("span",{key:1,class:x(["file",_e(h.file_name)?"filename-active":""]),onClick:E=>Xe(h)},d(h.file_name),11,us)),I(l(v,{name:"iconup",onClick:E=>Ae(s,V)},null,8,["onClick"]),[[M,h.showDetailDataSource]]),I(l(v,{name:"icondown",onClick:E=>ze(s,V)},null,8,["onClick"]),[[M,!h.showDetailDataSource]])],512),[[M,h.file_name]]),l(at,{name:"sourceItem"},{default:m(()=>{var E;return[I(c("div",ds,[c("p",{innerHTML:(E=h.content)==null?void 0:E.replaceAll(`
`,"<br/>")},null,8,ps),c("p",hs,[c("span",_s,d(a(f).correlation),1),T(d(h.score),1)])],512),[[M,h.showDetailDataSource]])]}),_:2},1024)]))),128))],512),[[M,a(q).includes($)]])],64)):w("",!0),s.showTools?(n(),i("div",fs,[c("div",{class:"reload-box",onClick:h=>Re(s)},[l(v,{name:"reload"}),c("span",gs,d(a(f).regenerate),1)],8,vs),c("div",ms,[l(v,{style:ae({color:s.copied?"#4D71FF":""}),name:"copy",onClick:h=>Ne(s)},null,8,["style","onClick"]),l(v,{style:ae({color:s.like?"#4D71FF":""}),name:"like",onClick:h=>a(Ie)(s,h)},null,8,["style","onClick"]),l(v,{style:ae({color:s.unlike?"#4D71FF":""}),name:"unlike",onClick:h=>Me(s)},null,8,["style","onClick"])])])):w("",!0)])])]))])}),128))],512)],512),a(p)?(n(),i("div",ks,[l(o,{onClick:je},{icon:m(()=>[l(v,{name:"stop",class:x(a(p)?"loading":"")},null,8,["class"])]),default:m(()=>[T(" "+d(a(f).stop),1)]),_:1})])):w("",!0),c("div",ys,[c("div",Cs,[a(re).length?(n(),i("div",ws,[(n(!0),i(P,null,te(a(re),s=>(n(),Q(Pt,{key:s.file.lastModified,"file-data":s,"kb-id":a(y)},null,8,["file-data","kb-id"]))),128))])):w("",!0),c("div",bs,[l(u,{value:a(F),"onUpdate:value":t[0]||(t[0]=s=>st(F)?F.value=s:null),class:"send-textarea","max-length":"200",bordered:!1,placeholder:a(f).problemPlaceholder,"auto-size":{minRows:4,maxRows:8},onPressEnter:X},null,8,["value","placeholder"]),c("div",Ss,[l(S,null,{content:m(()=>[T(d(a(y)?a(f).chatUpload:a(f).chatUploadNoKbId),1)]),default:m(()=>[c("span",{class:x(["question-icon",a(p)||!a(y)?"isPreventClick":""]),onClick:He},[l(v,{name:"chat-upload"})],2)]),_:1}),l(S,null,{content:m(()=>[T(d(a(f).chatToPic),1)]),default:m(()=>[c("span",{class:x(["question-icon",a(p)?"isPreventClick":""]),onClick:Ke},[l(v,{name:"chat-download"})],2)]),_:1}),l(S,null,{content:m(()=>[T(d(a(f).clearChat),1)]),default:m(()=>[c("span",{class:x(["question-icon",a(p)?"isPreventClick":""]),onClick:Ve},[l(v,{name:"chat-delete"})],2)]),_:1}),l(S,null,{content:m(()=>[T(d(a(f).modelSettingTitle),1)]),default:m(()=>[c("span",{class:"question-icon",onClick:t[1]||(t[1]=s=>We(!0))},[l(v,{name:"chat-setting"})])]),_:1}),l(o,{type:"primary",disabled:a(p),shape:"circle",onClick:X},{default:m(()=>[l(v,{name:"sendplane"})]),_:1},8,["disabled"])])])])])]))]),l(Ft),l(pt,{content:a(K),"confirm-loading":a(Z),onOk:Qe},null,8,["content","confirm-loading"]),l(qt,{"dialog-type":1}),l(ee,{class:"scroll-btn",type:"primary",onClick:j},{icon:m(()=>[l(v,{name:"scroll"})]),_:1})],64)}}}),Es=we(xs,[["__scopeId","data-v-d2e003d2"]]);export{Es as default};
