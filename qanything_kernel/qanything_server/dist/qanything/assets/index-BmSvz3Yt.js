import{d as Te,$ as it,a as N,o as De,A as r,B as u,C as i,c,G as s,W as f,X as T,J as v,r as w,N as Le,z as M,b as we,O as Z,F as z,D as ee,K as k,Q as ct,a2 as te,R as y,E as A,T as U,U as R,H as V,a3 as rt,S as ue,L as ut,M as dt}from"./index-DN1u8CS-.js";import{u as pt,b as ht,_ as vt,a as ft}from"./useChatSource-r2LI5y3q.js";import{u as _t,a as gt,b as Ce,D as mt,f as kt,h as yt,T as wt,_ as Ct}from"./html2canvas.esm-B_AKp7h9.js";import{_ as bt,C as St}from"./ChatInfoPanel-nsdNkpsJ.js";import{g as xt,u as Tt}from"./index-C1my0NQg.js";import{f as Dt,p as Lt,r as Q,u as J,a as Ft,b as Bt,C as qt}from"./utils-NKScgdcV.js";import{u as be}from"./useQuickStart-XO0UeurP.js";import{L as $t,C as It,F as Mt,O as Ut}from"./OptionList-BX5EaWvp.js";import{u as Rt,a as Nt,c as Se,p as Ot}from"./useUploadFiles-DwII61Ri.js";import{u as Kt}from"./useChatSetting-BvO1UlJA.js";import{B as jt}from"./RightOutlined-DGnljkAY.js";import"./slide-Bu74WQK8.js";import"./collapseMotion-CNJxd4-f.js";import"./index-BRdR9HiO.js";import"./index-DC3ZRfEI.js";import"./injectionKey-DGYNie3Z.js";const zt={class:"contain"},At={class:"file-icon"},Et={key:0,class:"loading"},Ht={class:"file-info"},Pt={class:"file-name"},Vt={key:0,class:"file-extension"},Qt={key:1,class:"file-extension"},Jt=Te({__name:"FileBlock",props:{fileData:{},kbId:{},status:{}},emits:["deleteFile"],setup(O,{emit:_}){const ae=_,se=O,{fileData:n,kbId:p}=it(se),m=N(()=>C.value!=="green"&&C.value!=="red"),D=N(()=>Lt(n.value.file_name)),g=N(()=>C.value==="red"?"file-error":C.value==="green"?"file-"+oe.get(D.value.fileExtension):"file-unknown"),C=N(()=>n.value.status),oe=new Map([["md","txt"],["txt","txt"],["pdf","pdf"],["jpg","img"],["png","img"],["jpeg","img"],["docx","docx"],["xlsx","xlsx"],["pptx","ppt"],["eml","eml"],["csv","xlsx"]]),K=new Map([["gray","上传中"],["yellow","解析中"],["green","解析成功"],["red","解析失败"]]),ne=()=>{let L=w(null);L.value=setInterval(async()=>{var E;if(n.value.file_id===""&&n.value.status!=="loading"&&(n.value.status="red"),n.value.status==="green"||n.value.status==="red")clearInterval(L.value),L.value=null;else{const H=await Q(await J.fileList({kb_id:p.value,file_id:n.value.file_id}));console.log(H),n.value.status=((E=H.details[0])==null?void 0:E.status)||"red"}},2e3)},W=async()=>{ae("deleteFile",n.value.file_id,p.value)};return De(()=>{ne()}),(L,E)=>(r(),u("div",zt,[i("div",At,[c(f,{name:s(g)},null,8,["name"]),s(m)?(r(),u("div",Et,[c($t)])):T("",!0)]),i("div",Ht,[i("span",Pt,v(s(D).fileName),1),s(C)==="green"?(r(),u("span",Vt,v(s(D).fileExtension.toUpperCase())+", "+v(s(Dt)(s(n).bytes)||0),1)):(r(),u("span",Qt,v(s(K).get(s(C))),1))]),L.status==="toBeSend"?(r(),u("div",{key:0,class:"file-close",onClick:W},[c(f,{name:"close"})])):T("",!0)]))}}),xe=Le(Jt,[["__scopeId","data-v-f1a2f795"]]),Fe=O=>(ut("data-v-93e92bce"),O=O(),dt(),O),Wt={class:"container"},Gt={key:1,class:"my-page"},Xt={key:0,class:"user"},Yt=Fe(()=>i("img",{class:"avatar",src:ft,alt:"头像"},null,-1)),Zt={class:"question-inner"},ea={class:"question-text"},ta={key:0,class:"file-list-box"},aa={key:1,class:"ai"},sa=Fe(()=>i("img",{class:"avatar",src:Ct,alt:"头像"},null,-1)),oa={class:"ai-content"},na={class:"ai-right"},la={key:0},ia={key:1},ca={class:"source-list"},ra={class:"control"},ua={class:"tips"},da=["href"],pa=["onClick"],ha={class:"source-content"},va=["innerHTML"],fa={class:"score"},_a={class:"tips"},ga={key:1,class:"feed-back"},ma=["onClick"],ka={class:"reload-text"},ya={class:"tools"},wa={key:0,class:"stop-btn"},Ca={class:"question-box"},ba={class:"question"},Sa={class:"scroll-btn-div"},xa={key:0,class:"file-list-box"},Ta={class:"send-box"},Da={class:"send-action"},La=Te({__name:"index",setup(O){const{common:_,home:ae}=xt(),{copy:se}=_t(),{QA_List:n,chatId:p,kbId:m,kbIdCopy:D,showLoading:g}=M(be()),{addHistoryList:C,updateHistoryList:oe,addChatList:K,clearChatList:ne,getHistoryById:W,renameHistory:L,addFileToBeSendList:E}=be(),{setChatSourceVisible:H,setSourceType:Be,setSourceUrl:de,setTextContent:qe}=pt(),{chatSettingFormActive:h}=M(Kt()),{showDefault:$e}=M(Rt()),{setModalVisible:Ie,setModalTitle:Me}=Nt(),{uploadFileListQuick:F}=M(Se()),{initUploadFileListQuick:pe}=Se(),{language:Ue}=M(Tt()),G=N(()=>W(p.value)),B=new wt(e=>{e&&(n.value[n.value.length-1].answer+=e||"")}),b=w(""),Re=N(()=>{const e=h.value.context;if(e===0)return[];const t=n.value.filter(o=>o.type==="ai");return(e===1?t:t.slice(-e)).map(o=>[o.question,o.answer])}),q=w([]);let S;const Ne=w(null),he=w(null),$=()=>{te(()=>{var e;(e=he.value)==null||e.scrollIntoView({behavior:"smooth",block:"end"})})},le=N(()=>{var t;return(((t=G.value)==null?void 0:t.fileToBeSendList.concat(F==null?void 0:F.value))||[]).filter(a=>a.file_id.length!==0)});De(()=>{D.value&&(m.value=D.value),$()}),we(()=>{F.value.length&&(E(p.value,[...F.value]),pe())});const Oe=e=>{e.keyCode===13&&(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey?b.value+=`
`:ie(),e.preventDefault())},Ke=gt((e,t)=>{if(e.like=!e.like,e.unlike=!1,_czc.push(["_trackEvent","qanything","问答页面","点赞","",""]),e.like){t.target.parentNode.style.animation="shake ease-in .5s";const a=setTimeout(()=>{clearTimeout(a),t.target.parentNode.style.animation=""},600)}},800),je=e=>{e.unlike=!e.unlike,e.like=!1,_czc.push(["_trackEvent","qanything","问答页面","点踩","",""])},ze=e=>{se(e.answer).then(()=>{e.copied=!e.copied,y.success(_.copySuccess,1);const t=setTimeout(()=>{clearTimeout(t),e.copied=!e.copied},1e3)}).catch(()=>{y.error(_.copyFailed,1)})},Ae=async(e,t)=>{console.log(e);try{await Q(await J.deleteFile({file_ids:[e],kb_id:t})),y.success("删除成功");const a=F.value.findIndex(o=>o.file_id===e);a!==-1?F.value.splice(a,1):G.value.fileToBeSendList=G.value.fileToBeSendList.filter(o=>o.file_id!==e)}catch(a){y.error(a.msg||"删除失败")}},Ee=e=>{n.value.push({question:e,type:"user",fileDataList:[...le.value]}),$()},ve=e=>{n.value.push({answer:"",question:e,onlySearch:h.value.capabilities.onlySearch,type:"ai",copied:!1,like:!1,unlike:!1,source:[],showTools:!1})},j=new qt,He=()=>{S&&S.abort(),B.done(),g.value=!1,n.value[n.value.length-1].showTools=!0},Pe=async e=>{try{if(p.value!==null){W(p.value).title==="未命名对话"&&L(p.value,e);return}e.length>100&&(e=e.substring(0,100));const t=await Q(await J.createKb({kb_name:e}));m.value=t.kb_id,p.value=C(e),oe(e,p.value,m.value)}catch(t){y.error(t.msg||"创建对话失败")}},ie=async()=>{if(!b.value.trim().length)return;if(g.value){y.warn("正在聊天中...请等待结束");return}if(!await at()){y.error("模型设置错误，请先检查模型配置");return}const e=b.value;await Pe(e),b.value="",Ee(e),K(p.value,n.value),pe(),G.value.fileToBeSendList=[],g.value=!0,S=new AbortController;const t={kb_ids:[m.value],history:Re.value,question:e,streaming:h.value.capabilities.onlySearch===!1,networking:h.value.capabilities.networkSearch,product_source:"saas",rerank:h.value.capabilities.rerank,only_need_search_results:h.value.capabilities.onlySearch,hybrid_search:h.value.capabilities.mixedSearch,max_token:h.value.maxToken,api_base:h.value.apiBase,api_key:h.value.apiKey,model:h.value.apiModelName,api_context_length:h.value.apiContextLength,chunk_size:h.value.chunkSize,top_p:h.value.top_P,temperature:h.value.temperature};if(h.value.capabilities.onlySearch){j.addChatSetting(h.value),ve(e);const a=await Q(await J.sendQuestion(t));a.code===200&&(n.value[n.value.length-1].answer=a!=null&&a.source_documents.length?"检索完成":"未找到信息来源",n.value[n.value.length-1].source=a==null?void 0:a.source_documents),g.value=!1,n.value[n.value.length-1].showTools=!0,K(p.value,n.value),await te(()=>{$()})}else console.log("thisthisthis"),kt(Bt+"/local_doc_qa/local_doc_chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:["text/event-stream","application/json"]},openWhenHidden:!0,body:JSON.stringify({user_id:Ft,...t}),signal:S.signal,onopen(a){console.log("open",a),j.addChatSetting(h.value),ve(e),a.ok&&a.headers.get("content-type")==="text/event-stream"&&B.start()},onmessage(a){var x;console.log("message",a);const o=JSON.parse(a.data);if((o==null?void 0:o.code)==200&&(o!=null&&o.response)&&o.msg==="success")B.add(o==null?void 0:o.response),$();else{const l=o.time_record.time_usage;delete l.retriever_search_by_milvus,j.addTime(o.time_record.time_usage),j.addToken(o.time_record.token_usage),j.addDate(Date.now())}(x=o==null?void 0:o.source_documents)!=null&&x.length&&(n.value[n.value.length-1].source=o==null?void 0:o.source_documents)},onclose(a){console.log("close",a),B.done(),S.abort(),g.value=!1,n.value[n.value.length-1].showTools=!0,n.value.at(-1).itemInfo=j.getChatInfo(),K(p.value,n.value),te(()=>{$()}),console.log(n.value)},onerror(a){throw console.log("error",a),B==null||B.done(),S==null||S.abort(),g.value=!1,n.value[n.value.length-1].showTools=!0,y.error(a.msg||"出错了"),K(p.value,n.value),te(()=>{$()}),a}})},Ve=e=>{b.value=e.question,ie()},Qe=(e,t)=>{e.source[t].showDetailDataSource=!e.source[t].showDetailDataSource},Je=(e,t)=>{e.source[t].showDetailDataSource=!1},We=e=>{q.value.push(e)},Ge=e=>{q.value=q.value.filter(t=>t!==e)},{showModal:fe}=M(Ce()),ce=w(!1),re=w(""),X=w(""),Xe=()=>{m.value&&(Ie(!0),Me(ae.upload))},Ye=()=>{g.value||(X.value="download",fe.value=!0,re.value=_.saveTip)},Ze=async()=>{if(ce.value=!0,X.value==="download")try{const e=document.getElementById("chat-ul"),a=(await yt(e,{useCORS:!0})).toDataURL("image/png"),o=document.createElement("a");o.style.display="none",o.href=a,o.setAttribute("download","chat-shot.png"),typeof o.download>"u"&&o.setAttribute("target","_blank"),document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(a),y.success("下载成功"),await Promise.resolve()}catch(e){y.error(e.message||e.msg||"出错了")}else X.value==="delete"&&(ne(p.value),p.value=null,n.value=[]);X.value="",re.value="",ce.value=!1,fe.value=!1},{showSettingModal:et}=M(Ce()),tt=e=>{et.value=e},_e=w(),at=()=>_e.value.handleOk();let ge=["pdf","docx","xlsx","txt","jpg","png","jpeg"];const me=e=>{if(!e)return!1;const t=e.split(".");if(t.length){const a=t.pop();return ge.includes(a)}else return!1},st=e=>{me(e.file_name)&&ot(e)};async function ot(e){try{de(null);const t=await Q(await J.getFile({file_id:e.file_id})),a=e.file_name.split(".").pop(),o=lt(a);if(Be(a),de(`data:${o};base64,${t.base64_content}`),a==="txt"){const x=atob(t.base64_content),l=decodeURIComponent(escape(x));qe(l),H(!0)}else H(!0)}catch(t){y.error(t.msg||"获取文件失败")}}let nt=["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","image/jpeg","image/png","image/jpeg"];function lt(e){const t=ge.indexOf(e);return nt[t]}return we(()=>{D.value=m.value,m.value=""}),(e,t)=>{const a=jt,o=ht,x=vt;return r(),u(z,null,[i("div",Wt,[s($e)===s(Ot).optionlist?(r(),Z(Ut,{key:0})):(r(),u("div",Gt,[i("div",{id:"chat",ref_key:"chatContainer",ref:Ne,class:"chat"},[i("ul",{id:"chat-ul",ref_key:"scrollDom",ref:he},[(r(!0),u(z,null,ee(s(n),(l,I)=>{var ke,ye;return r(),u("li",{key:I},[l.type==="user"?(r(),u("div",Xt,[Yt,i("div",Zt,[i("p",ea,v(l.question),1),l.fileDataList.length?(r(),u("div",ta,[(r(!0),u(z,null,ee(l.fileDataList,d=>(r(),Z(xe,{key:d.file.lastModified,"file-data":d,"kb-id":s(m),"chat-id":s(p),status:"send"},null,8,["file-data","kb-id","chat-id"]))),128))])):T("",!0)])])):(r(),u("div",aa,[sa,i("div",oa,[i("div",na,[i("p",{class:A(["question-text",[!l.source.length&&!((ke=l==null?void 0:l.picList)!=null&&ke.length)?"change-radius":"",l.showTools?"":"flashing"]])},[c(bt,{content:l.answer},null,8,["content"]),Object.keys(((ye=l==null?void 0:l.itemInfo)==null?void 0:ye.tokenInfo)||{}).length?(r(),Z(St,{key:0,"chat-item-info":l.itemInfo},null,8,["chat-item-info"])):T("",!0)],2),l.source.length?(r(),u(z,{key:0},[i("div",{class:A(["source-total",s(q).includes(I)?"":"source-total-last"])},[s(Ue)==="zh"?(r(),u("span",la," 找到了"+v(l.source.length)+"个信息来源： ",1)):(r(),u("span",ia," Found "+v(l.source.length)+" source of information ",1)),U(c(f,{name:"down",onClick:d=>We(I)},null,8,["onClick"]),[[R,!s(q).includes(I)]]),U(c(f,{name:"up",onClick:d=>Ge(I)},null,8,["onClick"]),[[R,s(q).includes(I)]])],2),U(i("div",ca,[(r(!0),u(z,null,ee(l.source,(d,Y)=>(r(),u("div",{key:Y,class:"data-source"},[U(i("p",ra,[i("span",ua,v(s(_).dataSource)+v(Y+1)+":",1),d.file_id.startsWith("http")?(r(),u("a",{key:0,href:d.file_id,target:"_blank"},v(d.file_name),9,da)):(r(),u("span",{key:1,class:A(["file",me(d.file_name)?"filename-active":""]),onClick:P=>st(d)},v(d.file_name),11,pa)),U(c(f,{name:"iconup",onClick:P=>Je(l,Y)},null,8,["onClick"]),[[R,d.showDetailDataSource]]),U(c(f,{name:"icondown",onClick:P=>Qe(l,Y)},null,8,["onClick"]),[[R,!d.showDetailDataSource]])],512),[[R,d.file_name]]),c(rt,{name:"sourceItem"},{default:k(()=>{var P;return[U(i("div",ha,[i("p",{innerHTML:(P=d.content)==null?void 0:P.replaceAll(`
`,"<br/>")},null,8,va),i("p",fa,[i("span",_a,v(s(_).correlation),1),V(v(d.score),1)])],512),[[R,d.showDetailDataSource]])]}),_:2},1024)]))),128))],512),[[R,s(q).includes(I)]])],64)):T("",!0),l.showTools?(r(),u("div",ga,[i("div",{class:"reload-box",onClick:d=>Ve(l)},[c(f,{name:"reload"}),i("span",ka,v(s(_).regenerate),1)],8,ma),i("div",ya,[c(f,{style:ue({color:l.copied?"#4D71FF":""}),name:"copy",onClick:d=>ze(l)},null,8,["style","onClick"]),c(f,{style:ue({color:l.like?"#4D71FF":""}),name:"like",onClick:d=>s(Ke)(l,d)},null,8,["style","onClick"]),c(f,{style:ue({color:l.unlike?"#4D71FF":""}),name:"unlike",onClick:d=>je(l)},null,8,["style","onClick"])])])):T("",!0)])])]))])}),128))],512)],512),s(g)?(r(),u("div",wa,[c(a,{onClick:He},{icon:k(()=>[c(f,{name:"stop",class:A(s(g)?"loading":"")},null,8,["class"])]),default:k(()=>[V(" "+v(s(_).stop),1)]),_:1})])):T("",!0),i("div",Ca,[i("div",ba,[i("div",Sa,[c(a,{type:"primary",shape:"circle",size:"large",onClick:$},{icon:k(()=>[c(f,{name:"scroll"})]),_:1})]),s(le).length?(r(),u("div",xa,[(r(!0),u(z,null,ee(s(le),l=>(r(),Z(xe,{key:l.file_id,"file-data":l,"kb-id":s(m),"chat-id":s(p),status:"toBeSend",onDeleteFile:Ae},null,8,["file-data","kb-id","chat-id"]))),128))])):T("",!0),i("div",Ta,[c(o,{value:s(b),"onUpdate:value":t[0]||(t[0]=l=>ct(b)?b.value=l:null),class:"send-textarea","max-length":"200",bordered:!1,placeholder:s(_).problemPlaceholder,"auto-size":{minRows:4,maxRows:8},onKeydown:Oe},null,8,["value","placeholder"]),i("div",Da,[c(x,null,{content:k(()=>[V(v(s(m)?s(_).chatUpload:s(_).chatUploadNoKbId),1)]),default:k(()=>[i("span",{class:A(["question-icon",s(g)||!s(m)?"isPreventClick":""]),onClick:Xe},[c(f,{name:"chat-upload"})],2)]),_:1}),c(x,null,{content:k(()=>[V(v(s(_).chatToPic),1)]),default:k(()=>[i("span",{class:A(["question-icon",s(g)?"isPreventClick":""]),onClick:Ye},[c(f,{name:"chat-download"})],2)]),_:1}),c(x,null,{content:k(()=>[V(v(s(_).modelSettingTitle),1)]),default:k(()=>[i("span",{class:"question-icon",onClick:t[1]||(t[1]=l=>tt(!0))},[c(f,{name:"chat-setting"})])]),_:1}),c(a,{type:"primary",disabled:s(g),shape:"circle",onClick:ie},{default:k(()=>[c(f,{name:"sendplane"})]),_:1},8,["disabled"])])])])])]))]),c(It,{ref_key:"chatSettingForDialogRef",ref:_e},null,512),c(mt,{content:s(re),"confirm-loading":s(ce),onOk:Ze},null,8,["content","confirm-loading"]),c(Mt,{"dialog-type":1})],64)}}}),Pa=Le(La,[["__scopeId","data-v-93e92bce"]]);export{Pa as default};
